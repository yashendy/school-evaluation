<!-- evaluations.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase compat (Ù†ÙØ³ Ø¥ØµØ¯Ø§Ø±Ùƒ) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>

  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ -->
  <script src="firebase-config.js"></script>

  <style>
    body { margin:0; font-family:'Segoe UI', Tahoma, sans-serif; background:#f4f6fa; }
    .container { max-width:1000px; margin:40px auto; padding:20px; background:#fff; box-shadow:0 0 10px #d0d4da; border-radius:12px; }
    h1 { text-align:center; color:#0288d1; margin:6px 0 18px; }
    label { display:block; margin-top:12px; color:#333; }
    select,button { width:100%; padding:10px; font-size:16px; margin-top:6px; }
    .actions { display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; margin-top:12px; }
    .btn { border:none; border-radius:8px; cursor:pointer; }
    .btn-primary { background:#0288d1; color:#fff; }
    .btn-secondary { background:#455a64; color:#fff; }
    .btn-outline { background:#fff; color:#0288d1; border:2px solid #0288d1; }
    table { width:100%; border-collapse:collapse; margin-top:16px; }
    th,td { border:1px solid #cfd8dc; padding:8px; text-align:center; font-size:14px; }
    th { background:#eceff1; }
    .muted { color:#666; font-size:13px; text-align:center; margin-top:6px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨</h1>

    <label>ğŸ“˜ Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„:</label>
    <select id="class-select"></select>

    <label>ğŸ“… Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</label>
    <select id="month-select">
      <option>ÙŠÙ†Ø§ÙŠØ±</option><option>ÙØ¨Ø±Ø§ÙŠØ±</option><option>Ù…Ø§Ø±Ø³</option><option>Ø£Ø¨Ø±ÙŠÙ„</option>
      <option>Ù…Ø§ÙŠÙˆ</option><option>ÙŠÙˆÙ†ÙŠÙˆ</option><option>ÙŠÙˆÙ„ÙŠÙˆ</option><option>Ø£ØºØ³Ø·Ø³</option>
      <option>Ø³Ø¨ØªÙ…Ø¨Ø±</option><option>Ø£ÙƒØªÙˆØ¨Ø±</option><option>Ù†ÙˆÙÙ…Ø¨Ø±</option><option>Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
    </select>

    <div class="actions">
      <button id="search-btn" class="btn btn-primary">ğŸ” Ø¨Ø­Ø« (Ø¹Ø±Ø¶ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„)</button>
      <button id="pdf-filled-btn" class="btn btn-secondary">ğŸ–¨ï¸ PDF Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
      <button id="pdf-blank-btn" class="btn btn-outline">ğŸ“ PDF ÙØ§Ø±Øº Ù„Ù„ØªØ¹Ø¨Ø¦Ø©</button>
    </div>

    <div class="muted">ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„ ÙÙ‚Ø·. Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ØªÙØ¬Ù„Ø¨ Ù„Ø´Ù‡Ø± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¥Ù† ÙˆÙØ¬Ø¯Øª.</div>

    <table id="results-table" style="display:none">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
          <th>Ø§Ø®ØªØ¨Ø§Ø±</th>
          <th>ÙˆØ§Ø¬Ø¨</th>
          <th>Ù…Ø´Ø§Ø±ÙƒØ©</th>
          <th>Ø³Ù„ÙˆÙƒ</th>
          <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
          <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
        </tr>
      </thead>
      <tbody id="results-body"></tbody>
    </table>
  </div>

  <script>
    // ===== Firebase =====
    const auth = firebase.auth();
    const db   = firebase.firestore();

    let currentTeacherId = null;
    let cachedRows = []; // Ø¢Ø®Ø± Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙˆÙ„ (Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø·Ø¨Ø§Ø¹Ø© PDF Ø§Ù„Ù†ØªØ§Ø¦Ø¬)

    // ===== Auth guard + ØªØ­Ù…ÙŠÙ„ ÙØµÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… =====
    auth.onAuthStateChanged(async user => {
      if (!user) return location.href = 'index.html';
      currentTeacherId = user.uid;

      const doc = await db.collection('users').doc(currentTeacherId).get();
      const data = doc.data();
      if (!data || data.type !== 'teacher') {
        alert('â— Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
        await auth.signOut();
        return (location.href = 'index.html');
      }
      loadTeacherClasses();
    });

    async function loadTeacherClasses() {
      const sel = document.getElementById('class-select');
      sel.innerHTML = '';
      const snap = await db.collection('classes')
        .where('teacher','==',currentTeacherId)
        .get();

      if (snap.empty) {
        sel.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ Ù…Ø³Ù†Ø¯Ø©</option>';
        return;
      }
      snap.forEach(d => {
        const c = d.data();
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = `${c.grade} - ${c.system} - ${c.section}`;
        sel.appendChild(opt);
      });
    }

    // ===== Helpers =====
    function arabicEval(e) {
      if (!e || e.test === undefined || e.test === null) return '';
      if (e.test === 0) return 'ØºÙŠØ§Ø¨';
      if (e.test < 7)  return 'ØªØ´Ø¬ÙŠØ¹ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±';
      if (e.total === 40) return 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±';
      if (e.total >= 36)  return 'Ù…Ù…ØªØ§Ø²';
      return 'Ù†Ø±Ø¬Ùˆ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ´Ø¬ÙŠØ¹Ù‡';
    }

    async function fetchLogoAsDataURL(src = 'logo.png') {
      try {
        const res = await fetch(src);
        const blob = await res.blob();
        return await new Promise(resolve => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(blob);
        });
      } catch {
        return null;
      }
    }

    // ===== Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø§Ø¨ + Ø¯Ù…Ø¬ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª =====
    async function searchAndRender() {
      const classId = document.getElementById('class-select').value;
      const month   = document.getElementById('month-select').value;

      if (!classId || !month) return alert('âš ï¸ Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø´Ù‡Ø±');

      const tbody = document.getElementById('results-body');
      const table = document.getElementById('results-table');
      tbody.innerHTML = '<tr><td colspan="7">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
      table.style.display = 'table';

      // 1) Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„
      const studentsSnap = await db.collection('students')
        .where('classId','==', classId)
        .orderBy('name')
        .get();

      // 2) ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
      const evalSnap = await db.collection('evaluations')
        .where('teacher','==', currentTeacherId)
        .where('classId','==', classId)
        .where('month','==', month)
        .get();

      // Ù†Ø¹Ù…Ù„ Ø®Ø±ÙŠØ·Ø© Ù„Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø¨Ø§Ù„studentId Ø£Ùˆ Ø¨Ø§Ù„Ø§Ø³Ù… ÙƒØ¨Ø¯ÙŠÙ„
      const evalMap = new Map();
      evalSnap.forEach(d => {
        const e = d.data();
        const key = e.studentId || (e.name || '').trim();
        evalMap.set(key, e);
      });

      // Ø¨Ù†Ø§Ø¡ Ø§Ù„ØµÙÙˆÙ
      const rows = [];
      tbody.innerHTML = '';
      if (studentsSnap.empty) {
        tbody.innerHTML = '<tr><td colspan="7">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„</td></tr>';
        cachedRows = [];
        return;
      }

      studentsSnap.forEach(s => {
        const st = s.data();
        const key = s.id;
        // Ø§Ù‚Ø±Ø£ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¥Ù† ÙˆÙØ¬Ø¯ (Ø£ÙˆÙ„ÙˆÙŠØ© studentId Ø«Ù… Ø§Ù„Ø§Ø³Ù…)
        let e = evalMap.get(key);
        if (!e) e = evalMap.get((st.name || '').trim());

        const row = {
          name: st.name || '',
          test: e ? e.test : '',
          home: e ? e.home : '',
          part: e ? e.part : '',
          beh:  e ? e.beh  : '',
          total: e ? e.total : '',
          grade: e ? arabicEval(e) : ''
        };
        rows.push(row);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${row.name}</td>
          <td>${row.test === 0 ? '-' : row.test}</td>
          <td>${row.test === 0 ? '-' : row.home}</td>
          <td>${row.test === 0 ? '-' : row.part}</td>
          <td>${row.test === 0 ? '-' : row.beh}</td>
          <td>${row.test === 0 ? '-' : row.total}</td>
          <td>${row.grade}</td>
        `;
        tbody.appendChild(tr);
      });

      cachedRows = rows; // Ù†Ø®Ø²Ù†Ù‡Ø§ Ù„Ù„Ù€ PDF Ø§Ù„Ù†ØªØ§Ø¦Ø¬
    }

    // ===== Ø±Ø£Ø³ PDF (Ø´Ø¹Ø§Ø± ÙŠÙ…ÙŠÙ† + Ø§Ø³Ù… Ø§Ù„Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© ÙˆØ³Ø· + Ø§Ù„Ø³Ù†Ø©) =====
    async function drawHeader(pdf, { titleCenter, yearText }) {
      const pageW = pdf.internal.pageSize.getWidth();
      // Ø´Ø¹Ø§Ø±
      const logo = await fetchLogoAsDataURL('logo.png');
      if (logo) {
        pdf.addImage(logo, 'PNG', pageW - 40 - 70, 30, 70, 70); // ÙŠÙ…ÙŠÙ† Ø£Ø¹Ù„Ù‰
      }
      // Ø¹Ù†ÙˆØ§Ù†
      pdf.setFont('helvetica', 'bold'); pdf.setFontSize(16);
      pdf.text(titleCenter, pageW/2, 60, { align:'center' });
      // Ø§Ù„Ø³Ù†Ø©
      pdf.setFont('helvetica', 'normal'); pdf.setFontSize(12);
      pdf.text(yearText, pageW/2, 80, { align:'center' });

      // Ø®Ø· ÙØ§ØµÙ„
      pdf.setDrawColor(180);
      pdf.line(40, 100, pageW - 40, 100);
    }

    // ===== PDF: Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ =====
    async function exportFilledPDF() {
      if (!cachedRows.length) return alert('Ø§Ø¹Ù…Ù„ Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„');

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:'pt', format:'a4' });
      const pageW = pdf.internal.pageSize.getWidth();
      const year  = new Date().getFullYear();
      const month = document.getElementById('month-select').value;

      await drawHeader(pdf, {
        titleCenter: 'Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„ÙÙ†ÙŠØ©',
        yearText: `Ø§Ù„Ø³Ù†Ø©: ${year}`
      });

      // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© ØµØºÙŠØ±Ø©
      pdf.setFontSize(11);
      const classText = document.getElementById('class-select').selectedOptions[0]?.textContent || '';
      pdf.text(`Ø§Ù„ÙØµÙ„: ${classText}`, 40, 118);
      pdf.text(`Ø§Ù„Ø´Ù‡Ø±: ${month}`, 40, 136);

      // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
      let y = 160;
      const cols = [
        { title:'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', x:40 },
        { title:'Ø§Ø®ØªØ¨Ø§Ø±',     x:250 },
        { title:'ÙˆØ§Ø¬Ø¨',       x:300 },
        { title:'Ù…Ø´Ø§Ø±ÙƒØ©',     x:350 },
        { title:'Ø³Ù„ÙˆÙƒ',       x:410 },
        { title:'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',    x:460 },
        { title:'Ø§Ù„ØªÙ‚Ø¯ÙŠØ±',    x:520 }
      ];
      pdf.setFontSize(11);
      cols.forEach(c => pdf.text(c.title, c.x, y));
      y += 10; pdf.line(40, y, pageW - 40, y); y += 16;

      // ØµÙÙˆÙ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      cachedRows.forEach(r => {
        const absent = r.test === 0;
        pdf.text(String(r.name || ''), 40, y);
        pdf.text(absent ? '-' : String(r.test ?? ''), 250, y);
        pdf.text(absent ? '-' : String(r.home ?? ''), 300, y);
        pdf.text(absent ? '-' : String(r.part ?? ''), 350, y);
        pdf.text(absent ? '-' : String(r.beh  ?? ''), 410, y);
        pdf.text(absent ? '-' : String(r.total?? ''), 460, y);
        pdf.text(String(r.grade || ''), 520, y);

        y += 18;
        if (y > 790) { pdf.addPage(); y = 60; }
      });

      pdf.save(`Ù†ØªÙŠØ¬Ø©_${classText}_${month}_${year}.pdf`);
    }

    // ===== PDF: ÙƒØ´Ù ÙØ§Ø±Øº Ù„Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ© =====
    async function exportBlankPDF() {
      const classId = document.getElementById('class-select').value;
      if (!classId) return alert('Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹');

      // Ù†Ø¶Ù…Ù† Ø¹Ù†Ø¯Ù†Ø§ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø§ Ø¶ØºØ·Ø´ Ø¨Ø­Ø«)
      if (!cachedRows.length) await searchAndRender();
      if (!cachedRows.length) return;

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:'pt', format:'a4' });
      const pageW = pdf.internal.pageSize.getWidth();
      const year  = new Date().getFullYear();

      await drawHeader(pdf, {
        titleCenter: 'Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„ÙÙ†ÙŠØ©',
        yearText: `Ø§Ù„Ø³Ù†Ø©: ${year}`
      });

      const classText = document.getElementById('class-select').selectedOptions[0]?.textContent || '';
      pdf.setFontSize(11);
      pdf.text(`Ø§Ù„ÙØµÙ„: ${classText} â€” ÙƒØ´Ù Ø¯Ø±Ø¬Ø§Øª (ÙØ§Ø±Øº Ù„Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙŠØ¯ÙˆÙŠØ©)`, 40, 118);

      // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (Ù†ÙØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ù„ÙƒÙ† Ø¨Ø¯ÙˆÙ† ØªÙ‚ÙŠÙŠÙ… Ù…Ø³Ø¨Ù‚)
      let y = 150;
      const cols = [
        { title:'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', x:40 },
        { title:'Ø§Ø®ØªØ¨Ø§Ø±',     x:250 },
        { title:'ÙˆØ§Ø¬Ø¨',       x:300 },
        { title:'Ù…Ø´Ø§Ø±ÙƒØ©',     x:350 },
        { title:'Ø³Ù„ÙˆÙƒ',       x:410 },
        { title:'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',    x:460 },
        { title:'Ø§Ù„ØªÙ‚Ø¯ÙŠØ±',    x:520 }
      ];
      pdf.setFontSize(11);
      cols.forEach(c => pdf.text(c.title, c.x, y));
      y += 10; pdf.line(40, y, pageW - 40, y); y += 16;

      // Ø§Ù„ØµÙÙˆÙ: Ø£Ø³Ù…Ø§Ø¡ ÙÙ‚Ø· ÙˆØ§Ù„Ø¨Ø§Ù‚ÙŠ ÙØ§Ø¶ÙŠ
      cachedRows.forEach(r => {
        pdf.text(String(r.name || ''), 40, y);
        // Ø®Ø§Ù†Ø§Øª ÙØ§Ø¶ÙŠØ© Ù…Ø¹ Ø®Ø·ÙˆØ· Ø®ÙÙŠÙØ© Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ÙƒØªØ§Ø¨Ø©
        const xs = [240, 290, 340, 400, 450, 510];
        xs.forEach(x => { pdf.line(x, y+4, x+40, y+4); }); // Ø³Ø·Ø± ØµØºÙŠØ± Ù„Ù„ÙƒØªØ§Ø¨Ø©
        y += 18;
        if (y > 790) { pdf.addPage(); y = 60; }
      });

      pdf.save(`ÙƒØ´Ù_ÙØ§Ø±Øº_${classText}_${year}.pdf`);
    }

    // ===== events =====
    document.getElementById('search-btn').addEventListener('click', searchAndRender);
    document.getElementById('pdf-filled-btn').addEventListener('click', exportFilledPDF);
    document.getElementById('pdf-blank-btn').addEventListener('click', exportBlankPDF);
  </script>
</body>
</html>
