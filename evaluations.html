<!-- evaluations.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“ ØµÙØ­Ø© ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>

  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ -->
  <script src="firebase-config.js"></script>

  <style>
    body { margin:0; font-family:'Segoe UI', Tahoma, sans-serif; background:#f4f6fa; }
    .container { max-width:900px; margin:40px auto; padding:20px; background:#fff; box-shadow:0 0 10px #d0d4da; border-radius:10px; }
    h1 { text-align:center; color:#0288d1; margin:10px 0 20px; }
    label { display:block; margin-top:12px; color:#333; }
    select,button { width:100%; padding:10px; font-size:16px; margin-top:6px; }
    .btn-primary { background:#0288d1; color:#fff; border:none; border-radius:6px; cursor:pointer; }
    .hint { color:#555; font-size:14px; text-align:center; margin-top:8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨</h1>

    <label>ğŸ“˜ Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„:</label>
    <select id="class-select"></select>

    <label>ğŸ“… Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</label>
    <select id="month-select">
      <option>ÙŠÙ†Ø§ÙŠØ±</option><option>ÙØ¨Ø±Ø§ÙŠØ±</option><option>Ù…Ø§Ø±Ø³</option><option>Ø£Ø¨Ø±ÙŠÙ„</option>
      <option>Ù…Ø§ÙŠÙˆ</option><option>ÙŠÙˆÙ†ÙŠÙˆ</option><option>ÙŠÙˆÙ„ÙŠÙˆ</option><option>Ø£ØºØ³Ø·Ø³</option>
      <option>Ø³Ø¨ØªÙ…Ø¨Ø±</option><option>Ø£ÙƒØªÙˆØ¨Ø±</option><option>Ù†ÙˆÙÙ…Ø¨Ø±</option><option>Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
    </select>

    <button id="view-btn" class="btn-primary">ğŸ–¨ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© (PDF)</button>
    <div class="hint">Ø³ÙŠØªÙ… ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± PDF Ù…Ø¨Ø§Ø´Ø±Ø©.</div>
  </div>

  <script>
    // ========== Firebase refs ==========
    const auth = firebase.auth();
    const db   = firebase.firestore();
    let currentTeacherId = null;

    // ========== Auth guard & load classes ==========
    auth.onAuthStateChanged(async (user) => {
      if (!user) return location.href = 'index.html';
      currentTeacherId = user.uid;

      const uDoc = await db.collection('users').doc(currentTeacherId).get();
      const uData = uDoc.data();
      if (!uData || uData.type !== 'teacher') {
        alert('â— Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
        await auth.signOut();
        return (location.href = 'index.html');
      }
      loadTeacherClasses();
    });

    async function loadTeacherClasses() {
      const sel = document.getElementById('class-select');
      sel.innerHTML = '';
      const snap = await db.collection('classes')
        .where('teacher','==',currentTeacherId)
        .get();

      if (snap.empty) {
        sel.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„</option>';
        return;
      }

      snap.forEach(d => {
        const c = d.data();
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = `${c.grade} - ${c.system} - ${c.section}`;
        sel.appendChild(opt);
      });
    }

    // ========== Helpers ==========
    function arabicGrade(e) {
      if (e.test === 0) return 'ØºÙŠØ§Ø¨';
      if (e.test < 7)  return 'ØªØ´Ø¬ÙŠØ¹ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±';
      if (e.total === 40) return 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±';
      if (e.total >= 36)  return 'Ù…Ù…ØªØ§Ø²';
      return 'Ù†Ø±Ø¬Ùˆ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ´Ø¬ÙŠØ¹Ù‡';
    }

    async function fetchLogoAsDataURL(src = 'logo.png') {
      // ÙŠØ­ÙˆÙ‘Ù„ ØµÙˆØ±Ø© Ø§Ù„Ø´Ø¹Ø§Ø± Ø¥Ù„Ù‰ DataURL Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ PDF
      const res = await fetch(src);
      const blob = await res.blob();
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(blob);
      });
    }

    // ========== Generate PDF (main) ==========
    async function generatePDF() {
      const classId = document.getElementById('class-select').value;
      const month   = document.getElementById('month-select').value;
      const year    = new Date().getFullYear();

      if (!classId || !month) return alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø´Ù‡Ø±');

      // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØµÙ„ + Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
      const cDoc = await db.collection('classes').doc(classId).get();
      const cData = cDoc.data();
      const className = `Ø§Ù„ØµÙ ${cData.grade} ${cData.system} ${cData.section}`;

      const evalSnap = await db.collection('evaluations')
        .where('teacher','==', currentTeacherId)
        .where('classId','==', classId)
        .where('month','==', month)
        .get();

      if (evalSnap.empty) return alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±');

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit: 'pt', format: 'a4' });

      const pageW = pdf.internal.pageSize.getWidth();
      let y = 40;

      // Ø§Ù„Ø´Ø¹Ø§Ø± Ø£Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ†
      try {
        const logoDataURL = await fetchLogoAsDataURL('logo.png');
        // Ø¹Ø±Ø¶ 70px ØªÙ‚Ø±ÙŠØ¨Ø§ØŒ ÙˆØ§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø©
        pdf.addImage(logoDataURL, 'PNG', pageW - 40 - 70, 30, 70, 70);
      } catch (e) {
        // Ù„Ùˆ Ø§Ù„ØµÙˆØ±Ø© Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ Ù†ÙƒÙ…Ù‘Ù„ Ù…Ù† ØºÙŠØ±Ù‡Ø§
        console.warn('Logo not found, skippingâ€¦');
      }

      // Ø¹Ù†ÙˆØ§Ù† ÙˆØ³Ø· Ø§Ù„ØµÙØ­Ø©
      pdf.setFont('helvetica', 'bold');
      pdf.setFontSize(16);
      pdf.text('Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„ÙÙ†ÙŠØ©', pageW / 2, 60, { align: 'center' });

      // Ø³Ø·Ø± Ø§Ù„Ø³Ù†Ø© (ÙˆØªØ­ØªÙ‡ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©)
      pdf.setFont('helvetica', 'normal');
      pdf.setFontSize(12);
      pdf.text(`Ø§Ù„Ø³Ù†Ø©: ${year}`, pageW / 2, 80, { align: 'center' });

      // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø³Ø§Ø¹Ø¯Ø©
      pdf.setFontSize(11);
      pdf.text(`Ø§Ù„ÙØµÙ„: ${className}`, 40, 115, { align: 'left' });
      pdf.text(`Ø§Ù„Ø´Ù‡Ø±: ${month}`, 40, 135, { align: 'left' });

      // Ø®Ø· ÙØ§ØµÙ„
      pdf.setDrawColor(180);
      pdf.line(40, 150, pageW - 40, 150);

      // Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©
      y = 170;
      pdf.setFontSize(11);
      const cols = [
        { title: 'Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', x: 40 },
        { title: 'Ø§Ø®ØªØ¨Ø§Ø±',     x: 250 },
        { title: 'ÙˆØ§Ø¬Ø¨',       x: 300 },
        { title: 'Ù…Ø´Ø§Ø±ÙƒØ©',     x: 350 },
        { title: 'Ø³Ù„ÙˆÙƒ',       x: 410 },
        { title: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',    x: 460 },
        { title: 'Ø§Ù„ØªÙ‚Ø¯ÙŠØ±',    x: 520 },
      ];

      cols.forEach(c => pdf.text(c.title, c.x, y));
      y += 10;
      pdf.line(40, y, pageW - 40, y);
      y += 16;

      // ØµÙÙˆÙ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
      evalSnap.forEach(d => {
        const e = d.data();
        const absent = e.test === 0;

        pdf.text(String(e.name || ''), 40, y);
        pdf.text(absent ? '-' : String(e.test), 250, y, { align:'left' });
        pdf.text(absent ? '-' : String(e.home), 300, y, { align:'left' });
        pdf.text(absent ? '-' : String(e.part), 350, y, { align:'left' });
        pdf.text(absent ? '-' : String(e.beh),  410, y, { align:'left' });
        pdf.text(absent ? '-' : String(e.total),460, y, { align:'left' });
        pdf.text(arabicGrade(e), 520, y, { align:'left' });

        y += 18;
        if (y > 790) {
          pdf.addPage();
          y = 60;
        }
      });

      pdf.save(`ØªÙ‚ÙŠÙŠÙ…Ø§Øª_${className}_${month}_${year}.pdf`);
    }

    // Ø²Ø±Ø§Ø± ÙˆØ§Ø­Ø¯ ÙŠØ·Ù„Ø¹ PDF Ù…Ø¨Ø§Ø´Ø±Ø©
    document.getElementById('view-btn').addEventListener('click', generatePDF);
  </script>
</body>
</html>
