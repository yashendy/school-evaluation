<!-- evaluations.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <!-- jsPDF + AutoTable (Ù„Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„ÙÙŠÙƒØªÙˆØ±) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

  <!-- Ù…ÙƒØªØ¨Ø© ØªØ´ÙƒÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµØ­ÙŠØ­ Ø¯Ø§Ø®Ù„ PDF) -->
  <script src="https://cdn.jsdelivr.net/npm/arabicjs@3.2.0/dist/arabic.min.js"></script>

  <!-- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ -->
  <script src="firebase-config.js"></script>

  <style>
    :root{
      --primary:#0288d1; --muted:#666; --surface:#fff; --bg:#f4f6fa;
      --border:#cfd8dc; --head:#eceff1;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',Tahoma,Arial,sans-serif;background:var(--bg)}
    .container{max-width:1000px;margin:32px auto;padding:20px;background:var(--surface);border-radius:12px;box-shadow:0 3px 14px rgba(0,0,0,.08)}
    h1{margin:8px 0 18px;color:var(--primary);text-align:center}
    label{display:block;margin-top:10px;color:#333}
    select,button{width:100%;padding:10px;font-size:16px;margin-top:6px}
    .actions{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:12px}
    .btn{border:none;border-radius:8px;cursor:pointer}
    .btn-primary{background:var(--primary);color:#fff}
    .btn-secondary{background:#455a64;color:#fff}
    .btn-outline{background:#fff;color:var(--primary);border:2px solid var(--primary)}
    table{width:100%;border-collapse:collapse;margin-top:16px}
    th,td{border:1px solid var(--border);padding:8px;text-align:center;font-size:14px}
    th{background:var(--head)}
    .muted{color:var(--muted);font-size:13px;text-align:center;margin-top:6px}
  </style>
</head>
<body>
  <div class="container">
    <h1>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨</h1>

    <label>ğŸ“˜ Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„:</label>
    <select id="class-select"></select>

    <label>ğŸ“… Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</label>
    <select id="month-select">
      <option>ÙŠÙ†Ø§ÙŠØ±</option><option>ÙØ¨Ø±Ø§ÙŠØ±</option><option>Ù…Ø§Ø±Ø³</option><option>Ø£Ø¨Ø±ÙŠÙ„</option>
      <option>Ù…Ø§ÙŠÙˆ</option><option>ÙŠÙˆÙ†ÙŠÙˆ</option><option>ÙŠÙˆÙ„ÙŠÙˆ</option><option>Ø£ØºØ³Ø·Ø³</option>
      <option>Ø³Ø¨ØªÙ…Ø¨Ø±</option><option>Ø£ÙƒØªÙˆØ¨Ø±</option><option>Ù†ÙˆÙÙ…Ø¨Ø±</option><option>Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
    </select>

    <div class="actions">
      <button id="search-btn" class="btn btn-primary">ğŸ” Ø¨Ø­Ø« (Ø¹Ø±Ø¶ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„)</button>
      <button id="pdf-filled-btn" class="btn btn-secondary">ğŸ–¨ï¸ PDF Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
      <button id="pdf-blank-btn" class="btn btn-outline">ğŸ“ PDF ÙØ§Ø±Øº Ù„Ù„ØªØ¹Ø¨Ø¦Ø©</button>
    </div>

    <div class="muted">ÙŠØ¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„ ÙÙ‚Ø·. Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ØªÙØ¬Ù„Ø¨ Ù„Ø´Ù‡Ø± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø¥Ù† ÙˆÙØ¬Ø¯Øª.</div>

    <table id="results-table" style="display:none">
      <thead>
        <tr>
          <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
          <th>Ø§Ø®ØªØ¨Ø§Ø±</th>
          <th>ÙˆØ§Ø¬Ø¨</th>
          <th>Ù…Ø´Ø§Ø±ÙƒØ©</th>
          <th>Ø³Ù„ÙˆÙƒ</th>
          <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th>
          <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
        </tr>
      </thead>
      <tbody id="results-body"></tbody>
    </table>
  </div>

  <script>
    // ================== Firebase ==================
    const auth = firebase.auth();
    const db   = firebase.firestore();

    let currentTeacherId = null;
    let cachedRows = [];      // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø®ÙŠØ±
    let cachedStudents = [];  // Ø£Ø³Ù…Ø§Ø¡ Ø·Ù„Ø¨Ø© Ø§Ù„ÙØµÙ„

    // ================== Auth + ØªØ­Ù…ÙŠÙ„ ÙØµÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… ==================
    auth.onAuthStateChanged(async user => {
      if (!user) return location.href = 'index.html';
      currentTeacherId = user.uid;

      const u = await db.collection('users').doc(currentTeacherId).get();
      const ud = u.data();
      if (!ud || ud.type !== 'teacher') {
        alert('â— Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
        await auth.signOut();
        return (location.href = 'index.html');
      }
      loadTeacherClasses();
    });

    async function loadTeacherClasses() {
      const sel = document.getElementById('class-select');
      sel.innerHTML = '';
      const snap = await db.collection('classes')
        .where('teacher','==',currentTeacherId).get();

      if (snap.empty) {
        sel.innerHTML = '<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØµÙˆÙ„ Ù…Ø³Ù†Ø¯Ø©</option>';
        return;
      }
      snap.forEach(d => {
        const c = d.data();
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = `${c.grade} - ${c.system} - ${c.section}`;
        sel.appendChild(opt);
      });
    }

    // ================== Helpers ==================
    function arabicEval(e) {
      if (e == null || e.test == null || e.test === '') return '';
      if (e.test === 0) return 'ØºÙŠØ§Ø¨';
      if (e.test < 7)  return 'ØªØ´Ø¬ÙŠØ¹ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±';
      if (e.total === 40) return 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±';
      if (e.total >= 36)  return 'Ù…Ù…ØªØ§Ø²';
      return 'Ù†Ø±Ø¬Ùˆ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ´Ø¬ÙŠØ¹Ù‡';
    }

    function getSelectedClassText(){
      return document.getElementById('class-select').selectedOptions[0]?.textContent || '';
    }

    // ØªØ´ÙƒÙŠÙ„/ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ù„Ù†ØµÙˆØµ Ø¯Ø§Ø®Ù„ PDF
    function shapeTxt(str){
      if (str === 0) return '0';
      if (str == null) return '';
      str = String(str);
      try {
        if (window.ArabicJS) {
          // Ø¨Ø¹Ø¶ Ø§Ù„Ø¥ØµØ¯Ø§Ø±Ø§Øª ØªØ³ØªØ®Ø¯Ù… shape ÙˆØ£Ø®Ø±Ù‰ Shape
          if (typeof ArabicJS.shape === 'function') return ArabicJS.shape(str);
          if (typeof ArabicJS.Shape === 'function') return ArabicJS.Shape(str);
        }
      } catch(e){}
      return str;
    }

    // ØªØ­Ù…ÙŠÙ„ Ø®Ø· Cairo ÙˆØ¥Ø¶Ø§ÙØªÙ‡ Ù„Ù€ VFS Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
    let fontLoaded = false;
    async function ensureArabicFont() {
      if (fontLoaded) return;
      const url = 'fonts/Cairo-Regular.ttf'; // Ø¶Ø¹Ù Ø§Ù„Ù…Ù„Ù Ù‡Ù†Ø§
      const resp = await fetch(url);
      if (!resp.ok) {
        alert('âš ï¸ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù…Ù„Ù Ø§Ù„Ø®Ø· Cairo-Regular.ttf Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ fonts/.');
        return;
      }
      const buf = await resp.arrayBuffer();
      // Ù†Ø­ÙˆÙ„Ù‡ Base64
      const b64 = btoa(
        new Uint8Array(buf).reduce((data, byte) => data + String.fromCharCode(byte), '')
      );
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF(); // Ù…Ø¬Ø±Ø¯ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… VFS
      pdf.addFileToVFS('Cairo-Regular.ttf', b64);
      pdf.addFont('Cairo-Regular.ttf', 'Cairo', 'normal');
      fontLoaded = true;
    }

    // ================== Ø¨Ø­Ø«: Ø¹Ø±Ø¶ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„ ÙˆØ¯Ù…Ø¬ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ==================
    async function searchAndRender() {
      const classId = document.getElementById('class-select').value;
      const month   = document.getElementById('month-select').value;
      if (!classId || !month) return alert('âš ï¸ Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø´Ù‡Ø±');

      const tbody = document.getElementById('results-body');
      const table = document.getElementById('results-table');
      tbody.innerHTML = '<tr><td colspan="7">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>';
      table.style.display = 'table';

      // 1) Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„
      const stSnap = await db.collection('students').where('classId','==',classId).get();
      cachedStudents = [];
      stSnap.forEach(s => cachedStudents.push({ id:s.id, name:s.data().name || '' }));
      cachedStudents.sort((a,b)=>a.name.localeCompare(b.name, 'ar'));

      // 2) ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±
      const evSnap = await db.collection('evaluations')
        .where('teacher','==', currentTeacherId)
        .where('classId','==', classId)
        .where('month','==', month)
        .get();
      const evalMap = new Map();
      evSnap.forEach(d => {
        const e = d.data();
        const key = e.studentId || (e.name||'').trim();
        evalMap.set(key, e);
      });

      // 3) Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      cachedRows = [];
      tbody.innerHTML = '';
      if (!cachedStudents.length){
        tbody.innerHTML = '<tr><td colspan="7">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„</td></tr>';
        return;
      }

      cachedStudents.forEach(st => {
        const e = evalMap.get(st.id) || evalMap.get((st.name||'').trim());
        const row = {
          name: st.name,
          test: e ? e.test : '',
          home: e ? e.home : '',
          part: e ? e.part : '',
          beh:  e ? e.beh  : '',
          total: e ? e.total : '',
          grade: e ? arabicEval(e) : ''
        };
        cachedRows.push(row);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:right">${row.name}</td>
          <td>${row.test === 0 ? '-' : (row.test ?? '')}</td>
          <td>${row.test === 0 ? '-' : (row.home ?? '')}</td>
          <td>${row.test === 0 ? '-' : (row.part ?? '')}</td>
          <td>${row.test === 0 ? '-' : (row.beh  ?? '')}</td>
          <td>${row.test === 0 ? '-' : (row.total?? '')}</td>
          <td>${row.grade}</td>`;
        tbody.appendChild(tr);
      });
    }

    // ================== Ø·Ø¨Ø§Ø¹Ø© PDF ÙÙŠÙƒØªÙˆØ± (AutoTable + Ø®Ø· Ø¹Ø±Ø¨ÙŠ) ==================
    async function drawHeader(pdf, {year, classText, month, showMonth=true}) {
      // Ø§Ù„Ø´Ø¹Ø§Ø± ÙŠÙ…ÙŠÙ†
      try{
        const res = await fetch('logo.png'); 
        const blob = await res.blob();
        const dataUrl = await new Promise(r=>{const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(blob);});
        const pageW = pdf.internal.pageSize.getWidth();
        pdf.addImage(dataUrl, 'PNG', pageW-40-70, 24, 70, 70);
      }catch(e){/* ØªØ¬Ø§Ù‡Ù„ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ */}

      pdf.setFont('Cairo','normal');
      pdf.setFontSize(16);
      pdf.text(shapeTxt('Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„ÙÙ†ÙŠØ©'), pdf.internal.pageSize.getWidth()/2, 50, {align:'center'});

      pdf.setFontSize(12);
      const yearLine = `Ø§Ù„Ø³Ù†Ø©: ${year}`;
      pdf.text(shapeTxt(yearLine), pdf.internal.pageSize.getWidth()/2, 70, {align:'center'});

      pdf.setDrawColor(180);
      pdf.line(40, 84, pdf.internal.pageSize.getWidth()-40, 84);

      pdf.setFontSize(11);
      let meta = `Ø§Ù„ÙØµÙ„: ${classText}`;
      if (showMonth) meta += `  |  Ø§Ù„Ø´Ù‡Ø±: ${month}`;
      pdf.text(shapeTxt(meta), 40, 100, {align:'left'});
    }

    async function exportFilledPDF() {
      if (!cachedRows.length) return alert('Ø§Ø¹Ù…Ù„ Ø¨Ø­Ø« Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„');
      await ensureArabicFont();

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:'pt', format:'a4' });
      pdf.setFont('Cairo','normal');

      const year  = new Date().getFullYear();
      const month = document.getElementById('month-select').value;
      const klass = getSelectedClassText();

      await drawHeader(pdf, {year, classText: klass, month, showMonth:true});

      // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const head = [[
        shapeTxt('Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'),
        shapeTxt('Ø§Ø®ØªØ¨Ø§Ø±'),
        shapeTxt('ÙˆØ§Ø¬Ø¨'),
        shapeTxt('Ù…Ø´Ø§Ø±ÙƒØ©'),
        shapeTxt('Ø³Ù„ÙˆÙƒ'),
        shapeTxt('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹'),
        shapeTxt('Ø§Ù„ØªÙ‚Ø¯ÙŠØ±')
      ]];

      const body = cachedRows.map(r => ([
        shapeTxt(r.name ?? ''),
        shapeTxt(r.test === 0 ? '-' : (r.test ?? '')),
        shapeTxt(r.test === 0 ? '-' : (r.home ?? '')),
        shapeTxt(r.test === 0 ? '-' : (r.part ?? '')),
        shapeTxt(r.test === 0 ? '-' : (r.beh  ?? '')),
        shapeTxt(r.test === 0 ? '-' : (r.total?? '')),
        shapeTxt(r.grade ?? '')
      ]));

      pdf.autoTable({
        startY: 118,
        head, body,
        theme: 'grid',
        styles: { font: 'Cairo', fontStyle: 'normal', halign: 'center' },
        headStyles: { fillColor: [236,239,241], textColor: 20, halign:'center' },
        columnStyles: {
          0: { halign:'right' } // Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ ÙŠÙ…ÙŠÙ†
        },
        didParseCell: (data) => {
          // ØªØ£ÙƒÙŠØ¯ ØªØ´ÙƒÙŠÙ„ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ù„Ø£ÙŠ Ù†Øµ Ù…ÙØ¯Ø®Ù„
          if (typeof data.cell.text === 'string') {
            data.cell.text = shapeTxt(data.cell.text);
          } else if (Array.isArray(data.cell.text)) {
            data.cell.text = data.cell.text.map(t => shapeTxt(t));
          }
        }
      });

      pdf.save(`Ù†ØªÙŠØ¬Ø©_${klass}_${month}_${year}.pdf`);
    }

    async function exportBlankPDF() {
      if (!cachedRows.length) await searchAndRender();
      if (!cachedRows.length) return;
      await ensureArabicFont();

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF({ unit:'pt', format:'a4' });
      pdf.setFont('Cairo','normal');

      const year  = new Date().getFullYear();
      const klass = getSelectedClassText();

      await drawHeader(pdf, {year, classText: klass, month:'', showMonth:false});

      const head = [[
        shapeTxt('Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨'),
        shapeTxt('Ø§Ø®ØªØ¨Ø§Ø±'),
        shapeTxt('ÙˆØ§Ø¬Ø¨'),
        shapeTxt('Ù…Ø´Ø§Ø±ÙƒØ©'),
        shapeTxt('Ø³Ù„ÙˆÙƒ'),
        shapeTxt('Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹'),
        shapeTxt('Ø§Ù„ØªÙ‚Ø¯ÙŠØ±')
      ]];

      const body = cachedRows.map(r => ([
        shapeTxt(r.name || ''),
        '', '', '', '', '', ''
      ]));

      pdf.autoTable({
        startY: 118,
        head, body,
        theme: 'grid',
        styles: { font: 'Cairo', fontStyle: 'normal', halign: 'center' },
        headStyles: { fillColor: [236,239,241], textColor: 20, halign:'center' },
        columnStyles: { 0: { halign:'right' } }
      });

      pdf.save(`ÙƒØ´Ù_ÙØ§Ø±Øº_${klass}_${year}.pdf`);
    }

    // ================== Events ==================
    document.getElementById('search-btn').addEventListener('click', searchAndRender);
    document.getElementById('pdf-filled-btn').addEventListener('click', exportFilledPDF);
    document.getElementById('pdf-blank-btn').addEventListener('click', exportBlankPDF);
  </script>
</body>
</html>
