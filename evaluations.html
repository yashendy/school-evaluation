<!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ØµÙØ­Ø© evaluations.html -->
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ğŸ“ ØµÙØ­Ø© ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#f4f6fa; direction:rtl; }
    .container { max-width:1000px; margin:40px auto; padding:20px; background:#fff; box-shadow:0 0 10px #ccc; }
    h1,h2 { text-align:center; color:#0288d1; }
    select,button { padding:10px; font-size:16px; margin:10px 0; width:100%; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th,td { border:1px solid #ccc; padding:10px; text-align:center; }
    th { background:#eee; }
    .grade-absent { background:#f0f0f0; }
    .grade-top { background:#d4edda; }
    .grade-good { background:#cce5ff; }
    .grade-encourage { background:#ffe5b4; }
    .print-btn { background:#0288d1; color:#fff; padding:10px 20px; border:none; border-radius:5px; cursor:pointer; display:none; }
  </style>
</head>

<body>
  <div class="container">
    <img src="logo.png" alt="Logo" style="width:100px; display:block; margin:0 auto;">
    <h1>Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„ÙÙ†ÙŠØ©</h1>
    <h2>ğŸ“ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨</h2>

    <label>ğŸ“˜ Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„:</label>
    <select id="class-select"></select>

    <label>ğŸ“… Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±:</label>
    <select id="month-select">
      <option>ÙŠÙ†Ø§ÙŠØ±</option><option>ÙØ¨Ø±Ø§ÙŠØ±</option><option>Ù…Ø§Ø±Ø³</option><option>Ø£Ø¨Ø±ÙŠÙ„</option>
      <option>Ù…Ø§ÙŠÙˆ</option><option>ÙŠÙˆÙ†ÙŠÙˆ</option><option>ÙŠÙˆÙ„ÙŠÙˆ</option><option>Ø£ØºØ³Ø·Ø³</option>
      <option>Ø³Ø¨ØªÙ…Ø¨Ø±</option><option>Ø£ÙƒØªÙˆØ¨Ø±</option><option>Ù†ÙˆÙÙ…Ø¨Ø±</option><option>Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
    </select>

    <button onclick="loadEvalResults()">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
    <div id="eval-results"></div>

    <button id="print-btn" class="print-btn" onclick="printEvalPDF()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… PDF</button>
  </div>
<!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø³ÙƒØ±Ø¨Øª Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØµÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø¹Ù„Ù… -->
<script>
  const auth = firebase.auth();
  const db = firebase.firestore();
  let currentTeacherId = null;

  auth.onAuthStateChanged(async user => {
    if (!user) return location.href = 'index.html';
    currentTeacherId = user.uid;
    const doc = await db.collection('users').doc(currentTeacherId).get();
    const data = doc.data();
    if (!data || data.type !== 'teacher') {
      alert('â— Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
      return auth.signOut().then(() => location.href = 'index.html');
    }
    loadTeacherClasses();
  });

  async function loadTeacherClasses() {
    const sel = document.getElementById('class-select');
    sel.innerHTML = '';

    const snap = await db.collection('classes')
      .where('teacher','==',currentTeacherId)
      .get();

    snap.forEach(doc => {
      const d = doc.data();
      const opt = document.createElement('option');
      opt.value = doc.id;
      opt.textContent = `${d.grade} - ${d.system} - ${d.section}`;
      sel.appendChild(opt);
    });
  }
</script>
<!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙÙŠ Ø¬Ø¯ÙˆÙ„ -->
<script>
  async function showEvaluations() {
    const classId = document.getElementById('class-select').value;
    const month = document.getElementById('month-select').value;
    const year = new Date().getFullYear();

    if (!classId || !month) return alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø´Ù‡Ø±');

    const container = document.getElementById('results-container');
    container.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';

    const snap = await db.collection('evaluations')
      .where('teacher', '==', currentTeacherId)
      .where('classId', '==', classId)
      .where('month', '==', month)
      .get();

    if (snap.empty) {
      container.innerHTML = `<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ø´Ù‡Ø± ${month}</p>`;
      return;
    }

    let html = `
      <table><thead><tr>
        <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th><th>Ø§Ø®ØªØ¨Ø§Ø±</th><th>ÙˆØ§Ø¬Ø¨</th><th>Ù…Ø´Ø§Ø±ÙƒØ©</th>
        <th>Ø³Ù„ÙˆÙƒ</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
      </tr></thead><tbody>`;

    snap.forEach(doc => {
      const e = doc.data();
      let grade = '';

      if (e.test === 0) {
        grade = 'ØºÙŠØ§Ø¨';
      } else if (e.test < 7) {
        grade = 'ØªØ´Ø¬ÙŠØ¹ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±';
      } else if (e.total === 40) {
        grade = 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±';
      } else if (e.total >= 36) {
        grade = 'Ù…Ù…ØªØ§Ø²';
      } else {
        grade = 'Ù†Ø±Ø¬Ùˆ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ´Ø¬ÙŠØ¹Ù‡';
      }

      html += `
        <tr>
          <td>${e.name}</td>
          <td>${e.test === 0 ? '-' : e.test}</td>
          <td>${e.test === 0 ? '-' : e.home}</td>
          <td>${e.test === 0 ? '-' : e.part}</td>
          <td>${e.test === 0 ? '-' : e.beh}</td>
          <td>${e.test === 0 ? '-' : e.total}</td>
          <td>${grade}</td>
        </tr>`;
    });

    html += '</tbody></table>';
    container.innerHTML = html;
  }
</script>
<!-- Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª PDF Ø¨ØµÙŠØºØ© Ø±Ø³Ù…ÙŠØ© -->
<script>
  async function printEvaluationsPDF() {
    const classId = document.getElementById('class-select').value;
    const month = document.getElementById('month-select').value;
    const year = new Date().getFullYear();

    if (!classId || !month) return alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø´Ù‡Ø±');

    const classDoc = await db.collection('classes').doc(classId).get();
    const classData = classDoc.data();
    const className = `Ø§Ù„ØµÙ ${classData.grade} ${classData.system} ${classData.section}`;

    const snap = await db.collection('evaluations')
      .where('teacher', '==', currentTeacherId)
      .where('classId', '==', classId)
      .where('month', '==', month)
      .get();

    if (snap.empty) {
      alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©');
      return;
    }

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(20);
    doc.text("ğŸ“˜ Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„ÙÙ†ÙŠØ©", 50, 20, { align: "center" });

    doc.setFontSize(16);
    doc.text(`Ù†ØªÙŠØ¬Ø© Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø§Ø¯Ø© Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ© Ù„Ø´Ù‡Ø± ${month} Ø¹Ø§Ù… ${year}`, 20, 40);
    doc.text(`Ù„Ù„${className}`, 20, 50);

    let y = 70;
    doc.setFontSize(12);
    doc.text("Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨    Ø§Ø®ØªØ¨Ø§Ø±   ÙˆØ§Ø¬Ø¨   Ù…Ø´Ø§Ø±ÙƒØ©   Ø³Ù„ÙˆÙƒ   Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹   Ø§Ù„ØªÙ‚Ø¯ÙŠØ±", 20, y);
    y += 10;

    snap.forEach(docSnap => {
      const e = docSnap.data();
      let grade = '';

      if (e.test === 0) grade = 'ØºÙŠØ§Ø¨';
      else if (e.test < 7) grade = 'ØªØ´Ø¬ÙŠØ¹ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±';
      else if (e.total === 40) grade = 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±';
      else if (e.total >= 36) grade = 'Ù…Ù…ØªØ§Ø²';
      else grade = 'Ù†Ø±Ø¬Ùˆ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©';

      const row = `${e.name.padEnd(15)} ${e.test.toString().padEnd(7)} ${e.home.toString().padEnd(6)} ${e.part.toString().padEnd(8)} ${e.beh.toString().padEnd(6)} ${e.total.toString().padEnd(8)} ${grade}`;
      doc.text(row, 20, y);
      y += 10;
      if (y > 270) {
        doc.addPage();
        y = 20;
      }
    });

    doc.save(`ØªÙ‚ÙŠÙŠÙ…Ø§Øª_${className}_${month}_${year}.pdf`);
  }
</script>
  </script>
</body>
</html>
