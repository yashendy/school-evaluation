<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>صفحة الطالب برقم الجلوس</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body{ margin:0; font-family:'Segoe UI', Tahoma, Arial, sans-serif; background:#f5f7fa; color:#222; }
    .wrap{ max-width:720px; margin:24px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.06); }
    h2{ margin:0 0 6px; color:#0d6efd; }
    .muted{ color:#666; font-size:14px; }
    .row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:10px }
    .card{ background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:12px; }
    .form{ display:flex; gap:8px; margin:10px 0 16px }
    input[type=text]{ flex:1; padding:12px; border:1px solid #ced4da; border-radius:10px; font-size:16px }
    button{ padding:12px 16px; border:0; background:#0d6efd; color:#fff; border-radius:10px; cursor:pointer; }
    table{ width:100%; border-collapse:collapse; margin-top:8px }
    th,td{ border:1px solid #e9ecef; padding:8px; text-align:center }
    th{ background:#f2f5f7 }
    .center{ text-align:center }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>عرض بيانات الطالب</h2>
    <p class="muted">ادخل مباشرة عبر الرابط مثل: <code>student.html?seat=110001</code></p>

    <!-- نموذج إدخال رقم الجلوس (يظهر عند عدم توفر بارامتر seat) -->
    <div id="seat-form" class="form" style="display:none">
      <input id="seat-input" type="text" inputmode="numeric" placeholder="ادخل رقم الجلوس (مثال: 110001)">
      <button id="go-seat">عرض</button>
    </div>

    <!-- معلومات الطالب -->
    <div id="student-card" class="card" style="display:none">
      <div class="row">
        <div><b>الاسم:</b> <span id="st-name">—</span></div>
        <div><b>رقم الجلوس:</b> <span id="st-seat">—</span></div>
        <div><b>الفصل:</b> <span id="st-class">—</span></div>
        <div><b>المعلم:</b> <span id="st-teacher">—</span></div>
      </div>
    </div>

    <!-- التقييمات -->
    <div id="eval-wrap" class="card" style="display:none; margin-top:12px">
      <h3 style="margin:0 0 8px;">التقييمات</h3>
      <table id="eval-table">
        <thead>
          <tr><th>الشهر</th><th>العام</th><th>اختبار</th><th>واجب</th><th>مشاركة</th><th>سلوك</th><th>المجموع</th><th>التقدير</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="empty" class="center muted" style="display:none; margin-top:16px">لا توجد بيانات لهذا الطالب حتى الآن.</div>
  </div>

  <script>
    const db = firebase.firestore();

    function getParam(name){
      const p = new URLSearchParams(location.search);
      return p.get(name);
    }

    function showSeatForm(){
      document.getElementById('seat-form').style.display = 'flex';
      document.getElementById('student-card').style.display = 'none';
      document.getElementById('eval-wrap').style.display = 'none';
      document.getElementById('empty').style.display = 'none';
    }

    async function loadStudentBySeat(seat){
      // ابحث عن الطالب برقم الجلوس
      const q = await db.collection('students').where('seatNumber','==', seat).limit(1).get();
      if (q.empty){
        document.getElementById('empty').textContent = 'رقم الجلوس غير صحيح.';
        document.getElementById('empty').style.display = 'block';
        document.getElementById('student-card').style.display = 'none';
        document.getElementById('eval-wrap').style.display = 'none';
        return;
      }
      const stDoc = q.docs[0];
      const st = stDoc.data();

      // هات بيانات الفصل لعرض اسمه
      let klass = '—';
      if (st.classId){
        const c = await db.collection('classes').doc(st.classId).get();
        if (c.exists){
          const d = c.data();
          klass = `${d.grade} - ${d.system} - ${d.section}`;
        }
      }

      // اسم المعلم
      let teacherName = '—';
      if (st.teacher){
        const u = await db.collection('users').doc(st.teacher).get();
        if (u.exists) teacherName = u.data().name || '—';
      }

      // عبّي بيانات الطالب
      document.getElementById('st-name').textContent = st.name || '—';
      document.getElementById('st-seat').textContent = st.seatNumber || seat;
      document.getElementById('st-class').textContent = klass;
      document.getElementById('st-teacher').textContent = teacherName;
      document.getElementById('student-card').style.display = 'block';

      // التقييمات (الأحدث أولاً)
      const evalSnap = await db.collection('evaluations')
        .where('studentId','==', stDoc.id)
        .orderBy('year','desc')
        .orderBy('month','desc')  // حقل الشهر نص عربي عندك؛ لو أردت ترتيب أدق استخدمي رقم شهر بدل النص
        .get();

      const tbody = document.querySelector('#eval-table tbody');
      tbody.innerHTML = '';
      if (evalSnap.empty){
        document.getElementById('empty').textContent = 'لا توجد تقييمات مسجّلة لهذا الطالب.';
        document.getElementById('empty').style.display = 'block';
        document.getElementById('eval-wrap').style.display = 'none';
        return;
      }

      evalSnap.forEach(d=>{
        const e = d.data();
        const total = Number(e.total) || 0;

        let evaluation = '';
        if (e.test === 0) evaluation = 'غياب';
        else if (total === 40) evaluation = 'ممتاز مع الشكر';
        else if (total >= 36) evaluation = 'ممتاز';
        else evaluation = 'يرجى التشجيع';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${e.month || ''}</td>
          <td>${e.year || ''}</td>
          <td>${e.test === 0 ? 'غ' : e.test}</td>
          <td>${e.home || 0}</td>
          <td>${e.part || 0}</td>
          <td>${e.beh  || 0}</td>
          <td>${total}</td>
          <td>${evaluation}</td>`;
        tbody.appendChild(tr);
      });

      document.getElementById('empty').style.display = 'none';
      document.getElementById('eval-wrap').style.display = 'block';
    }

    // تشغيل
    window.addEventListener('load', () => {
      const seat = (getParam('seat') || '').trim();
      if (!seat){
        showSeatForm();
      }else{
        loadStudentBySeat(seat);
      }

      document.getElementById('go-seat').addEventListener('click', () => {
        const s = document.getElementById('seat-input').value.trim();
        if (!s) return alert('أدخل رقم الجلوس');
        location.href = `student.html?seat=${encodeURIComponent(s)}`;
      });

      document.getElementById('seat-input').addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') document.getElementById('go-seat').click();
      });
    });
  </script>
</body>
</html>
