<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>عرض بيانات الطالب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    :root{ color-scheme: light; }
    body{ margin:0; font-family:'Segoe UI', Tahoma, Arial, sans-serif; background:#f5f7fa; color:#222; }
    .wrap{ max-width:980px; margin:24px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.06); }
    h2{ margin:0 0 6px; color:#0d6efd; }
    .muted{ color:#666; font-size:14px; }
    .row{ display:grid; grid-template-columns:repeat(2, minmax(220px,1fr)); gap:12px; margin-top:10px }
    .card{ background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:14px; }
    .form{ display:flex; gap:8px; margin:12px 0 16px; align-items:center; flex-wrap:wrap }
    select, input[type=text]{ padding:10px 12px; border:1px solid #ced4da; border-radius:10px; font-size:15px; background:#fff }
    button{ padding:10px 14px; border:0; background:#0d6efd; color:#fff; border-radius:10px; cursor:pointer; }
    button.secondary{ background:#6c757d; }
    table{ width:100%; border-collapse:collapse; margin-top:8px }
    th,td{ border:1px solid #e9ecef; padding:10px; text-align:center; font-size:15px }
    th{ background:#f2f5f7; font-weight:700 }
    .center{ text-align:center }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1d4ed8; font-size:13px }
    @media (max-width:640px){
      .row{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>عرض بيانات الطالب</h2>
    <p class="muted">ادخل مباشرة عبر الرابط مثل: <code>student.html?seat=110001</code></p>

    <!-- نموذج إدخال رقم الجلوس (يظهر عند عدم توفر بارامتر seat) -->
    <div id="seat-form" class="form" style="display:none">
      <input id="seat-input" type="text" inputmode="numeric" placeholder="ادخل رقم الجلوس (مثال: 110001)">
      <button id="go-seat">عرض</button>
    </div>

    <!-- معلومات الطالب (بدون اسم معلم) -->
    <div id="student-card" class="card" style="display:none">
      <div class="row">
        <div><b>الاسم:</b> <span id="st-name">—</span></div>
        <div><b>رقم الجلوس:</b> <span id="st-seat">—</span></div>
        <div><b>الفصل:</b> <span id="st-class">—</span></div>
        <div><b>عدد المواد المُقيمة:</b> <span id="st-subjects" class="pill">0</span></div>
      </div>
    </div>

    <!-- فلاتر الشهر/العام + زر طباعة كشف الدرجات -->
    <div id="filters" class="form" style="display:none">
      <label>الشهر:</label>
      <select id="sel-month"></select>
      <label>العام:</label>
      <select id="sel-year"></select>
      <button id="btn-apply" class="secondary">عرض الدرجات</button>
      <span style="flex:1"></span>
      <button id="btn-print">🖨️ طباعة كشف درجات الشهر</button>
    </div>

    <!-- الدرجات حسب الشهر/العام -->
    <div id="eval-wrap" class="card" style="display:none; margin-top:12px">
      <h3 style="margin:0 0 8px;">التقييمات</h3>
      <table id="eval-table">
        <thead>
          <tr>
            <th>المادة</th>
            <th>اختبار (10)</th>
            <th>واجب (10)</th>
            <th>مشاركة (10)</th>
            <th>سلوك (10)</th>
            <th>المجموع (40)</th>
            <th>التقدير</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="no-data" class="center muted" style="display:none; padding:10px">لا توجد درجات لهذا الشهر.</div>
    </div>

    <div id="empty" class="center muted" style="display:none; margin-top:16px">لا توجد بيانات لهذا الطالب حتى الآن.</div>
  </div>

  <script>
    const db = firebase.firestore();

    // شهور مرتبة (للعرض والفصل)
    const MONTHS = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
    const monthIndex = (m)=> MONTHS.indexOf(m);

    // حالة عامة
    let studentDocId = null;           // ID وثيقة الطالب
    let studentObj   = null;           // بيانات الطالب
    let allEvals     = [];             // كل تقييمات الطالب
    const teacherCache = new Map();    // teacherId -> {name, subject}

    function getParam(name){
      const p = new URLSearchParams(location.search);
      return p.get(name);
    }

    function showSeatForm(){
      document.getElementById('seat-form').style.display = 'flex';
      document.getElementById('student-card').style.display = 'none';
      document.getElementById('filters').style.display = 'none';
      document.getElementById('eval-wrap').style.display = 'none';
      document.getElementById('empty').style.display = 'none';
    }

    async function fetchTeacherMeta(teacherId){
      if (!teacherId) return { name:'—', subject:'—' };
      if (teacherCache.has(teacherId)) return teacherCache.get(teacherId);
      const u = await db.collection('users').doc(teacherId).get();
      const meta = u.exists ? { name: u.data().name || '—', subject: u.data().subject || '—' } : { name:'—', subject:'—' };
      teacherCache.set(teacherId, meta);
      return meta;
    }

    function evaluationLabel(total, test){
      const t = Number(total)||0;
      if (test===0) return 'غياب';
      if (t===40)   return 'ممتاز مع الشكر';
      if (t>=36)    return 'ممتاز';
      return 'يرجى تشجيع الطالب';
    }

    function fillStudentCard(subjectCount){
      document.getElementById('st-name').textContent = studentObj.name || '—';
      document.getElementById('st-seat').textContent = studentObj.seatNumber || '—';

      // اسم الفصل
      const klass = studentObj._klassText || '—';
      document.getElementById('st-class').textContent = klass;

      document.getElementById('st-subjects').textContent = String(subjectCount ?? 0);
      document.getElementById('student-card').style.display = 'block';
    }

    function buildFilters(){
      const years = Array.from(new Set(allEvals.map(e=>Number(e.year)).filter(Boolean))).sort((a,b)=>b-a);
      const months = Array.from(new Set(allEvals.map(e=>e.month).filter(Boolean)))
                          .sort((a,b)=>(monthIndex(b)-monthIndex(a)));

      const selYear  = document.getElementById('sel-year');
      const selMonth = document.getElementById('sel-month');
      selYear.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
      selMonth.innerHTML = months.map(m=>`<option value="${m}">${m}</option>`).join('');

      // اختيارات افتراضية: أحدث سنة وأحدث شهر فيها تقييمات
      if (years.length) selYear.value = years[0];
      if (months.length) selMonth.value = months[0];

      document.getElementById('filters').style.display = (years.length && months.length) ? 'flex' : 'none';
    }

    async function renderForSelectedMonth(){
      const m = document.getElementById('sel-month').value;
      const y = Number(document.getElementById('sel-year').value);
      const tbody = document.querySelector('#eval-table tbody');
      tbody.innerHTML = '';
      document.getElementById('no-data').style.display = 'none';

      const filtered = allEvals.filter(e => e.month===m && Number(e.year)===y);
      if (!filtered.length){
        document.getElementById('eval-wrap').style.display = 'block';
        document.getElementById('no-data').style.display = 'block';
        fillStudentCard(0);
        return;
      }

      // اجمع حسب المعلّم (مادة لكل معلّم)
      const rows = [];
      for (const e of filtered){
        const meta = await fetchTeacherMeta(e.teacher);
        rows.push({
          subject: meta.subject || '—',
          test: Number(e.test)||0,
          home: Number(e.home)||0,
          part: Number(e.part)||0,
          beh : Number(e.beh)||0,
          total: Number(e.total)||0,
          eval: evaluationLabel(e.total, e.test)
        });
      }

      // رتّب بالموضوع (المادة)
      rows.sort((a,b)=> (a.subject||'').localeCompare(b.subject||'', 'ar'));

      // عبّي الجدول
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:right">${r.subject}</td>
          <td>${r.test===0?'غ':r.test}</td>
          <td>${r.home}</td>
          <td>${r.part}</td>
          <td>${r.beh}</td>
          <td>${r.total}</td>
          <td>${r.eval}</td>`;
        tbody.appendChild(tr);
      });

      document.getElementById('eval-wrap').style.display = 'block';
      fillStudentCard(rows.length);
    }

    async function loadStudentBySeat(seat){
      // الطالب
      const q = await db.collection('students').where('seatNumber','==', seat).limit(1).get();
      if (q.empty){
        document.getElementById('empty').textContent = 'رقم الجلوس غير صحيح.';
        document.getElementById('empty').style.display = 'block';
        document.getElementById('student-card').style.display = 'none';
        document.getElementById('filters').style.display = 'none';
        document.getElementById('eval-wrap').style.display = 'none';
        return;
      }
      const stDoc = q.docs[0];
      studentDocId = stDoc.id;
      studentObj   = stDoc.data();

      // اسم الفصل
      if (studentObj.classId){
        const c = await db.collection('classes').doc(studentObj.classId).get();
        if (c.exists){
          const d = c.data();
          studentObj._klassText = `${d.grade} - ${d.system} - ${d.section}`;
        }
      }

      // كل التقييمات
      const evalSnap = await db.collection('evaluations')
        .where('studentId','==', studentDocId)
        .get();

      allEvals = evalSnap.docs.map(d=>d.data());
      if (!allEvals.length){
        fillStudentCard(0);
        document.getElementById('filters').style.display = 'none';
        document.getElementById('eval-wrap').style.display = 'none';
        document.getElementById('empty').textContent = 'لا توجد تقييمات مسجّلة لهذا الطالب.';
        document.getElementById('empty').style.display = 'block';
        return;
      }

      // حضّري الفلاتر واعرض أحدث شهر/عام
      buildFilters();
      await renderForSelectedMonth();
      document.getElementById('empty').style.display = 'none';
    }

    // طباعة كشف درجات الشهر الحالي
    async function printMonthlyReport(){
      const m = document.getElementById('sel-month').value;
      const y = Number(document.getElementById('sel-year').value);

      // جهّز الصفوف الحالية من الجدول
      const rows = Array.from(document.querySelectorAll('#eval-table tbody tr'))
        .map(tr => Array.from(tr.children).map(td => td.textContent.trim()));

      const win = window.open('', '_blank');
      win.document.write(`
        <!DOCTYPE html><html lang="ar" dir="rtl"><head>
        <meta charset="utf-8">
        <title>كشف درجات - ${studentObj?.name || ''} - ${m} ${y}</title>
        <style>
          body{ font-family:'Segoe UI', Tahoma, Arial, sans-serif; padding:24px; color:#222 }
          h2{ margin:0 0 6px; }
          .muted{ color:#666 }
          table{ width:100%; border-collapse:collapse; margin-top:12px }
          th,td{ border:1px solid #ddd; padding:10px; text-align:center }
          th{ background:#f2f5f7 }
        </style>
        </head><body>
          <h2>كشف درجات الشهر</h2>
          <div class="muted">${studentObj?.name || ''} — رقم الجلوس: ${studentObj?.seatNumber || ''}</div>
          <div class="muted">الفصل: ${studentObj?._klassText || ''}</div>
          <div class="muted">الشهر/العام: ${m} ${y}</div>

          <table>
            <thead>
              <tr><th>المادة</th><th>اختبار (10)</th><th>واجب (10)</th><th>مشاركة (10)</th><th>سلوك (10)</th><th>المجموع (40)</th><th>التقدير</th></tr>
            </thead>
            <tbody>
              ${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}
            </tbody>
          </table>

          <script>setTimeout(()=>window.print(), 300);<\/script>
        </body></html>
      `);
      win.document.close();
    }

    // تشغيل
    window.addEventListener('load', () => {
      const seat = (getParam('seat') || '').trim();
      if (!seat){
        showSeatForm();
      }else{
        loadStudentBySeat(seat);
      }

      // إدخال رقم الجلوس
      document.getElementById('go-seat').addEventListener('click', () => {
        const s = document.getElementById('seat-input').value.trim();
        if (!s) return alert('أدخل رقم الجلوس');
        location.href = `student.html?seat=${encodeURIComponent(s)}`;
      });
      document.getElementById('seat-input').addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') document.getElementById('go-seat').click();
      });

      // الفلاتر
      document.getElementById('btn-apply').addEventListener('click', renderForSelectedMonth);
      document.getElementById('btn-print').addEventListener('click', printMonthlyReport);
    });
  </script>
</body>
</html>
