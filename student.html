<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>نتيجة الطالب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    .container { max-width:600px; margin:60px auto; background:#fff; padding:20px; box-shadow:0 2px 6px rgba(0,0,0,0.1); border-radius:6px; }
    h2, h3 { text-align:center; }
    input, button { width:100%; padding:12px; margin:6px 0; font-size:16px; }
    table { width:100%; border-collapse:collapse; margin-top:16px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:center; }
    th { background:#eee; }
    .grade-absent { background:#f0f0f0; }
    .grade-top { background:#d4edda; }
    .grade-good { background:#cce5ff; }
    .grade-encourage { background:#ffe5b4; }
    #print-all-btn { margin-top:20px; background:#0288d1; color:#fff; border:none; padding:12px; cursor:pointer; border-radius:5px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>عرض نتيجة الطالب</h2>
    <input type="text" id="seat-input" placeholder="أدخل رقم الجلوس">
    <button id="view-btn">عرض النتائج</button>
    <div id="output"></div>
  </div>

<script>
const db = firebase.firestore();

document.getElementById('view-btn').onclick = async () => {
  const seat = document.getElementById('seat-input').value.trim();
  if (!seat) return alert('يرجى إدخال رقم الجلوس');
  const snap = await db.collection('evaluations')
                .where('seatNumber','==',seat)
                .orderBy('createdAt','desc').get();
  if (snap.empty) {
    document.getElementById('output').innerHTML = '<p>لا توجد نتائج لهذا الرقم!</p>';
    return;
  }
  const items = snap.docs.map(d => d.data());
  const latest = items[0];

  let html = `
    <h3>الاسم: ${latest.name} (رقم الجلوس: ${latest.seatNumber})</h3>
    <h4>أحدث نتيجة (${latest.month})</h4>
    <p>اختبار: ${latest.test || '-'} | واجب: ${latest.home || '-'} | مشاركة: ${latest.part || '-'} | سلوك: ${latest.beh || '-'} | مجموع: ${latest.total || '-'} | تقدير: ${latest.grade}</p>
    <h4>نتائج جميع الشهور:</h4>
    <table><thead><tr>
      <th>الشهر</th><th>اختبار</th><th>واجب</th><th>مشاركة</th><th>سلوك</th><th>المجموع</th><th>تقدير</th>
    </tr></thead><tbody>`;

  items.forEach(e => {
    const absentAll = e.test === 0 && e.home === 0 && e.part === 0 && e.beh === 0;
    const display = {
      test: e.test === 0 ? '-' : e.test,
      home: e.home === 0 ? '-' : e.home,
      part: e.part === 0 ? '-' : e.part,
      beh: e.beh === 0 ? '-' : e.beh,
      total: e.total === 0 ? '-' : e.total
    };
    let gradeText = '', css = '';
    if (absentAll) { gradeText = 'غياب'; css = 'grade-absent'; }
    else if (e.total === 40) { gradeText = 'ممتاز مع الشكر'; css = 'grade-top'; }
    else if (e.total >= 36) { gradeText = 'ممتاز'; css = 'grade-good'; }
    else { gradeText = 'نرجو من ولي الأمر متابعة الطالب وتشجيعه'; css = 'grade-encourage'; }

    html += `<tr class="${css}">
      <td>${e.month}</td><td>${display.test}</td><td>${display.home}</td>
      <td>${display.part}</td><td>${display.beh}</td><td>${display.total}</td><td>${gradeText}</td>
    </tr>`;
  });
  html += `</tbody></table>
    <button id="print-all-btn">تحميل الشهادة لجميع الشهور</button>`;
  document.getElementById('output').innerHTML = html;

  document.getElementById('print-all-btn').onclick = () => printAllPDF(latest, items);
}

function printAllPDF(latest, items) {
  const logo = 'SIN.PNG';
  let inner = `
    <div style="position:relative; padding:20px; text-align:center;">
      <img src="${logo}" style="width:80px; position:absolute; top:20px; right:20px;">
      <h1>معهد الدراسات الإدارية والفنية</h1>
      <h2>شهادة نتائج الطالب لجميع الشهور</h2>
      <p>الاسم: ${latest.name} | رقم الجلوس: ${latest.seatNumber}</p>
      <table style="width:100%; border-collapse:collapse; margin-top:20px;">
        <thead><tr><th>الشهر</th><th>اختبار</th><th>واجب</th><th>مشاركة</th><th>سلوك</th><th>المجموع</th><th>تقدير</th></tr></thead><tbody>`;

  items.forEach(e => {
    const absentAll = e.test === 0 && e.home === 0 && e.part === 0 && e.beh === 0;
    const display = {
      test: e.test === 0 ? '-' : e.test,
      home: e.home === 0 ? '-' : e.home,
      part: e.part === 0 ? '-' : e.part,
      beh: e.beh === 0 ? '-' : e.beh,
      total: e.total === 0 ? '-' : e.total
    };
    let gradeText = '';
    if (absentAll) gradeText = 'غياب';
    else if (e.total === 40) gradeText = 'ممتاز مع الشكر';
    else if (e.total >= 36) gradeText = 'ممتاز';
    else gradeText = 'نرجو من ولي الأمر متابعة الطالب وتشجيعه';

    inner += `<tr>
      <td>${e.month}</td>
      <td>${display.test}</td><td>${display.home}</td>
      <td>${display.part}</td><td>${display.beh}</td>
      <td>${display.total}</td><td>${gradeText}</td>
    </tr>`;
  });

  inner += `</tbody></table>
    <p style="margin-top:30px; text-align:left;">تحت إشراف: أولياء / أحمد حماد</p>
    <img src="${logo}" style="width:80px; margin-top:10px; text-align:left;">`;

  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>شهادة الطالب</title></head><body>${inner}</body></html>`);
  w.document.close(); w.focus(); w.print(); w.close();
}
</script>
</body>
</html>
