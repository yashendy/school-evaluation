<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    :root{ color-scheme: light; }
    body{ margin:0; font-family:'Segoe UI', Tahoma, Arial, sans-serif; background:#f5f7fa; color:#222; }
    .wrap{ max-width:980px; margin:24px auto; background:#fff; padding:20px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.06); }
    h2{ margin:0 0 6px; color:#0d6efd; }
    .muted{ color:#666; font-size:14px; }
    .row{ display:grid; grid-template-columns:repeat(2, minmax(220px,1fr)); gap:12px; margin-top:10px }
    .card{ background:#f8f9fa; border:1px solid #e9ecef; border-radius:10px; padding:14px; }
    .form{ display:flex; gap:8px; margin:12px 0 16px; align-items:center; flex-wrap:wrap }
    select, input[type=text]{ padding:10px 12px; border:1px solid #ced4da; border-radius:10px; font-size:15px; background:#fff }
    button{ padding:10px 14px; border:0; background:#0d6efd; color:#fff; border-radius:10px; cursor:pointer; }
    button.secondary{ background:#6c757d; }
    table{ width:100%; border-collapse:collapse; margin-top:8px }
    th,td{ border:1px solid #e9ecef; padding:10px; text-align:center; font-size:15px }
    th{ background:#f2f5f7; font-weight:700 }
    .center{ text-align:center }
    .pill{ display:inline-block; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#1d4ed8; font-size:13px }
    @media (max-width:640px){
      .row{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h2>
    <p class="muted">Ø§Ø¯Ø®Ù„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ù…Ø«Ù„: <code>student.html?seat=110001</code></p>

    <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³ (ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø¹Ø¯Ù… ØªÙˆÙØ± Ø¨Ø§Ø±Ø§Ù…ØªØ± seat) -->
    <div id="seat-form" class="form" style="display:none">
      <input id="seat-input" type="text" inputmode="numeric" placeholder="Ø§Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³ (Ù…Ø«Ø§Ù„: 110001)">
      <button id="go-seat">Ø¹Ø±Ø¶</button>
    </div>

    <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ (Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù… Ù…Ø¹Ù„Ù…) -->
    <div id="student-card" class="card" style="display:none">
      <div class="row">
        <div><b>Ø§Ù„Ø§Ø³Ù…:</b> <span id="st-name">â€”</span></div>
        <div><b>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³:</b> <span id="st-seat">â€”</span></div>
        <div><b>Ø§Ù„ÙØµÙ„:</b> <span id="st-class">â€”</span></div>
        <div><b>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ø¯ Ø§Ù„Ù…ÙÙ‚ÙŠÙ…Ø©:</b> <span id="st-subjects" class="pill">0</span></div>
      </div>
    </div>

    <!-- ÙÙ„Ø§ØªØ± Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ø¹Ø§Ù… + Ø²Ø± Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø§Ù„Ø¯Ø±Ø¬Ø§Øª -->
    <div id="filters" class="form" style="display:none">
      <label>Ø§Ù„Ø´Ù‡Ø±:</label>
      <select id="sel-month"></select>
      <label>Ø§Ù„Ø¹Ø§Ù…:</label>
      <select id="sel-year"></select>
      <button id="btn-apply" class="secondary">Ø¹Ø±Ø¶ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª</button>
      <span style="flex:1"></span>
      <button id="btn-print">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø´Ù‡Ø±</button>
    </div>

    <!-- Ø§Ù„Ø¯Ø±Ø¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ø¹Ø§Ù… -->
    <div id="eval-wrap" class="card" style="display:none; margin-top:12px">
      <h3 style="margin:0 0 8px;">Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h3>
      <table id="eval-table">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
            <th>Ø§Ø®ØªØ¨Ø§Ø± (10)</th>
            <th>ÙˆØ§Ø¬Ø¨ (10)</th>
            <th>Ù…Ø´Ø§Ø±ÙƒØ© (10)</th>
            <th>Ø³Ù„ÙˆÙƒ (10)</th>
            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (40)</th>
            <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <div id="no-data" class="center muted" style="display:none; padding:10px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¬Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.</div>
    </div>

    <div id="empty" class="center muted" style="display:none; margin-top:16px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</div>
  </div>

  <script>
    const db = firebase.firestore();

    // Ø´Ù‡ÙˆØ± Ù…Ø±ØªØ¨Ø© (Ù„Ù„Ø¹Ø±Ø¶ ÙˆØ§Ù„ÙØµÙ„)
    const MONTHS = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
    const monthIndex = (m)=> MONTHS.indexOf(m);

    // Ø­Ø§Ù„Ø© Ø¹Ø§Ù…Ø©
    let studentDocId = null;           // ID ÙˆØ«ÙŠÙ‚Ø© Ø§Ù„Ø·Ø§Ù„Ø¨
    let studentObj   = null;           // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
    let allEvals     = [];             // ÙƒÙ„ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨
    const teacherCache = new Map();    // teacherId -> {name, subject}

    function getParam(name){
      const p = new URLSearchParams(location.search);
      return p.get(name);
    }

    function showSeatForm(){
      document.getElementById('seat-form').style.display = 'flex';
      document.getElementById('student-card').style.display = 'none';
      document.getElementById('filters').style.display = 'none';
      document.getElementById('eval-wrap').style.display = 'none';
      document.getElementById('empty').style.display = 'none';
    }

    async function fetchTeacherMeta(teacherId){
      if (!teacherId) return { name:'â€”', subject:'â€”' };
      if (teacherCache.has(teacherId)) return teacherCache.get(teacherId);
      const u = await db.collection('users').doc(teacherId).get();
      const meta = u.exists ? { name: u.data().name || 'â€”', subject: u.data().subject || 'â€”' } : { name:'â€”', subject:'â€”' };
      teacherCache.set(teacherId, meta);
      return meta;
    }

    function evaluationLabel(total, test){
      const t = Number(total)||0;
      if (test===0) return 'ØºÙŠØ§Ø¨';
      if (t===40)   return 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±';
      if (t>=36)    return 'Ù…Ù…ØªØ§Ø²';
      return 'ÙŠØ±Ø¬Ù‰ ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ø·Ø§Ù„Ø¨';
    }

    function fillStudentCard(subjectCount){
      document.getElementById('st-name').textContent = studentObj.name || 'â€”';
      document.getElementById('st-seat').textContent = studentObj.seatNumber || 'â€”';

      // Ø§Ø³Ù… Ø§Ù„ÙØµÙ„
      const klass = studentObj._klassText || 'â€”';
      document.getElementById('st-class').textContent = klass;

      document.getElementById('st-subjects').textContent = String(subjectCount ?? 0);
      document.getElementById('student-card').style.display = 'block';
    }

    function buildFilters(){
      const years = Array.from(new Set(allEvals.map(e=>Number(e.year)).filter(Boolean))).sort((a,b)=>b-a);
      const months = Array.from(new Set(allEvals.map(e=>e.month).filter(Boolean)))
                          .sort((a,b)=>(monthIndex(b)-monthIndex(a)));

      const selYear  = document.getElementById('sel-year');
      const selMonth = document.getElementById('sel-month');
      selYear.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
      selMonth.innerHTML = months.map(m=>`<option value="${m}">${m}</option>`).join('');

      // Ø§Ø®ØªÙŠØ§Ø±Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ©: Ø£Ø­Ø¯Ø« Ø³Ù†Ø© ÙˆØ£Ø­Ø¯Ø« Ø´Ù‡Ø± ÙÙŠÙ‡Ø§ ØªÙ‚ÙŠÙŠÙ…Ø§Øª
      if (years.length) selYear.value = years[0];
      if (months.length) selMonth.value = months[0];

      document.getElementById('filters').style.display = (years.length && months.length) ? 'flex' : 'none';
    }

    async function renderForSelectedMonth(){
      const m = document.getElementById('sel-month').value;
      const y = Number(document.getElementById('sel-year').value);
      const tbody = document.querySelector('#eval-table tbody');
      tbody.innerHTML = '';
      document.getElementById('no-data').style.display = 'none';

      const filtered = allEvals.filter(e => e.month===m && Number(e.year)===y);
      if (!filtered.length){
        document.getElementById('eval-wrap').style.display = 'block';
        document.getElementById('no-data').style.display = 'block';
        fillStudentCard(0);
        return;
      }

      // Ø§Ø¬Ù…Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… (Ù…Ø§Ø¯Ø© Ù„ÙƒÙ„ Ù…Ø¹Ù„Ù‘Ù…)
      const rows = [];
      for (const e of filtered){
        const meta = await fetchTeacherMeta(e.teacher);
        rows.push({
          subject: meta.subject || 'â€”',
          test: Number(e.test)||0,
          home: Number(e.home)||0,
          part: Number(e.part)||0,
          beh : Number(e.beh)||0,
          total: Number(e.total)||0,
          eval: evaluationLabel(e.total, e.test)
        });
      }

      // Ø±ØªÙ‘Ø¨ Ø¨Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ (Ø§Ù„Ù…Ø§Ø¯Ø©)
      rows.sort((a,b)=> (a.subject||'').localeCompare(b.subject||'', 'ar'));

      // Ø¹Ø¨Ù‘ÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:right">${r.subject}</td>
          <td>${r.test===0?'Øº':r.test}</td>
          <td>${r.home}</td>
          <td>${r.part}</td>
          <td>${r.beh}</td>
          <td>${r.total}</td>
          <td>${r.eval}</td>`;
        tbody.appendChild(tr);
      });

      document.getElementById('eval-wrap').style.display = 'block';
      fillStudentCard(rows.length);
    }

    async function loadStudentBySeat(seat){
      // Ø§Ù„Ø·Ø§Ù„Ø¨
      const q = await db.collection('students').where('seatNumber','==', seat).limit(1).get();
      if (q.empty){
        document.getElementById('empty').textContent = 'Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³ ØºÙŠØ± ØµØ­ÙŠØ­.';
        document.getElementById('empty').style.display = 'block';
        document.getElementById('student-card').style.display = 'none';
        document.getElementById('filters').style.display = 'none';
        document.getElementById('eval-wrap').style.display = 'none';
        return;
      }
      const stDoc = q.docs[0];
      studentDocId = stDoc.id;
      studentObj   = stDoc.data();

      // Ø§Ø³Ù… Ø§Ù„ÙØµÙ„
      if (studentObj.classId){
        const c = await db.collection('classes').doc(studentObj.classId).get();
        if (c.exists){
          const d = c.data();
          studentObj._klassText = `${d.grade} - ${d.system} - ${d.section}`;
        }
      }

      // ÙƒÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
      const evalSnap = await db.collection('evaluations')
        .where('studentId','==', studentDocId)
        .get();

      allEvals = evalSnap.docs.map(d=>d.data());
      if (!allEvals.length){
        fillStudentCard(0);
        document.getElementById('filters').style.display = 'none';
        document.getElementById('eval-wrap').style.display = 'none';
        document.getElementById('empty').textContent = 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù…Ø³Ø¬Ù‘Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨.';
        document.getElementById('empty').style.display = 'block';
        return;
      }

      // Ø­Ø¶Ù‘Ø±ÙŠ Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ø¹Ø±Ø¶ Ø£Ø­Ø¯Ø« Ø´Ù‡Ø±/Ø¹Ø§Ù…
      buildFilters();
      await renderForSelectedMonth();
      document.getElementById('empty').style.display = 'none';
    }

    // Ø·Ø¨Ø§Ø¹Ø© ÙƒØ´Ù Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    async function printMonthlyReport(){
      const m = document.getElementById('sel-month').value;
      const y = Number(document.getElementById('sel-year').value);

      // Ø¬Ù‡Ù‘Ø² Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const rows = Array.from(document.querySelectorAll('#eval-table tbody tr'))
        .map(tr => Array.from(tr.children).map(td => td.textContent.trim()));

      const win = window.open('', '_blank');
      win.document.write(`
        <!DOCTYPE html><html lang="ar" dir="rtl"><head>
        <meta charset="utf-8">
        <title>ÙƒØ´Ù Ø¯Ø±Ø¬Ø§Øª - ${studentObj?.name || ''} - ${m} ${y}</title>
        <style>
          body{ font-family:'Segoe UI', Tahoma, Arial, sans-serif; padding:24px; color:#222 }
          h2{ margin:0 0 6px; }
          .muted{ color:#666 }
          table{ width:100%; border-collapse:collapse; margin-top:12px }
          th,td{ border:1px solid #ddd; padding:10px; text-align:center }
          th{ background:#f2f5f7 }
        </style>
        </head><body>
          <h2>ÙƒØ´Ù Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø´Ù‡Ø±</h2>
          <div class="muted">${studentObj?.name || ''} â€” Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³: ${studentObj?.seatNumber || ''}</div>
          <div class="muted">Ø§Ù„ÙØµÙ„: ${studentObj?._klassText || ''}</div>
          <div class="muted">Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ø¹Ø§Ù…: ${m} ${y}</div>

          <table>
            <thead>
              <tr><th>Ø§Ù„Ù…Ø§Ø¯Ø©</th><th>Ø§Ø®ØªØ¨Ø§Ø± (10)</th><th>ÙˆØ§Ø¬Ø¨ (10)</th><th>Ù…Ø´Ø§Ø±ÙƒØ© (10)</th><th>Ø³Ù„ÙˆÙƒ (10)</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (40)</th><th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th></tr>
            </thead>
            <tbody>
              ${rows.map(r=>`<tr>${r.map(c=>`<td>${c}</td>`).join('')}</tr>`).join('')}
            </tbody>
          </table>

          <script>setTimeout(()=>window.print(), 300);<\/script>
        </body></html>
      `);
      win.document.close();
    }

    // ØªØ´ØºÙŠÙ„
    window.addEventListener('load', () => {
      const seat = (getParam('seat') || '').trim();
      if (!seat){
        showSeatForm();
      }else{
        loadStudentBySeat(seat);
      }

      // Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³
      document.getElementById('go-seat').addEventListener('click', () => {
        const s = document.getElementById('seat-input').value.trim();
        if (!s) return alert('Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³');
        location.href = `student.html?seat=${encodeURIComponent(s)}`;
      });
      document.getElementById('seat-input').addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') document.getElementById('go-seat').click();
      });

      // Ø§Ù„ÙÙ„Ø§ØªØ±
      document.getElementById('btn-apply').addEventListener('click', renderForSelectedMonth);
      document.getElementById('btn-print').addEventListener('click', printMonthlyReport);
    });
  </script>
</body>
</html>
