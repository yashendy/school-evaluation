<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>نظام تقييم الطلاب</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    :root{ color-scheme: light; }
    body { margin:0; font-family:'Segoe UI', Tahoma, Arial, sans-serif; background:#f5f7fa; text-align:center; direction:rtl; padding:20px;}
    .container { background:#fff; max-width:500px; margin:auto; padding:30px; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,0.08);}
    img{ width:80px; margin-bottom:10px; }
    h2{ color:#0d6efd; margin:0 0 6px; font-weight:800; }
    h3{ margin:6px 0 2px; font-weight:700; color:#222 }
    p.lead{ margin:0 0 16px; color:#555 }

    .tabs{ display:flex; margin:18px 0 12px; gap:6px }
    .tab-btn{ flex:1; padding:10px; cursor:pointer; background:#e9ecef; border:1px solid #ced4da; border-radius:8px; font-weight:600; }
    .tab-btn.active{ background:#0d6efd; border-color:#0d6efd; color:#fff; }

    input[type=email], input[type=password], input[type=text], input[type=tel] {
      width:100%; padding:12px; margin:8px 0; border:1px solid #ced4da; border-radius:8px; font-size:16px; box-sizing:border-box;
    }
    .role-section{ display:flex; justify-content:space-between; align-items:center; gap:8px; margin:12px 0; }
    .radio-box{ flex:1; background:#f8f9fa; padding:10px; border:1px solid #e9ecef; border-radius:8px; }
    .divider{ width:2px; background:#dee2e6; align-self:stretch; border-radius:2px; }
    .form-button{ width:100%; padding:12px; background:#0d6efd; color:#fff; font-size:16px; border:none; border-radius:10px; cursor:pointer; margin-top:10px; }
    .form-button.secondary{ background:#6c757d; }
    .note{ margin-top:14px; font-size:13px; color:#6c757d;}
    .mini{ font-size:12px; color:#6c757d; margin-top:6px }

    .row{ display:grid; grid-template-columns:1fr; gap:8px }
    .hint{ font-size:12px; color:#6c757d; text-align:right; margin-top:-6px; }

    .inline-link{ margin-top:12px; display:block; color:#0d6efd; text-decoration:none; }
    .inline-link:hover{ text-decoration:underline; }
  </style>
</head>
<body>
  <div class="container">
    <img src="logo.png" alt="Logo">
    <h3>فكرة وتنفيذ: ياسر شندي</h3>
    <h2>معهد الدراسات الإدارية والفنية</h2>
    <p class="lead">نظام تقييم الطلاب</p>

    <div class="tabs">
      <button id="btn-login" class="tab-btn active" type="button">تسجيل الدخول</button>
      <button id="btn-register" class="tab-btn" type="button">إنشاء حساب</button>
    </div>

    <!-- تسجيل الدخول -->
    <div id="login-tab">
      <input type="email" id="login-email" placeholder="البريد الإلكتروني">
      <input type="password" id="login-password" placeholder="كلمة المرور">

      <!-- أدوار: معلم / إدارة -->
      <div class="role-section">
        <div class="radio-box"><label><input type="radio" name="login-type" value="teacher" checked> معلّم</label></div>
        <div class="divider"></div>
        <div class="radio-box"><label><input type="radio" name="login-type" value="admin"> الإدارة</label></div>
      </div>

      <button id="btn-login-action" class="form-button">تسجيل الدخول</button>

      <!-- تيسير للطلاب: إدخال رقم الجلوس لتوليد الرابط -->
      <a href="student.html" class="inline-link">الدخول كطالب برقم الجلوس</a>
      <p class="mini">الدخول للطالب يكون برابط مباشر: <code>student.html?seat=110001</code></p>
    </div>

    <!-- إنشاء حساب -->
    <div id="register-tab" style="display:none;">
      <div class="row">
        <input type="text" id="reg-name" placeholder="الاسم الكامل">
        <input type="email" id="reg-email" placeholder="البريد الإلكتروني">
        <input type="password" id="reg-password" placeholder="كلمة المرور">
        <input type="tel" id="reg-phone" placeholder="رقم الهاتف">
      </div>

      <!-- أدوار: معلم / إدارة -->
      <div class="role-section">
        <div class="radio-box"><label><input type="radio" name="reg-type" value="teacher" checked> معلّم</label></div>
        <div class="divider"></div>
        <div class="radio-box"><label><input type="radio" name="reg-type" value="admin"> الإدارة</label></div>
      </div>

      <!-- اسم المادة (يظهر فقط عندما الدور = معلم) -->
      <div id="subject-wrapper">
        <input type="text" id="reg-subject" placeholder="اسم المادة (مثال: التربية الإسلامية)">
        <div class="hint">حقل مطلوب عند تسجيل حساب معلّم.</div>
      </div>

      <!-- الجنس (اختياري معلوماتي) -->
      <div class="role-section">
        <div class="radio-box"><label><input type="radio" name="reg-gender" value="ذكر" checked> ذكر</label></div>
        <div class="divider"></div>
        <div class="radio-box"><label><input type="radio" name="reg-gender" value="أنثى"> أنثى</label></div>
      </div>

      <button id="btn-register-action" class="form-button">إنشاء الحساب</button>
      <button id="btn-back-to-login" class="form-button secondary" type="button">رجوع لتسجيل الدخول</button>
    </div>

    <p class="note">التعليم ليس فقط درجات، بل بناء أجيال.</p>
    <p>نسألكم الدعاء لوالدي</p>
  </div>

  <script>
    // تبويب/إظهار إخفاء
    function toggleTab(isLogin) {
      document.getElementById('login-tab').style.display = isLogin ? 'block' : 'none';
      document.getElementById('register-tab').style.display = isLogin ? 'none' : 'block';
      document.getElementById('btn-login').classList.toggle('active', isLogin);
      document.getElementById('btn-register').classList.toggle('active', !isLogin);
    }

    // إظهار/إخفاء حقل المادة على حسب الدور
    function updateSubjectVisibility(){
      const role = document.querySelector("input[name='reg-type']:checked").value;
      document.getElementById('subject-wrapper').style.display = (role === 'teacher') ? 'block' : 'none';
    }

    window.addEventListener('load', () => {
      // تفعيل التبويبات
      document.getElementById('btn-login').addEventListener('click', ()=>toggleTab(true));
      document.getElementById('btn-register').addEventListener('click', ()=>toggleTab(false));
      document.getElementById('btn-back-to-login').addEventListener('click', ()=>toggleTab(true));

      document.querySelectorAll("input[name='reg-type']").forEach(r=>r.addEventListener('change', updateSubjectVisibility));
      updateSubjectVisibility();

      // تسجيل الدخول
      document.getElementById('btn-login-action').onclick = async () => {
        const email = document.getElementById('login-email').value.trim();
        const password = document.getElementById('login-password').value;
        const role = document.querySelector("#login-tab input[name='login-type']:checked").value; // teacher | admin

        if (!email || !password) { alert('من فضلك أدخل البريد وكلمة المرور'); return; }

        try {
          const cred = await firebase.auth().signInWithEmailAndPassword(email, password);
          const doc = await firebase.firestore().collection('users').doc(cred.user.uid).get();
          const user = doc.data();

          if (!user) { alert('الحساب غير موجود في قاعدة البيانات'); return; }
          if (user.type !== role) {
            alert('نوع الدور المختار لا يطابق نوع الحساب.');
            return;
          }

          // تحويل حسب الدور
          if (role === 'teacher') {
            location.href = 'teacher.html';
          } else if (role === 'admin') {
            location.href = 'admin.html'; // جهّزي هذه الصفحة إن لم تكن موجودة
          }
        } catch(e) {
          alert('خطأ في تسجيل الدخول: ' + (e?.message || e));
        }
      };

      // إنشاء الحساب
      document.getElementById('btn-register-action').onclick = async () => {
        const name = document.getElementById('reg-name').value.trim();
        const email = document.getElementById('reg-email').value.trim();
        const pass = document.getElementById('reg-password').value;
        const phone = document.getElementById('reg-phone').value.trim();
        const role = document.querySelector("input[name='reg-type']:checked").value; // teacher | admin
        const gender = document.querySelector("input[name='reg-gender']:checked").value;
        const subject = document.getElementById('reg-subject').value.trim();

        if (!name || !email || !pass) { alert('من فضلك أكمل البيانات الأساسية'); return; }
        if (role === 'teacher' && !subject) { alert('اسم المادة مطلوب لحساب المعلّم'); return; }

        try {
          const cred = await firebase.auth().createUserWithEmailAndPassword(email, pass);
          await firebase.firestore().collection('users').doc(cred.user.uid).set({
            name, email, phone, gender,
            type: role,                        // teacher | admin
            subject: role === 'teacher' ? subject : null,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          alert('✔️ تم إنشاء الحساب بنجاح');
          toggleTab(true);
        } catch(e) {
          alert('خطأ في إنشاء الحساب: ' + (e?.message || e));
        }
      };
    });
  </script>
</body>
</html>
