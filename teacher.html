<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>لوحة تحكم المعلم</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { margin:0;font-family:'Segoe UI',sans-serif;background:#f4f6fa;direction:rtl; }
    .main-container { display:flex;min-height:100vh; }
    .sidebar { width:260px;background:#0288d1;color:#fff;padding:30px 20px;text-align:center; }
    .sidebar img { width:100px;margin-bottom:10px; }
    #teacher-name { font-size:22px;margin-bottom:30px; }
    .sidebar button{ width:100%;padding:12px;margin:8px 0;background:#fff;color:#0288d1;border:none;border-radius:6px;cursor:pointer; }
    .sidebar button:hover{ background:#cbefff; }
    .content { flex:1;padding:40px;font-size:18px;color:#333; }
    select,input { width:100%;padding:8px;margin:6px 0;font-size:16px;border:1px solid #ccc;border-radius:4px; }
    table { width:100%;border-collapse:collapse;margin-top:20px; }
    th,td { border:1px solid #ccc;padding:10px;text-align:center; }
    th { background:#eee; }
    .save-btn { background:#0288d1;color:#fff;border:none;padding:8px 16px;font-size:16px;border-radius:5px;cursor:pointer; }
    .delete-btn { background:transparent;color:red;font-weight:bold;cursor:pointer;border:none; }
    .grade-absent { background:#f0f0f0; }
    .grade-top { background:#d4edda; }
    .grade-good { background:#cce5ff; }
    .grade-encourage { background:#ffe5b4; }
  </style>
</head>
<body>
<div class="main-container">
  <aside class="sidebar">
    <img src="logo.png" alt="Logo">
    <h3 id="teacher-name">تحميل...</h3>
    <button data-section="classes">📘 الفصول</button>
    <button data-section="students">👨‍🎓 الطلاب</button>
    <button data-section="evaluation">📝 التقييمات</button>
    <button onclick="auth.signOut().then(()=>location.href='index.html')">🚪 تسجيل الخروج</button>
  </aside>
  <main class="content"><div id="main-content"></div></main>
</div>

<script>
const auth = firebase.auth();
const db = firebase.firestore();
let currentTeacherId = null;

auth.onAuthStateChanged(async user => {
  if (!user) return location.href = 'index.html';
  currentTeacherId = user.uid;
  const doc = await db.collection('users').doc(user.uid).get();
  document.getElementById('teacher-name').textContent = `أ. ${doc.data().name}`;
  document.querySelectorAll('.sidebar button[data-section]').forEach(btn =>
    btn.addEventListener('click', () => showSection(btn.dataset.section))
  );
  showSection('classes');
});

async function showSection(section) {
  const main = document.getElementById('main-content');
  if (section === 'evaluation') {
    main.innerHTML = `
      <h2>التقييمات</h2>
      <select id="eval-class-select"><option>اختر الفصل</option></select>
      <select id="exam-month"><option value="يناير">يناير</option><option value="فبراير">فبراير</option><option value="مايو">مايو</option></select>
      <button id="load-results-btn" class="save-btn">عرض النتائج</button>
      <div id="eval-container"></div>
      <button id="print-class-btn" class="save-btn" style="display:none;">طباعة شهادة الفصل</button>`;
    await loadEvalClasses();
    document.getElementById('load-results-btn').onclick = () => showEvaluationResults();
    document.getElementById('print-class-btn').onclick = () => {
      const className = document.getElementById('eval-class-select').selectedOptions[0].text;
      const month = document.getElementById('exam-month').value;
      printClassSheet(className, month);
    };
  } else {
    main.innerHTML = `<h2>قسم ${section}</h2><p>قريبًا...</p>`;
  }
}

async function loadEvalClasses() {
  const sel = document.getElementById('eval-class-select');
  sel.innerHTML = '';
  const snap = await db.collection('classes').where('teacher', '==', currentTeacherId).get();
  snap.forEach(d => {
    const o = document.createElement('option');
    o.value = d.id; o.textContent = d.data().name; sel.appendChild(o);
  });
}

async function showEvaluationResults() {
  const cid = document.getElementById('eval-class-select').value;
  const month = document.getElementById('exam-month').value;
  const snap = await db.collection('evaluations')
    .where('teacher','==',currentTeacherId)
    .where('classId','==',cid)
    .where('month','==',month)
    .orderBy('seatNumber')
    .get();
  const container = document.getElementById('eval-container');
  if (snap.empty) {
    container.innerHTML = '<p>لا توجد نتائج لهذا الشهر</p>';
    document.getElementById('print-class-btn').style.display = 'none';
    return;
  }
  document.getElementById('print-class-btn').style.display = 'block';
  let html = `<table><thead><tr>
    <th>الجلوس</th><th>الاسم</th><th>اختبار</th><th>واجب</th><th>مشاركة</th><th>سلوك</th><th>المجموع</th><th>تقدير</th>
  </tr></thead><tbody>`;
  snap.docs.forEach(doc => {
    const e = doc.data();
    const fields = ['test','home','part','beh'];
    const display = {};
    let total = e.total;
    let absentAll = true;
    fields.forEach(f => {
      if (e[f] === 0) display[f] = '-';
      else {
        display[f] = e[f];
        absentAll = false;
      }
    });
    if (e.total === 0) display.total = '-';
    else display.total = e.total;
    let gradeText = '', cssClass = '';
    if (absentAll) {
      gradeText = 'غياب'; cssClass = 'grade-absent';
    } else if (total === 40) {
      gradeText = 'ممتاز مع الشكر'; cssClass = 'grade-top';
    } else if (total >= 36) {
      gradeText = 'ممتاز'; cssClass = 'grade-good';
    } else {
      gradeText = 'نرجو من ولي الأمر متابعة الطالب وتشجيعه'; cssClass = 'grade-encourage';
    }
    html += `<tr class="${cssClass}">
      <td>${e.seatNumber}</td><td>${e.name}</td>
      <td>${display.test}</td><td>${display.home}</td><td>${display.part}</td><td>${display.beh}</td>
      <td>${display.total}</td><td>${gradeText}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}

async function printClassSheet(className, month) {
  const cid = document.getElementById('eval-class-select').value;
  const snap = await db.collection('evaluations')
    .where('teacher','==',currentTeacherId)
    .where('classId','==',cid)
    .where('month','==',month)
    .orderBy('seatNumber')
    .get();
  const data = snap.docs.map(d => d.data());
  const logo = 'SIN.PNG';
  let inner = `
    <div style="text-align:center; position: relative; padding: 20px;">
      <img src="${logo}" alt="Logo" style="width:80px; position:absolute; top:20px; right:20px;">
      <h1>معهد الدراسات الإدارية والفنية</h1>
      <h2>${className}</h2>
      <div style="display:flex; justify-content:space-between; margin-top:10px;">
        <div>الشهر: ${month}</div>
        <div>السنة: ${new Date().getFullYear()}</div>
      </div>
    </div>
    <table style="width:100%; border-collapse:collapse; margin-top:20px;">
      <thead><tr><th>الجلوس</th><th>الاسم</th><th>اختبار</th><th>واجب</th><th>مشاركة</th><th>سلوك</th><th>المجموع</th><th>تقدير</th></tr></thead>
      <tbody>`;
  data.forEach(e => {
    const fields = ['test','home','part','beh'];
    const display = {}; let absentAll = true;
    fields.forEach(f => {
      if (e[f] === 0) display[f] = '-'; else { display[f] = e[f]; absentAll = false; }
    });
    display.total = e.total === 0 ? '-' : e.total;
    let gradeText = '';
    if (absentAll) gradeText = 'غياب';
    else if (e.total === 40) gradeText = 'ممتاز مع الشكر';
    else if (e.total >= 36) gradeText = 'ممتاز';
    else gradeText = 'نرجو من ولي الأمر متابعة الطالب وتشجيعه';
    inner += `<tr>
      <td>${e.seatNumber}</td><td>${e.name}</td>
      <td>${display.test}</td><td>${display.home}</td><td>${display.part}</td><td>${display.beh}</td>
      <td>${display.total}</td><td>${gradeText}</td>
    </tr>`;
  });
  inner += `</tbody></table>
    <p style="margin-top:30px; text-align:left;">تحت إشراف: أولياء / أحمد حماد</p>
    <img src="${logo}" alt="ختم" style="width:80px; margin-top:10px;"/>`;

  const w = window.open('', '_blank');
  w.document.write(`<html><head><title>شهادة ${className} - ${month}</title></head><body>${inner}</body></html>`);
  w.document.close(); w.focus(); w.print(); w.close();
}
</script>
</body>
</html>
