<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase & jsPDF -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body { margin:0; padding:0; font-family: Arial, sans-serif; background:#f0f2f5; }
    .main-container { display:flex; min-height:100vh; }
    .sidebar { width:220px; background:#222; color:#fff; padding:20px; box-sizing:border-box; }
    .sidebar img { width:100%; margin-bottom:20px; }
    .sidebar h3 { margin:10px 0; font-size:18px; }
    .sidebar button { display:block; width:100%; padding:10px; margin-bottom:10px; background:#444; border:none; color:#fff; cursor:pointer; text-align:right; }
    .content { flex:1; background:#fff; padding:20px; box-sizing:border-box; }
    .save-btn, .delete-btn { padding:5px 10px; margin:5px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="main-container">
    <aside class="sidebar">
      <img src="logo.png" alt="Logo">
      <h3 id="teacher-name">ØªØ­Ù…ÙŠÙ„...</h3>
      <button data-sec="classes">ğŸ“˜ Ø§Ù„ÙØµÙˆÙ„</button>
      <button data-sec="students">ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      <button data-sec="tests">ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      <button onclick="window.location.href='evaluations.html'">ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
      <button onclick="auth.signOut().then(()=>location.href='index.html')">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </aside>
    <main class="content">
      <div id="main-content">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const auth = firebase.auth();
      const db = firebase.firestore();
      let currentTeacherId = null;

      auth.onAuthStateChanged(async user => {
        if (!user) return location.href = 'index.html';
        currentTeacherId = user.uid;
        const doc = await db.collection('users').doc(currentTeacherId).get();
        const data = doc.data();
        if (!data || data.type !== 'teacher') {
          alert('â— Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©');
          return auth.signOut().then(() => location.href = 'index.html');
        }
        document.getElementById('teacher-name').textContent = `Ø£. ${data.name}`;
        document.querySelectorAll('.sidebar button[data-sec]').forEach(btn =>
          btn.addEventListener('click', () => showSection(btn.dataset.sec))
        );
        showSection('classes');
      });

      async function showSection(sec) {
        const main = document.getElementById('main-content');
        if (!main) return console.error('main-content ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        main.innerHTML = '';

        if (sec === 'classes') {
          main.innerHTML = `
            <h2>ğŸ“˜ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„</h2>
            <div>
              <select id="c-grade"><option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option> ...</select>
              <select id="c-system"><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option></select>
              <select id="c-section"><option>A</option><option>B</option> ...</select>
              <button class="save-btn" onclick="addClass()">Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</button>
            </div>
            <table id="classes-table"><thead><tr><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ù†Ø¸Ø§Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ø®ØªÙŠØ§Ø±Ø§Øª</th></tr></thead><tbody></tbody></table>`;
          loadTeacherClasses();
        } else if (sec === 'students') {
          main.innerHTML = `
            <h2>ğŸ‘¨â€ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</h2>
            <div>... Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ...</div>
            <table id="students-table">...</table>`;
          loadClassDropdowns();
        } else if (sec === 'tests') {
          main.innerHTML = `
            <h2>ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h2>
            <div>... Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ...</div>
            <table id="eval-summary-table" style="display:none">...</table>`;
          loadEvalClasses();
        }
      }

  
  </script>
</body>
</html>

Â  Â  // âœ… Ø¥Ø¶Ø§ÙØ© ÙØµÙ„ Ø¬Ø¯ÙŠØ¯
async function addClass() {
Â  const grade = document.getElementById('c-grade').value;
Â  const system = document.getElementById('c-system').value;
Â  const section = document.getElementById('c-section').value;

Â  const existing = await db.collection('classes')
Â  Â  .where('teacher', '==', currentTeacherId)
Â  Â  .where('grade', '==', grade)
Â  Â  .where('system', '==', system)
Â  Â  .where('section', '==', section)
Â  Â  .get();

Â  if (\!existing.empty) {
Â  Â  alert('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ù…Ø¶Ø§Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹');
Â  Â  return;
Â  }

Â  await db.collection('classes').add({
Â  Â  grade,
Â  Â  system,
Â  Â  section,
Â  Â  teacher: currentTeacherId
Â  });

Â  alert('âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØµÙ„');
Â  loadTeacherClasses();
}

// âœ… ØªØ­Ù…ÙŠÙ„ ÙØµÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… ÙˆØ¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
async function loadTeacherClasses() {
Â  const tbody = document.querySelector('\#classes-table tbody');
Â  if (\!tbody) return;
Â  tbody.innerHTML = '';

Â  const snap = await db.collection('classes')
Â  Â  .where('teacher', '==', currentTeacherId)
Â  Â  .get();

Â  snap.forEach(doc =\> {
Â  Â  const d = doc.data();
Â  Â  tbody.innerHTML += `  Â  Â  Â  <tr> Â  Â  Â  Â  <td>${d.grade}</td> Â  Â  Â  Â  <td>${d.system}</td> Â  Â  Â  Â  <td>${d.section}</td> Â  Â  Â  Â  <td><button class="delete-btn" onclick="deleteClass('${doc.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td> Â  Â  Â  </tr> `;
Â  });
}

// âœ… Ø­Ø°Ù ÙØµÙ„
async function deleteClass(classId) {
Â  await db.collection('classes').doc(classId).delete();
Â  alert('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØµÙ„');
Â  loadTeacherClasses();
}

// âœ… Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
async function addStudent() {
Â  const g = document.getElementById('s-grade').value;
Â  const s = document.getElementById('s-system').value;
Â  const c = document.getElementById('s-section').value;
Â  const name = document.getElementById('s-name').value.trim();
Â  const gender = document.getElementById('s-gender').value;
Â  const religion = document.getElementById('s-religion').value;

Â  if (\!name || \!g || \!s || \!c || \!gender || \!religion) {
Â  Â  return alert('â— ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø·Ø§Ù„Ø¨');
Â  }

Â  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
Â  const duplicate = await db.collection('students')
Â  Â  .where('teacher', '==', currentTeacherId)
Â  Â  .where('name', '==', name)
Â  Â  .get();

Â  if (\!duplicate.empty) {
Â  Â  return alert('âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨');
Â  }

Â  const classSnap = await db.collection('classes')
Â  Â  .where('grade', '==', g)
Â  Â  .where('system', '==', s)
Â  Â  .where('section', '==', c)
Â  Â  .where('teacher', '==', currentTeacherId)
Â  Â  .get();

Â  if (classSnap.empty) {
Â  Â  return alert('âš ï¸ Ø¹ÙÙˆØ§... Ø£Ù†Øª Ù„Ù… ØªØ¯Ø±Ø³ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„');
Â  }

Â  const classId = classSnap.docs[0].id;
Â  const seat = await generateSeat(gender, religion, classId);

Â  await db.collection('students').add({
Â  Â  name, gender, religion,
Â  Â  seatNumber: seat,
Â  Â  classId,
Â  Â  teacher: currentTeacherId
Â  });

Â  alert(`âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ ${name} Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³: ${seat}`);
Â  displayStudents(classId);
}

// âœ… ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³
async function generateSeat(gender, religion, classId) {
Â  const snap = await db.collection('students').where('classId','==',classId).get();
Â  const count = snap.size + 1;
Â  const codeG = gender === 'male' ? '1' : '2';
Â  const codeR = religion === 'muslim' ? '1' : '2';
Â  return codeG + codeR + String(count).padStart(4, '0');
}

// âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©
async function loadClassDropdowns() {
Â  const grades = document.getElementById('s-grade');
Â  grades.innerHTML = `  Â  Â  <option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option> Â  Â  <option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option> Â  Â  <option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option> Â  Â  <option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option> Â  Â  <option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option> Â  Â  <option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option> `;

Â  const systems = document.getElementById('s-system');
Â  systems.innerHTML = `<option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option>`;

Â  const sections = document.getElementById('s-section');
Â  sections.innerHTML = `<option>A</option><option>B</option><option>C</option><option>D</option>`;

Â  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).limit(1).get();
Â  if (\!snap.empty) {
Â  Â  const classId = snap.docs[0].id;
Â  Â  displayStudents(classId);
Â  }
}

// âœ… Ø¹Ø±Ø¶ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯
async function displayStudents(classId) {
Â  const tbody = document.querySelector('\#students-table tbody');
Â  if (\!tbody) return;
Â  tbody.innerHTML = '';

Â  const snap = await db.collection('students')
Â  Â  .where('classId', '==', classId)
Â  Â  .orderBy('seatNumber')
Â  Â  .get();

Â  snap.forEach(doc =\> {
Â  Â  const d = doc.data();
Â  Â  tbody.innerHTML += `  Â  Â  Â  <tr> Â  Â  Â  Â  <td>${d.name}</td> Â  Â  Â  Â  <td>${d.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰'}</td> Â  Â  Â  Â  <td>${d.religion === 'muslim' ? 'Ù…Ø³Ù„Ù…' : 'Ù…Ø³ÙŠØ­ÙŠ'}</td> Â  Â  Â  Â  <td>${d.seatNumber}</td> Â  Â  Â  </tr> `;
Â  });
}

// âœ… Ø²Ø± "Ø¹Ø±Ø¶ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„"
async function loadStudentList() {
Â  const g = document.getElementById('s-grade').value;
Â  const s = document.getElementById('s-system').value;
Â  const c = document.getElementById('s-section').value;

Â  const snap = await db.collection('classes')
Â  Â  .where('grade', '==', g)
Â  Â  .where('system', '==', s)
Â  Â  .where('section', '==', c)
Â  Â  .where('teacher', '==', currentTeacherId)
Â  Â  .get();

Â  if (snap.empty) {
Â  Â  alert('âš ï¸ Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
Â  Â  return;
Â  }

Â  const classId = snap.docs[0].id;
Â  displayStudents(classId);

Â  // ØªØ¹Ø¨Ø¦Ø© datalist Ù„Ù„Ø¨Ø­Ø«
Â  const list = document.getElementById('students-list');
Â  list.innerHTML = '';
Â  const studentsSnap = await db.collection('students').where('classId', '==', classId).get();

Â  studentsSnap.forEach(doc =\> {
Â  Â  const d = doc.data();
Â  Â  const opt = document.createElement('option');
Â  Â  opt.value = d.name;
Â  Â  list.appendChild(opt);
Â  });
}

// ØªØ­Ù…ÙŠÙ„ ÙØµÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… Ù„Ù‚Ø§Ø¦Ù…Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
async function loadEvalClasses() {
Â  const sel = document.getElementById('eval-class');
Â  sel.innerHTML = '';

Â  const snap = await db.collection('classes')
Â  Â  .where('teacher', '==', currentTeacherId)
Â  Â  .get();

Â  snap.forEach(doc =\> {
Â  Â  const d = doc.data();
Â  Â  const opt = document.createElement('option');
Â  Â  opt.value = doc.id;
Â  Â  opt.textContent = `${d.grade} - ${d.system} - ${d.section}`;
Â  Â  sel.appendChild(opt);
Â  });

Â  if (snap.docs.length \> 0) {
Â  Â  loadEvalStudents();
Â  }
}

// ØªØ­Ù…ÙŠÙ„ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø®ØªØ§Ø±
async function loadEvalStudents() {
Â  const classId = document.getElementById('eval-class').value;
Â  const sel = document.getElementById('eval-student');
Â  sel.innerHTML = '';

Â  const snap = await db.collection('students')
Â  Â  .where('classId', '==', classId)
Â  Â  .orderBy('seatNumber')
Â  Â  .get();

Â  snap.forEach(doc =\> {
Â  Â  const d = doc.data();
Â  Â  const opt = document.createElement('option');
Â  Â  opt.value = doc.id;
Â  Â  opt.textContent = d.name;
Â  Â  sel.appendChild(opt);
Â  });

Â  updateStudentName();
}

// Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ù…Ø­Ø¯Ø¯
async function updateStudentName() {
Â  const studentId = document.getElementById('eval-student').value;
Â  const span = document.getElementById('stu-name');
Â  if (\!studentId) return span.textContent = '';
Â  const doc = await db.collection('students').doc(studentId).get();
Â  if (doc.exists) span.textContent = doc.data().name;
}

// Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù„Ø·Ø§Ù„Ø¨
async function submitEvaluation() {
Â  const classId = document.getElementById('eval-class').value;
Â  const studentId = document.getElementById('eval-student').value;
Â  const month = document.getElementById('eval-month').value;
Â  const year = new Date().getFullYear();

Â  const test = parseInt(document.getElementById('input-test').value) || 0;
Â  const home = parseInt(document.getElementById('input-home').value) || 0;
Â  const part = parseInt(document.getElementById('input-part').value) || 0;
Â  const beh = parseInt(document.getElementById('input-beh').value) || 0;
Â  const total = test + home + part + beh;

Â  if (\!studentId || \!classId || \!month) return alert('âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ ÙˆØ§Ù„Ø·Ø§Ù„Ø¨ ÙˆØ§Ù„Ø´Ù‡Ø±');

Â  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø±
Â  const check = await db.collection('evaluations')
Â  Â  .where('classId', '==', classId)
Â  Â  .where('studentId', '==', studentId)
Â  Â  .where('month', '==', month)
Â  Â  .get();

Â  if (\!check.empty) {
Â  Â  return alert('âš ï¸ ØªÙ… ØªÙ‚ÙŠÙŠÙ… Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ù…Ø³Ø¨Ù‚Ø§Ù‹');
Â  }

Â  const studentDoc = await db.collection('students').doc(studentId).get();
Â  const name = studentDoc.exists ? studentDoc.data().name : 'Ø·Ø§Ù„Ø¨';

Â  await db.collection('evaluations').add({
Â  Â  classId,
Â  Â  studentId,
Â  Â  teacher: currentTeacherId,
Â  Â  name,
Â  Â  test,
Â  Â  home,
Â  Â  part,
Â  Â  beh,
Â  Â  total,
Â  Â  month,
Â  Â  year
Â  });

Â  alert('âœ”ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­');
Â  showEvaluationSummary();
}

// Ø¹Ø±Ø¶ Ù…Ù„Ø®Øµ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø³ÙÙ„ Ø§Ù„ØµÙØ­Ø©
async function showEvaluationSummary() {
Â  const classId = document.getElementById('eval-class').value;
Â  const month = document.getElementById('eval-month').value;

Â  const table = document.getElementById('eval-summary-table');
Â  const tbody = table.querySelector('tbody');
Â  tbody.innerHTML = '';

Â  const snap = await db.collection('evaluations')
Â  Â  .where('classId', '==', classId)
Â  Â  .where('month', '==', month)
Â  Â  .get();

Â  if (snap.empty) {
Â  Â  table.style.display = 'none';
Â  Â  return;
Â  }

Â  snap.forEach(doc =\> {
Â  Â  const d = doc.data();
Â  Â  const row = `<tr> Â  Â  Â  <td>${d.name}</td> Â  Â  Â  <td>${d.test}</td> Â  Â  Â  <td>${d.home}</td> Â  Â  Â  <td>${d.part}</td> Â  Â  Â  <td>${d.beh}</td> Â  Â  Â  <td>${d.total}</td> Â  Â  </tr>`;
Â  Â  tbody.innerHTML += row;
Â  });

Â  table.style.display = '';
}
  });
Â  \</script\>Â 

\</body\>
\</html\>



