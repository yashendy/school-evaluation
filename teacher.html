<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- SheetJS Ù„Ù‚Ø±Ø§Ø¡Ø©/ØªÙˆÙ„ÙŠØ¯ Ù…Ù„ÙØ§Øª Ø¥ÙƒØ³Ù„ -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    body { margin:0; padding:0; font-family: Arial, sans-serif; background:#f0f2f5; }
    .main-container { display:flex; min-height:100vh; }
    .sidebar { width:220px; background:#add8e6; color:#fff; padding:20px; box-sizing:border-box; }
    .sidebar img { width:100%; margin-bottom:20px; }
    .sidebar h3 { margin:10px 0; font-size:18px; color:#002b36; }
    .sidebar button { display:block; width:100%; padding:10px; margin-bottom:10px; background:#444; border:none; color:#fff; cursor:pointer; text-align:right; border-radius:6px; }
    .content { flex:1; background:#fff; padding:20px; box-sizing:border-box; }
    .save-btn, .delete-btn { padding:6px 10px; margin:5px; cursor:pointer; border-radius:6px; border:1px solid #ccc; background:#f7f7f7; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { border:1px solid #dfe3e7; padding:8px; text-align:center; }
    th { background:#f2f5f7; }
    input, select { padding:8px; border:1px solid #d0d7de; border-radius:6px; }
    .row { display:grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap:10px; align-items:center; margin:8px 0; }
    .muted { color:#666; font-size:13px; margin-top:6px; }

    /* Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
    .form-grid{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:10px 12px;
      align-items:center;
      max-width:720px;
    }
    .form-grid label{ justify-self:end; color:#222; }
    .form-grid input,.form-grid select{ width:100%; padding:8px; border:1px solid #d0d7de; border-radius:6px; }
    .form-grid .full{ grid-column:1 / -1; }

    .btn-cert{ background:#2e7d32; color:#fff; border:0; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .btn-cert[disabled]{opacity:.35; cursor:not-allowed}
  </style>
</head>
<body>
  <div class="main-container">
    <aside class="sidebar">
      <img src="logo.png" alt="Logo">
      <h3 id="teacher-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
      <button data-sec="classes">ğŸ“˜ Ø§Ù„ÙØµÙˆÙ„</button>
      <button data-sec="students">ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      <button data-sec="tests">ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      <button onclick="window.location.href='evaluations.html'">ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
      <button onclick="auth.signOut().then(()=>location.href='index.html')">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </aside>

    <main class="content">
      <div id="main-content">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³ =====
      const RUN_WIDTH = 5; // Ø¹Ø¯Ù‘Ø§Ø¯ Ø¹Ø§Ù… 5 Ø®Ø§Ù†Ø§Øª
      const GENDER_CODE   = { male: '1', female: '2' }; // Ø°ÙƒØ±=1ØŒ Ø£Ù†Ø«Ù‰=2
      const RELIGION_CODE = { muslim: '1', christian: '2' }; // Ù…Ø³Ù„Ù…=1ØŒ Ù…Ø³ÙŠØ­ÙŠ=2

      // Ø§Ø³Ù… ØµÙØ­Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
      const CERT_PAGE = 'certificate.html';

      // Firebase
      window.auth = firebase.auth();
      const db = firebase.firestore();

      let currentTeacherId = null;
      let currentTeacherName = '';

      /* ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù…Ø¹Ù„Ù… */
      auth.onAuthStateChanged(async (user) => {
        if (!user) { location.href = 'index.html'; return; }
        currentTeacherId = user.uid;

        const userDoc = await db.collection('users').doc(currentTeacherId).get();
        const data = userDoc.data();
        if (!data || data.type !== 'teacher') {
          alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„');
          await auth.signOut();
          location.href = 'index.html';
          return;
        }

        currentTeacherName = data.name || '';
        document.getElementById('teacher-name').textContent = `Ø£. ${currentTeacherName}`;
        document.querySelectorAll('.sidebar button[data-sec]').forEach((btn) => {
          btn.addEventListener('click', () => showSection(btn.dataset.sec));
        });

        showSection('classes');
      });

      /* ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
      function showSection(sec) {
        const main = document.getElementById('main-content');
        main.innerHTML = '';

        /* ---- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„ ---- */
        if (sec === 'classes') {
          main.innerHTML = `
            <h2>ğŸ“˜ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„</h2>
            <div class="row">
              <select id="c-grade">
                <option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
                <option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
              </select>
              <select id="c-system"><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option></select>
              <select id="c-section"><option>A</option><option>B</option><option>C</option><option>D</option></select>
              <button class="save-btn" id="btn-add-class">Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</button>
            </div>
            <table id="classes-table">
              <thead><tr><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ù†Ø¸Ø§Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
              <tbody></tbody>
            </table>
          `;
          requestAnimationFrame(() => {
            document.getElementById('btn-add-class').addEventListener('click', addClass);
            loadTeacherClasses();
          });
          return;
        }

        /* ---- Ø§Ù„Ø·Ù„Ø§Ø¨ ---- */
        if (sec === 'students') {
          main.innerHTML = `
            <h2>ğŸ‘¨â€ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</h2>
            <div class="row">
              <select id="s-grade"></select>
              <select id="s-system"></select>
              <select id="s-section"></select>
              <input id="s-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" />
              <select id="s-gender"><option value="male">Ø°ÙƒØ±</option><option value="female">Ø£Ù†Ø«Ù‰</option></select>
              <select id="s-religion"><option value="muslim">Ù…Ø³Ù„Ù…</option><option value="christian">Ù…Ø³ÙŠØ­ÙŠ</option></select>
              <button class="save-btn" id="btn-add-student">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
              <button class="save-btn" id="btn-load-students">Ø¹Ø±Ø¶ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„</button>

              <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ± -->
              <button class="save-btn" id="btn-import-excel">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„</button>
              <button class="save-btn" id="btn-download-template">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨ (XLSX)</button>
              <button class="save-btn" id="btn-export-class">â¬‡ï¸ ØªØµØ¯ÙŠØ± Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„ (XLSX)</button>
              <input type="file" id="excel-file" accept=".xlsx,.xls,.csv" style="display:none" />

              <input type="search" id="student-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." list="students-list" />
              <datalist id="students-list"></datalist>
            </div>
            <div class="muted">ØµÙŠØºØ© Ø§Ù„Ù‚Ø§Ù„Ø¨: <b>Ø§Ù„Ø§Ø³Ù… | Ø§Ù„Ø¬Ù†Ø³ | Ø§Ù„Ø¯ÙŠØ§Ù†Ø©</b> (Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠ). Ø§Ù„Ù‚ÙŠÙ…: Ø§Ù„Ø¬Ù†Ø³ = Ø°ÙƒØ±/Ø£Ù†Ø«Ù‰ØŒ Ø§Ù„Ø¯ÙŠØ§Ù†Ø© = Ù…Ø³Ù„Ù…/Ù…Ø³ÙŠØ­ÙŠ.
              <br>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³ ÙŠÙÙ†Ø´Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: [Ø¬Ù†Ø³][Ø¯ÙŠØ§Ù†Ø©][${RUN_WIDTH} Ø®Ø§Ù†Ø§Øª Ù…ØªØ³Ù„Ø³Ù„Ø© Ø¹Ø§Ù…Ø©].
            </div>

            <h3>ğŸ“‹ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„</h3>
            <table id="students-table">
              <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø§Ù„Ø¯ÙŠØ§Ù†Ø©</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</th></tr></thead>
              <tbody></tbody>
            </table>
          `;
          requestAnimationFrame(() => {
            document.getElementById('btn-add-student').addEventListener('click', addStudent);
            document.getElementById('btn-load-students').addEventListener('click', loadStudentList);

            document.getElementById('btn-import-excel').addEventListener('click', () => document.getElementById('excel-file').click());
            document.getElementById('excel-file').addEventListener('change', handleExcelFileSelect);

            document.getElementById('btn-download-template').addEventListener('click', downloadExcelTemplate);
            document.getElementById('btn-export-class').addEventListener('click', exportCurrentClassStudents);

            loadClassDropdowns();
          });
          return;
        }

        /* ---- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ---- */
        if (sec === 'tests') {
          main.innerHTML = `
            <h2>ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h2>
            <div class="form-grid" id="eval-form">
              <label>Ø§Ù„Ø´Ù‡Ø±:</label>
              <select id="eval-month">
                ${["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"].map(m => `<option>${m}</option>`).join('')}
              </select>

              <label>Ø§Ù„ÙØµÙ„:</label>
              <select id="eval-class"></select>

              <label>Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
              <select id="eval-student"></select>

              <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
              <div id="stu-name" class="muted" style="text-align:right"></div>

              <label>Ø§Ø®ØªØ¨Ø§Ø± (0-10):</label>
              <input type="number" id="input-test" min="0" max="10" />

              <label>ÙˆØ§Ø¬Ø¨ (0-10):</label>
              <input type="number" id="input-home" min="0" max="10" />

              <label>Ù…Ø´Ø§Ø±ÙƒØ© (0-10):</label>
              <input type="number" id="input-part" min="0" max="10" />

              <label>Ø³Ù„ÙˆÙƒ (0-10):</label>
              <input type="number" id="input-beh" value="10" min="0" max="10" />

              <div class="full" style="margin-top:8px">
                <button class="save-btn" id="btn-save-eval" style="width:100%">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
              </div>
            </div>

            <h3 style="margin-top:16px">âœ… ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù‡Ø¤Ù„Ø§Ø¡ Ø§Ù„Ø·Ù„Ø§Ø¨ (Ù„Ù„ÙØµÙ„/Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†)</h3>
            <table id="eval-summary-table" style="width:100%; margin-top:8px; display:none;">
              <thead>
                <tr>
                  <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ø®ØªØ¨Ø§Ø±</th><th>ÙˆØ§Ø¬Ø¨</th><th>Ù…Ø´Ø§Ø±ÙƒØ©</th>
                  <th>Ø³Ù„ÙˆÙƒ</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th><th>Ø´Ù‡Ø§Ø¯Ø©</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          `;
          requestAnimationFrame(() => {
            loadEvalClasses();
            document.getElementById('eval-class').addEventListener('change', async () => {
              await loadEvalStudents();
              await showEvaluationSummary();
            });
            document.getElementById('eval-month').addEventListener('change', showEvaluationSummary);
            document.getElementById('eval-student').addEventListener('change', updateStudentName);
            document.getElementById('btn-save-eval').addEventListener('click', submitEvaluation);
          });
          return;
        }
      }

      /* ====== CLASSES ====== */
      async function addClass() {
        const grade = document.getElementById('c-grade').value;
        const system = document.getElementById('c-system').value;
        const section = document.getElementById('c-section').value;

        const existing = await db.collection('classes')
          .where('teacher','==',currentTeacherId)
          .where('grade','==',grade)
          .where('system','==',system)
          .where('section','==',section)
          .get();

        if (!existing.empty) { alert('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ù…Ø¶Ø§Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹'); return; }
        await db.collection('classes').add({ grade, system, section, teacher: currentTeacherId });
        loadTeacherClasses();
      }

      async function loadTeacherClasses() {
        const tbody = document.querySelector('#classes-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
        snap.forEach((doc) => {
          const d = doc.data();
          tbody.innerHTML += `<tr><td>${d.grade}</td><td>${d.system}</td><td>${d.section}</td><td><button class="delete-btn" onclick="deleteClass('${doc.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td></tr>`;
        });
      }

      async function deleteClass(classId) {
        await db.collection('classes').doc(classId).delete();
        loadTeacherClasses();
      }

      /* ====== Ø¹Ø¯Ù‘Ø§Ø¯ Ø¹Ø§Ù… Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬Ù„ÙˆØ³ ====== */
      async function ensureStudentsCounterDoc() {
        const ref = db.collection('counters').doc('students');
        const snap = await ref.get();
        if (!snap.exists) {
          await ref.set({ next: 0 }, { merge: true });
        }
        return ref;
      }

      async function allocateRunNumbers(count) {
        if (count <= 0) return [];
        const ref = await ensureStudentsCounterDoc();

        const block = await db.runTransaction(async (tx) => {
          const snap = await tx.get(ref);
          const data = snap.data() || { next: 0 };
          const start = Number(data.next) || 0;
          const newNext = start + count;
          tx.update(ref, { next: newNext });

          const pad = (n) => String(n).padStart(RUN_WIDTH, '0');
          return Array.from({ length: count }, (_, i) => pad(start + i + 1));
        });

        return block;
      }

      function buildSeatNumber(gender, religion, runStr) {
        const g = GENDER_CODE[gender] ?? '0';
        const r = RELIGION_CODE[religion] ?? '0';
        return `${g}${r}${runStr}`;
      }

      /* ====== STUDENTS ====== */
      async function addStudent() {
        const g = document.getElementById('s-grade').value;
        const s = document.getElementById('s-system').value;
        const c = document.getElementById('s-section').value;
        const name = document.getElementById('s-name').value.trim();
        const gender = document.getElementById('s-gender').value;
        const religion = document.getElementById('s-religion').value;

        if (!name||!g||!s||!c||!gender||!religion) { alert('â— ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }

        const duplicate = await db.collection('students')
          .where('teacher','==',currentTeacherId).where('name','==',name).get();
        if (!duplicate.empty) { alert('âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹'); return; }

        const classSnap = await db.collection('classes')
          .where('grade','==',g).where('system','==',s).where('section','==',c).where('teacher','==',currentTeacherId).get();
        if (classSnap.empty) { alert('âš ï¸ Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }

        const classId = classSnap.docs[0].id;

        const [runStr] = await allocateRunNumbers(1);
        const seatNumber = buildSeatNumber(gender, religion, runStr);

        await db.collection('students').add({
          name, gender, religion,
          seatNumber,
          classId, teacher: currentTeacherId
        });

        displayStudents(classId);
        alert('âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ®ØµÙŠØµ Ø±Ù‚Ù… Ø¬Ù„ÙˆØ³ ÙØ±ÙŠØ¯');
        document.getElementById('s-name').value = '';
      }

      async function loadClassDropdowns() {
        document.getElementById('s-grade').innerHTML = `<option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>`;
        document.getElementById('s-system').innerHTML = `<option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option>`;
        document.getElementById('s-section').innerHTML = `<option>A</option><option>B</option><option>C</option><option>D</option>`;
        const snap = await db.collection('classes').where('teacher','==',currentTeacherId).limit(1).get();
        if (!snap.empty) displayStudents(snap.docs[0].id);
      }

      async function loadStudentList() {
        const g = document.getElementById('s-grade').value;
        const s = document.getElementById('s-system').value;
        const c = document.getElementById('s-section').value;
        const snap = await db.collection('classes')
          .where('grade','==',g).where('system','==',s).where('section','==',c).where('teacher','==',currentTeacherId).get();
        if (snap.empty) { alert('âš ï¸ Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
        const classId = snap.docs[0].id;
        displayStudents(classId);

        const list = document.getElementById('students-list');
        list.innerHTML = '';
        const studentsSnap = await db.collection('students').where('classId','==',classId).orderBy('seatNumber').get();
        studentsSnap.forEach((doc) => {
          const opt = document.createElement('option');
          opt.value = doc.data().name;
          list.appendChild(opt);
        });
      }

      async function displayStudents(classId) {
        const tbody = document.querySelector('#students-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const snap = await db.collection('students').where('classId','==',classId).orderBy('seatNumber').get();
        snap.forEach((doc) => {
          const d = doc.data();
          tbody.innerHTML += `<tr><td style="text-align:right">${d.name}</td><td>${d.gender==='male'?'Ø°ÙƒØ±':'Ø£Ù†Ø«Ù‰'}</td><td>${d.religion==='muslim'?'Ù…Ø³Ù„Ù…':'Ù…Ø³ÙŠØ­ÙŠ'}</td><td>${d.seatNumber}</td></tr>`;
        });
      }

      // Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù Ø¥ÙƒØ³Ù„/CSV
      function readExcelFile(file){
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (evt) => {
            try{
              const data = new Uint8Array(evt.target.result);
              const wb = XLSX.read(data, { type:'array' });
              const ws = wb.Sheets[wb.SheetNames[0]];
              const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
              resolve(json);
            }catch(e){ reject(e); }
          };
          reader.onerror = reject;
          reader.readAsArrayBuffer(file);
        });
      }

      /* ğŸ”½ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙƒÙ€ XLSX (Ø¨Ø¯ÙˆÙ† Ù…Ø´Ø§ÙƒÙ„ ØªØ±Ù…ÙŠØ²) */
      function downloadExcelTemplate(){
        const headers = ['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ø¬Ù†Ø³','Ø§Ù„Ø¯ÙŠØ§Ù†Ø©'];
        const sample  = [
          ['Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯','Ø°ÙƒØ±','Ù…Ø³Ù„Ù…'],
          ['Ù…Ø±ÙŠÙ… Ø³Ø§Ù…ÙŠ','Ø£Ù†Ø«Ù‰','Ù…Ø³ÙŠØ­ÙŠ']
        ];
        const aoa = [headers, ...sample];
        const ws  = XLSX.utils.aoa_to_sheet(aoa);
        ws['!cols'] = [{wch:25},{wch:10},{wch:12}];
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Ø§Ù„Ø·Ù„Ø§Ø¨');
        XLSX.writeFile(wb, 'Ù‚Ø§Ù„Ø¨_Ø§Ù„Ø·Ù„Ø§Ø¨.xlsx');
      }

      // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ÙØµÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ù†Øµ ÙˆÙ…Ø¹Ø±Ù)
      async function getSelectedClassWithLabel() {
        const g = document.getElementById('s-grade').value;
        const s = document.getElementById('s-system').value;
        const c = document.getElementById('s-section').value;

        const snap = await db.collection('classes')
          .where('grade','==',g).where('system','==',s).where('section','==',c)
          .where('teacher','==',currentTeacherId).get();

        if (snap.empty) return { classId: null, label: `${g} - ${s} - ${c}` };

        const doc = snap.docs[0];
        const d = doc.data();
        return { classId: doc.id, label: `${d.grade} - ${d.system} - ${d.section}` };
      }

      // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù…Ù† Ø¥ÙƒØ³Ù„
      async function handleExcelFileSelect(e){
        const file = e.target.files?.[0];
        if (!file) return;

        const { classId, label } = await getSelectedClassWithLabel();
        if (!classId) { alert('âš ï¸ Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¶ÙÙ Ø§Ù„ÙØµÙ„ Ø£ÙˆÙ„Ù‹Ø§ Ø£Ùˆ Ø§Ø®ØªØ± ÙØµÙ„Ù‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§.'); e.target.value=''; return; }

        try {
          const rows = await readExcelFile(file);
          if (!rows.length) { alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù'); e.target.value=''; return; }

          const normalized = [];
          const errors = [];

          rows.forEach((r, idx) => {
            const name = r['Ø§Ù„Ø§Ø³Ù…'] ?? r['Name'] ?? r['name'] ?? '';
            const genderText = (r['Ø§Ù„Ø¬Ù†Ø³'] ?? r['Gender'] ?? r['gender'] ?? '').toString().trim();
            const religionText = (r['Ø§Ù„Ø¯ÙŠØ§Ù†Ø©'] ?? r['Religion'] ?? r['religion'] ?? '').toString().trim();

            if (!name || !genderText || !religionText) {
              errors.push(`Ø§Ù„Ø³Ø·Ø± ${idx+2}: Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©`);
              return;
            }

            const gmap = { 'Ø°ÙƒØ±':'male','Ø£Ù†Ø«Ù‰':'female','male':'male','female':'female','Ø§Ù†Ø«Ù‰':'female' };
            const rmap = { 'Ù…Ø³Ù„Ù…':'muslim','Ù…Ø³ÙŠØ­ÙŠ':'christian','muslim':'muslim','christian':'christian' };

            const gender = gmap[genderText] || null;
            const religion = rmap[religionText] || null;

            if (!gender) errors.push(`Ø§Ù„Ø³Ø·Ø± ${idx+2}: Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ù†Ø³ ØºÙŠØ± ØµØ­ÙŠØ­Ø© (${genderText})`);
            if (!religion) errors.push(`Ø§Ù„Ø³Ø·Ø± ${idx+2}: Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙŠØ§Ù†Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© (${religionText})`);

            if (gender && religion) {
              normalized.push({ name: String(name).trim(), gender, religion });
            }
          });

          if (errors.length) {
            alert('âš ï¸ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù…Ù„Ù:\n' + errors.join('\n'));
            if (!normalized.length) { e.target.value=''; return; }
          }

          if (!confirm(`Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© ${normalized.length} Ø·Ø§Ù„Ø¨/Ø·Ø§Ù„Ø¨Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙØµÙ„: [ ${label} ]\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ`)) { e.target.value=''; return; }

          // Ø§Ø­Ø¬Ø²ÙŠ Ø¨Ù„ÙˆÙƒ Ø£Ø±Ù‚Ø§Ù… Ø¹Ø§Ù…Ø©
          const runBlock = await allocateRunNumbers(normalized.length);

          const batch = db.batch();
          normalized.forEach((st, i) => {
            const seatNumber = buildSeatNumber(st.gender, st.religion, runBlock[i]);
            const ref = db.collection('students').doc();
            batch.set(ref, {
              name: st.name,
              gender: st.gender,
              religion: st.religion,
              seatNumber,
              classId,
              teacher: currentTeacherId
            });
          });

          await batch.commit();
          alert('âœ”ï¸ ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ ÙˆØªØ®ØµÙŠØµ Ø£Ø±Ù‚Ø§Ù… Ø¬Ù„ÙˆØ³ ÙØ±ÙŠØ¯Ø©');
          displayStudents(classId);
          e.target.value = '';
        } catch (err) {
          console.error(err);
          alert('â— Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØµÙŠØºØ© Ø£Ùˆ Ø¬Ø±Ù‘Ø¨ Ø§Ù„Ù‚Ø§Ù„Ø¨.');
          e.target.value = '';
        }
      }

      /* ====== ØªØµØ¯ÙŠØ± Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙƒÙ€ XLSX ====== */
      async function exportCurrentClassStudents(){
        // Ø­Ø¯Ø¯ÙŠ Ø§Ù„ÙØµÙ„ Ù…Ù† Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
        const { classId, label } = await getSelectedClassWithLabel();
        if (!classId) { alert('âš ï¸ Ø§Ø®ØªØ±/Ø£Ø¶Ù Ø§Ù„ÙØµÙ„ Ø£ÙˆÙ„Ù‹Ø§.'); return; }

        // Ù‡Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
        const snap = await db.collection('students')
          .where('classId','==',classId)
          .orderBy('seatNumber')
          .get();

        if (snap.empty) { alert('â„¹ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ø¨Ø¹Ø¯.'); return; }

        // Ø¬Ù‡Ù‘Ø² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const toAr = {
          gender: (g)=> g==='male'?'Ø°ÙƒØ±':'Ø£Ù†Ø«Ù‰',
          religion: (r)=> r==='muslim'?'Ù…Ø³Ù„Ù…':'Ù…Ø³ÙŠØ­ÙŠ'
        };

        const headers = ['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ø¬Ù†Ø³','Ø§Ù„Ø¯ÙŠØ§Ù†Ø©','Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³'];
        const rows = [];
        snap.forEach(doc=>{
          const d = doc.data();
          rows.push([
            d.name || '',
            toAr.gender(d.gender || ''),
            toAr.religion(d.religion || ''),
            d.seatNumber || ''
          ]);
        });

        // ÙƒÙˆÙ‘Ù† Ù…Ù„Ù Ø¥ÙƒØ³Ù„
        const aoa = [headers, ...rows];
        const ws  = XLSX.utils.aoa_to_sheet(aoa);
        ws['!cols'] = [{wch:25},{wch:10},{wch:12},{wch:14}];

        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„');

        // Ø§Ø³Ù… Ù…Ù„Ù Ù…Ù†Ø§Ø³Ø¨
        const safe = (label || 'Ø§Ù„ÙØµÙ„').replace(/[\\/:*?"<>|]/g,' ').replace(/\s+/g,'_');
        XLSX.writeFile(wb, `Ø·Ù„Ø§Ø¨_${safe}.xlsx`);
      }

      /* ====== EVALUATIONS ====== */

      // ÙØªØ­ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ù„Ø§Ø³Ù… Ø·Ø§Ù„Ø¨ Ù…Ø¹ÙŠÙ‘Ù†
      function openCertificateForStudent(studentName){
        const month = document.getElementById('eval-month').value;
        const year  = new Date().getFullYear();
        const classText = document.getElementById('eval-class').selectedOptions[0]?.textContent || '';
        const q = new URLSearchParams({
          name: studentName,
          month,
          year: String(year),
          klass: classText,
          teacher: `Ø£. ${currentTeacherName || ''}`
        });
        const url = `${CERT_PAGE}?${q.toString()}`;

        const win = window.open(url, '_blank', 'noopener');
        if (!win) {
          const a = document.createElement('a');
          a.href = url; a.target = '_blank'; a.rel = 'noopener';
          document.body.appendChild(a); a.click(); a.remove();
        }
      }

      async function loadEvalClasses() {
        const sel = document.getElementById('eval-class');
        sel.innerHTML = '';
        const snap = await db.collection('classes').where('teacher', '==', currentTeacherId).get();
        snap.forEach((doc) => {
          const opt = document.createElement('option');
          const d = doc.data();
          opt.value = doc.id;
          opt.textContent = `${d.grade} - ${d.system} - ${d.section}`;
          sel.appendChild(opt);
        });
        if (snap.docs.length) {
          await loadEvalStudents();
          await showEvaluationSummary();
        }
      }

      async function loadEvalStudents() {
        const classId = document.getElementById('eval-class').value;
        const sel = document.getElementById('eval-student');
        sel.innerHTML = '';
        const snap = await db.collection('students').where('classId', '==', classId).orderBy('seatNumber').get();
        snap.forEach((doc) => {
          const opt = document.createElement('option');
          opt.value = doc.id;
          opt.textContent = doc.data().name;
          sel.appendChild(opt);
        });
        updateStudentName();
      }

      async function updateStudentName() {
        const studentId = document.getElementById('eval-student').value;
        const span = document.getElementById('stu-name');
        if (!studentId) { span.textContent = ''; return; }
        const doc = await db.collection('students').doc(studentId).get();
        if (doc.exists) span.textContent = doc.data().name;
      }

      async function submitEvaluation() {
        const classId = document.getElementById('eval-class').value;
        const studentId = document.getElementById('eval-student').value;
        const month = document.getElementById('eval-month').value;
        const year = new Date().getFullYear();
        const test = parseInt(document.getElementById('input-test').value) || 0;
        const home = parseInt(document.getElementById('input-home').value) || 0;
        const part = parseInt(document.getElementById('input-part').value) || 0;
        const beh  = parseInt(document.getElementById('input-beh').value)  || 0;
        const total = test + home + part + beh;

        if (!studentId || !classId || !month) { alert('âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }

        const check = await db.collection('evaluations')
          .where('classId','==',classId)
          .where('studentId','==',studentId)
          .where('month','==',month)
          .get();
        if (!check.empty) { alert('âš ï¸ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ØªÙ‚ÙŠÙŠÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„ÙØ¹Ù„'); return; }

        const studentDoc = await db.collection('students').doc(studentId).get();
        const name = studentDoc.exists ? (studentDoc.data().name || 'Ø·Ø§Ù„Ø¨') : 'Ø·Ø§Ù„Ø¨';

        await db.collection('evaluations').add({
          classId, studentId, teacher: currentTeacherId,
          name, test, home, part, beh, total, month, year
        });

        await showEvaluationSummary();
        alert('âœ”ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');

        if (total === 40) {
          const openIt = confirm('ğŸ‰ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø­ØµÙ„ Ø¹Ù„Ù‰ 40/40 â€” ÙØªØ­ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ØŸ');
          if (openIt) openCertificateForStudent(name);
        }
      }

      async function showEvaluationSummary() {
        const classId = document.getElementById('eval-class').value;
        const month = document.getElementById('eval-month').value;
        const table = document.getElementById('eval-summary-table');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        if (!classId || !month) { table.style.display = 'none'; return; }

        const snap = await db.collection('evaluations')
          .where('classId','==',classId)
          .where('month','==',month)
          .orderBy('name')
          .get();

        if (snap.empty) { table.style.display = 'none'; return; }

        snap.forEach((doc) => {
          const d = doc.data();
          const totalNum = Number(d.total);
          const testMark = (d.test === 0) ? 'Øº' : d.test;

          let evaluation = '';
          if (d.test === 0) evaluation = 'ØºÙŠØ§Ø¨';
          else if (totalNum === 40) evaluation = 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±';
          else if (totalNum >= 36) evaluation = 'Ù…Ù…ØªØ§Ø²';
          else evaluation = 'ÙŠØ±Ø¬Ù‰ ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ø·ÙÙ„ Ù„Ø±ÙØ¹ Ù…Ø³ØªÙˆØ§Ù‡';

          const certCell = (totalNum === 40)
            ? `<button type="button" class="btn-cert cert-btn" data-name="${d.name}">ğŸ† Ø´Ù‡Ø§Ø¯Ø©</button>`
            : 'â€”';

          tbody.innerHTML += `
            <tr>
              <td style="text-align:right">${d.name}</td>
              <td>${testMark}</td>
              <td>${d.home}</td>
              <td>${d.part}</td>
              <td>${d.beh}</td>
              <td>${totalNum}</td>
              <td>${evaluation}</td>
              <td>${certCell}</td>
            </tr>`;
        });

        table.style.display = '';

        table.querySelector('tbody').onclick = (e) => {
          const btn = e.target.closest('.cert-btn');
          if (!btn) return;
          e.preventDefault();
          openCertificateForStudent(btn.dataset.name || '');
        };
      }

      // ØªØµØ¯ÙŠØ± Ø¯ÙˆØ§Ù„ Ù…Ù‡Ù…Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
      window.displayStudents = displayStudents;
    });
  </script>
</body>
</html>
