<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#f4f6fa; direction:rtl; }
    .main-container { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:#0288d1; color:#fff; padding:30px 20px; text-align:center; }
    .sidebar img { width:100px; margin-bottom:10px; }
    #teacher-name { font-size:22px; margin-bottom:30px; }
    .sidebar button { width:100%; padding:12px; margin:8px 0; background:#fff; color:#0288d1; border:none; border-radius:6px; cursor:pointer; }
    .sidebar button:hover { background:#cbefff; }
    .content { flex:1; padding:40px; font-size:18px; color:#333; }
    select,input,button { width:100%; padding:8px; margin:6px 0; font-size:16px; border:1px solid #ccc; border-radius:4px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff; }
    th,td { border:1px solid #ccc; padding:10px; text-align:center; }
    th { background:#eee; }
    .save-btn { background:#0288d1; color:#fff; border:none; padding:8px 16px; font-size:16px; border-radius:5px; cursor:pointer; }
    .delete-btn { background:#e53935; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
    .grade-absent { background:#f0f0f0; }
    .grade-top { background:#d4edda; }
    .grade-good { background:#cce5ff; }
    .grade-encourage { background:#ffe5b4; }
  </style>
</head>
<body>
  <div class="main-container">
    <aside class="sidebar">
      <img src="logo.png" alt="Logo">
      <h3 id="teacher-name">ØªØ­Ù…ÙŠÙ„...</h3>
      <button data-sec="classes">ğŸ“˜ Ø§Ù„ÙØµÙˆÙ„</button>
      <button data-sec="students">ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      <button data-sec="tests">ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
      <button data-sec="evaluation">ğŸ“ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
      <button onclick="auth.signOut().then(()=>location.href='index.html')">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </aside>
    <main class="content"><div id="main-content"></div></main>
  </div>

  <script>
  const auth = firebase.auth();
  const db = firebase.firestore();
  let currentTeacherId = null;

  auth.onAuthStateChanged(async user => {
    if (!user) return location.href = 'index.html';
    currentTeacherId = user.uid;
    const doc = await db.collection('users').doc(currentTeacherId).get();
    const data = doc.data();
    if (!data || data.type !== 'teacher') {
      alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„');
      return auth.signOut().then(() => location.href='index.html');
    }
    document.getElementById('teacher-name').textContent = `Ø£. ${data.name}`;
    document.querySelectorAll('.sidebar button[data-sec]').forEach(btn => {
      btn.addEventListener('click', () => showSection(btn.dataset.sec));
    });
    showSection('classes');
  });

  function showSection(sec) {
  const main = document.getElementById('main-content');
  main.innerHTML = '';

  // ğŸ‘‡ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„
  if (sec === 'classes') {
    main.innerHTML = `
      <div id="classes-section"><h2>ğŸ“˜ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„</h2>
      <div>
        <select id="c-grade">
          <option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
          <option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
        </select>
        <select id="c-system"><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option></select>
        <select id="c-section"><option>A</option><option>B</option><option>C</option><option>D</option></select>
        <button class="save-btn" onclick="addClass()">Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</button>
      </div>
      <h3>ğŸ“š ÙØµÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
      <table id="classes-table"><thead><tr>
        <th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ù†Ø¸Ø§Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th>
      </tr></thead><tbody></tbody></table></div>`;
    loadTeacherClasses();
  }

  // ğŸ‘‡ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨
  else if (sec === 'students') {
    main.innerHTML = `
      <div id="students-section"><h2>ğŸ‘¨â€ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
      <div>
        <select id="s-grade">
          <option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
          <option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
        </select>
        <select id="s-system"><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option></select>
        <select id="s-section"><option>A</option><option>B</option><option>C</option><option>D</option></select>
        <input type="text" id="s-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"/>
        <select id="s-gender"><option value="male">Ø°ÙƒØ±</option><option value="female">Ø£Ù†Ø«Ù‰</option></select>
        <select id="s-religion"><option value="muslim">Ù…Ø³Ù„Ù…</option><option value="christian">Ù…Ø³ÙŠØ­ÙŠ</option></select>
        <button class="save-btn" onclick="addStudent()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
        <button class="save-btn" onclick="loadStudentList()">Ø¹Ø±Ø¶ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„</button>
        <input type="search" id="student-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." list="students-list"/>
        <datalist id="students-list"></datalist>
      </div>
      <h3>ğŸ“‹ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„</h3>
      <table id="students-table"><thead><tr>
        <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¯ÙŠØ§Ù†Ø©</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</th>
      </tr></thead><tbody></tbody></table></div>`;
    loadClassDropdowns();
  }

  // ğŸ‘‡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
  else if (sec === 'tests') {
    main.innerHTML = `
      <div id="tests-section"><h2>ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
      <div>
        <label>Ø§Ù„Ø³Ù†Ø©:</label><span id="year">${new Date().getFullYear()}</span>
        <label>Ø§Ù„Ø´Ù‡Ø±:</label>
        <select id="eval-month">
          ${["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"]
            .map(m => `<option>${m}</option>`).join('')}
        </select>
        <label>Ø§Ù„ÙØµÙ„:</label><select id="eval-class"></select>
        <label>Ø§Ù„Ø·Ø§Ù„Ø¨:</label><select id="eval-student"></select>
        <p>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: <span id="stu-name"></span></p>
        <label>Ø§Ø®ØªØ¨Ø§Ø± (10):</label><input type="number" id="input-test" min="0" max="10"/>
        <label>ÙˆØ§Ø¬Ø¨ (10):</label><input type="number" id="input-home" min="0" max="10"/>
        <label>Ù…Ø´Ø§Ø±ÙƒØ© (10):</label><input type="number" id="input-part" min="0" max="10"/>
        <label>Ø³Ù„ÙˆÙƒ (10):</label><input type="number" id="input-beh" value="10" min="0" max="10"/>
        <button class="save-btn" onclick="submitEvaluation()">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      </div>
      <div id="eval-container"></div></div>`;
    loadEvalClasses(); // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: ØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©
  }

  // ğŸ‘‡ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª
  else if (sec === 'evaluation') {
    main.innerHTML = `
      <div id="evaluation-section"><h2>ğŸ“ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
      <select id="eval-class-view"></select>
      <select id="eval-month-view">
        ${["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"]
          .map(m => `<option>${m}</option>`).join('')}
      </select>
      <button class="save-btn" onclick="loadEvalResults()">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
      <div id="eval-results-container"></div>
      <button id="print-btn" class="save-btn" style="display:none;" onclick="printEval()">Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©</button></div>`;
    loadEvalClasses(); // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: ØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© ØµØ­ÙŠØ­Ø© Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØµÙˆÙ„
  }
}

// Ø§Ù„Ù…Ø±Ø­Ù„Ø© 3: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„

// Ø¥Ø¶Ø§ÙØ© ÙØµÙ„ Ø¬Ø¯ÙŠØ¯
async function addClass() {
  const grade = document.getElementById('c-grade').value;
  const system = document.getElementById('c-system').value;
  const section = document.getElementById('c-section').value;

  const existing = await db.collection('classes')
    .where('teacher','==',currentTeacherId)
    .where('grade','==',grade)
    .where('system','==',system)
    .where('section','==',section)
    .get();

  if (!existing.empty) {
    alert('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ù…Ø¶Ø§Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹');
    return;
  }

  await db.collection('classes').add({ grade, system, section, teacher: currentTeacherId });
  alert('âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØµÙ„');
  loadTeacherClasses();
}

// ØªØ­Ù…ÙŠÙ„ ÙØµÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù… Ù„Ø¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
async function loadTeacherClasses() {
  const tbody = document.querySelector('#classes-table tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
  snap.forEach(doc => {
    const d = doc.data();
    tbody.innerHTML += `
      <tr>
        <td>${d.grade}</td>
        <td>${d.system}</td>
        <td>${d.section}</td>
        <td><button class="delete-btn" onclick="deleteClass('${doc.id}')">Ø­Ø°Ù</button></td>
      </tr>`;
  });
}

// Ø­Ø°Ù ÙØµÙ„
async function deleteClass(classId) {
  await db.collection('classes').doc(classId).delete();
  alert('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØµÙ„');
  loadTeacherClasses();
}
// Ø§Ù„Ù…Ø±Ø­Ù„Ø© 4: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨

// Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
async function addStudent() {
  const g = document.getElementById('s-grade').value;
  const s = document.getElementById('s-system').value;
  const c = document.getElementById('s-section').value;
  const name = document.getElementById('s-name').value.trim();
  const gender = document.getElementById('s-gender').value;
  const religion = document.getElementById('s-religion').value;

  if (!name || !g || !s || !c || !gender || !religion) {
    return alert('â— ÙŠØ¬Ø¨ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø·Ø§Ù„Ø¨');
  }

  // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¯Ø§Ø®Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØµÙÙˆÙ
  const duplicate = await db.collection('students')
    .where('teacher', '==', currentTeacherId)
    .where('name', '==', name)
    .get();

  if (!duplicate.empty) {
    return alert('âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨');
  }

  const classSnap = await db.collection('classes')
    .where('grade', '==', g)
    .where('system', '==', s)
    .where('section', '==', c)
    .where('teacher', '==', currentTeacherId)
    .get();

  if (classSnap.empty) {
    return alert('âš ï¸ Ø¹ÙÙˆØ§... Ø£Ù†Øª Ù„Ù… ØªØ¯Ø±Ø³ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ØŒ ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø¥Ø°Ø§ ÙƒÙ†Øª Ø¨ØªØ£ÙƒÙŠØ¯ ØªØªØ¯Ø±Ø³ Ù„Ù‡');
  }

  const classId = classSnap.docs[0].id;
  const seat = await generateSeat(gender, religion, classId);

  await db.collection('students').add({
    name, gender, religion,
    seatNumber: seat,
    classId,
    teacher: currentTeacherId
  });

  alert(`âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ ${name} Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³: ${seat}`);
  displayStudents(classId);
}

// ØªÙˆÙ„ÙŠØ¯ Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³
async function generateSeat(gender, religion, classId) {
  const snap = await db.collection('students').where('classId','==',classId).get();
  const count = snap.size + 1;
  const codeG = gender === 'male' ? '1' : '2';
  const codeR = religion === 'muslim' ? '1' : '2';
  return codeG + codeR + String(count).padStart(4, '0');
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© Ù„Ù„ØµÙ ÙˆØ§Ù„Ù†Ø¸Ø§Ù… ÙˆØ§Ù„Ù‚Ø³Ù… (Ø«Ø§Ø¨ØªØ©)
async function loadClassDropdowns() {
  // Ø§Ù„ØµÙÙˆÙ Ø§Ù„Ø«Ø§Ø¨ØªØ©
  const grades = document.getElementById('s-grade');
  grades.innerHTML = `
    <option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option>
    <option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
    <option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>
    <option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option>
    <option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option>
    <option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>
  `;

  // Ø§Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ø«Ø§Ø¨ØªØ©
  const systems = document.getElementById('s-system');
  systems.innerHTML = `<option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option>`;

  // Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø«Ø§Ø¨ØªØ© A B C D
  const sections = document.getElementById('s-section');
  sections.innerHTML = `<option>A</option><option>B</option><option>C</option><option>D</option>`;

  // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ ÙØµÙ„ Ø¥Ù† ÙˆØ¬Ø¯
  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).limit(1).get();
  if (!snap.empty) {
    const classId = snap.docs[0].id;
    displayStudents(classId);
  }
}

// Ø¹Ø±Ø¶ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„ØªØ§Ø¨Ø¹ÙŠÙ† Ù„Ù„ÙØµÙ„
async function displayStudents(classId) {
  const tbody = document.querySelector('#students-table tbody');
  if (!tbody) return;
  tbody.innerHTML = '';

  const snap = await db.collection('students')
    .where('classId', '==', classId)
    .orderBy('seatNumber')
    .get();

  snap.forEach(doc => {
    const d = doc.data();
    tbody.innerHTML += `
      <tr>
        <td>${d.name}</td>
        <td>${d.gender === 'male' ? 'Ø°ÙƒØ±' : 'Ø£Ù†Ø«Ù‰'}</td>
        <td>${d.religion === 'muslim' ? 'Ù…Ø³Ù„Ù…' : 'Ù…Ø³ÙŠØ­ÙŠ'}</td>
        <td>${d.seatNumber}</td>
      </tr>`;
  });
}

// Ø²Ø± Ø¹Ø±Ø¶ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„
async function loadStudentList() {
  const g = document.getElementById('s-grade').value;
  const s = document.getElementById('s-system').value;
  const c = document.getElementById('s-section').value;

  const snap = await db.collection('classes')
    .where('grade', '==', g)
    .where('system', '==', s)
    .where('section', '==', c)
    .where('teacher', '==', currentTeacherId)
    .get();

  if (snap.empty) {
    alert('âš ï¸ Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    return;
  }

  const classId = snap.docs[0].id;
  displayStudents(classId);

  // ØªØ¹Ø¨Ø¦Ø© datalist Ù„Ù„Ø¨Ø­Ø«
  const list = document.getElementById('students-list');
  list.innerHTML = '';
  const studentsSnap = await db.collection('students').where('classId', '==', classId).get();

  studentsSnap.forEach(doc => {
    const d = doc.data();
    const opt = document.createElement('option');
    opt.value = d.name;
    list.appendChild(opt);
  });
}
// Ø§Ù„Ù…Ø±Ø­Ù„Ø© 5: Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØµÙˆÙ„ ÙÙŠ ØµÙØ­Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
async function loadEvalClasses() {
  const sel = document.getElementById('eval-class');
  sel.innerHTML = '';
  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
  snap.forEach(d => {
    const dd = d.data();
    const opt = document.createElement('option');
    opt.value = d.id;
    opt.textContent = `${dd.grade} - ${dd.system} - ${dd.section}`;
    sel.appendChild(opt);
  });

  if (sel.options.length > 0) {
    populateStudentSelect(); // ØªØ­Ù…ÙŠÙ„ Ø£ÙˆÙ„ ÙØµÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§
  }

  sel.addEventListener('change', populateStudentSelect);
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„
async function populateStudentSelect() {
  const classId = document.getElementById('eval-class').value;
  const sel = document.getElementById('eval-student');
  sel.innerHTML = '';

  const snap = await db.collection('students')
    .where('classId','==',classId)
    .orderBy('seatNumber')
    .get();

  snap.forEach(doc => {
    const d = doc.data();
    const opt = document.createElement('option');
    opt.value = doc.id;
    opt.textContent = d.name;
    sel.appendChild(opt);
  });

  sel.addEventListener('change', () => {
    const selected = sel.options[sel.selectedIndex];
    document.getElementById('stu-name').textContent = selected ? selected.text : '';
  });

  // Ø¹Ø±Ø¶ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø£ÙˆÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ù† ÙˆÙØ¬Ø¯ Ø·Ù„Ø§Ø¨
  if (sel.options.length > 0) {
    sel.selectedIndex = 0;
    document.getElementById('stu-name').textContent = sel.options[0].textContent;
  } else {
    document.getElementById('stu-name').textContent = '';
  }
}

// Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function submitEvaluation() {
  const classId = document.getElementById('eval-class').value;
  const studentId = document.getElementById('eval-student').value;
  const month = document.getElementById('eval-month').value;

  const test = +document.getElementById('input-test').value;
  const home = +document.getElementById('input-home').value;
  const part = +document.getElementById('input-part').value;
  const beh = +document.getElementById('input-beh').value;
  const total = test + home + part + beh;

  const studentDoc = await db.collection('students').doc(studentId).get();
  const student = studentDoc.data();

  await db.collection('evaluations').add({
    classId,
    studentId,
    month,
    teacher: currentTeacherId,
    name: student.name,
    seatNumber: student.seatNumber,
    test, home, part, beh, total
  });

  alert('âœ”ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù†Ø¬Ø§Ø­');
  loadEvalPreview();
}

// Ø¹Ø±Ø¶ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
async function loadEvalPreview() {
  const test = +document.getElementById('input-test').value;
  const home = +document.getElementById('input-home').value;
  const part = +document.getElementById('input-part').value;
  const beh = +document.getElementById('input-beh').value;
  const total = test + home + part + beh;

  let gradeText;
  if (test === 0) gradeText = 'ØºÙŠØ§Ø¨';
  else if (test < 7) gradeText = 'ØªØ´Ø¬ÙŠØ¹ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±';
  else if (total === 40) gradeText = 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±';
  else if (total >= 36) gradeText = 'Ù…Ù…ØªØ§Ø²';
  else gradeText = 'Ù†Ø±Ø¬Ùˆ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ´Ø¬ÙŠØ¹Ù‡';

  const name = document.getElementById('stu-name').textContent;

  document.getElementById('eval-container').innerHTML = `
    <table><thead><tr>
      <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ø®ØªØ¨Ø§Ø±</th><th>ÙˆØ§Ø¬Ø¨</th><th>Ù…Ø´Ø§Ø±ÙƒØ©</th><th>Ø³Ù„ÙˆÙƒ</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>ØªÙ‚Ø¯ÙŠØ±</th><th>Ø·Ø¨Ø§Ø¹Ø©</th>
    </tr></thead><tbody>
      <tr>
        <td>${name}</td>
        <td>${test === 0 ? '-' : test}</td>
        <td>${test === 0 ? '-' : home}</td>
        <td>${test === 0 ? '-' : part}</td>
        <td>${test === 0 ? '-' : beh}</td>
        <td>${test === 0 ? '-' : total}</td>
        <td>${gradeText}</td>
        <td>${gradeText === 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±' ? '<button onclick="printPDF()">Ø´Ù‡Ø§Ø¯Ø©</button>' : ''}</td>
      </tr>
    </tbody></table>`;
}

// Ø·Ø¨Ø§Ø¹Ø© Ø´Ù‡Ø§Ø¯Ø© PDF
function printPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const name = document.getElementById('stu-name').textContent;
  const total = document.querySelector('#eval-container td:nth-child(6)').textContent;

  doc.setFontSize(18);
  doc.text('Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ±', 80, 20);
  doc.setFontSize(14);
  doc.text(`Ø§Ù„Ø·Ø§Ù„Ø¨: ${name}`, 20, 40);
  doc.text(`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total} / 40`, 20, 50);
  doc.text('Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±', 20, 60);

  doc.save('certificate.pdf');
}
// Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª

// Ø§Ù„Ù…Ø±Ø­Ù„Ø© 6: Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª

async function loadEvalResults() {
  const cid = document.getElementById('eval-class-view').value;
  const month = document.getElementById('eval-month-view').value;

  const snap = await db.collection('evaluations')
    .where('teacher', '==', currentTeacherId)
    .where('classId', '==', cid)
    .where('month', '==', month)
    .orderBy('seatNumber')
    .get();

  const container = document.getElementById('eval-results-container');
  if (snap.empty) {
    container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>';
    document.getElementById('print-btn').style.display = 'none';
    return;
  }

  document.getElementById('print-btn').style.display = 'block';

  let html = `
    <table><thead><tr>
      <th>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ø®ØªØ¨Ø§Ø±</th><th>ÙˆØ§Ø¬Ø¨</th><th>Ù…Ø´Ø§Ø±ÙƒØ©</th>
      <th>Ø³Ù„ÙˆÙƒ</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
    </tr></thead><tbody>`;

  snap.docs.forEach(d => {
    const e = d.data();
    const absentAll = ['test', 'home', 'part', 'beh'].every(f => e[f] === 0);
    const display = {
      test: e.test === 0 ? '-' : e.test,
      home: e.home === 0 ? '-' : e.home,
      part: e.part === 0 ? '-' : e.part,
      beh: e.beh === 0 ? '-' : e.beh,
      total: e.total === 0 ? '-' : e.total
    };

    let gradeText = '', cls = '';
    if (absentAll) { gradeText = 'ØºÙŠØ§Ø¨'; cls = 'grade-absent'; }
    else if (e.total === 40) { gradeText = 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±'; cls = 'grade-top'; }
    else if (e.total >= 36) { gradeText = 'Ù…Ù…ØªØ§Ø²'; cls = 'grade-good'; }
    else { gradeText = 'Ù†Ø±Ø¬Ùˆ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ´Ø¬ÙŠØ¹Ù‡'; cls = 'grade-encourage'; }

    html += `<tr class="${cls}">
      <td>${e.seatNumber}</td><td>${e.name}</td><td>${display.test}</td><td>${display.home}</td>
      <td>${display.part}</td><td>${display.beh}</td><td>${display.total}</td><td>${gradeText}</td>
    </tr>`;
  });

  html += '</tbody></table>';
  container.innerHTML = html;
}

// Ø²Ø± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
function printEval() {
  window.print();
}

  </script>
</body>
</html>




