<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#f4f6fa; direction:rtl; }
    .main-container { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:#0288d1; color:#fff; padding:30px 20px; text-align:center; }
    .sidebar img { width:100px; margin-bottom:10px; }
    #teacher-name { font-size:22px; margin-bottom:30px; }
    .sidebar button { width:100%; padding:12px; margin:8px 0; background:#fff; color:#0288d1; border:none;border-radius:6px;cursor:pointer; }
    .sidebar button:hover { background:#cbefff; }
    .content { flex:1; padding:40px; font-size:18px; color:#333; }
    select,input,button { width:100%; padding:8px; margin:6px 0; font-size:16px; border:1px solid #ccc; border-radius:4px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff; }
    th,td { border:1px solid #ccc; padding:10px; text-align:center; }
    th { background:#eee; }
    .save-btn { background:#0288d1; color:#fff; border:none; padding:8px 16px; font-size:16px; border-radius:5px; cursor:pointer; }
    .delete-btn { background:#e53935; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
    .grade-absent { background:#f0f0f0; }
    .grade-top { background:#d4edda; }
    .grade-good { background:#cce5ff; }
    .grade-encourage { background:#ffe5b4; }
  </style>
</head>
<body>
<div class="main-container">
  <aside class="sidebar">
    <img src="logo.png" alt="Logo">
    <h3 id="teacher-name">ØªØ­Ù…ÙŠÙ„...</h3>
    <button data-sec="classes">ğŸ“˜ Ø§Ù„ÙØµÙˆÙ„</button>
    <button data-sec="students">ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
    <button data-sec="tests">ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</button>
    <button data-sec="evaluation">ğŸ“ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
    <button onclick="auth.signOut().then(()=>location.href='index.html')">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </aside>
  <main class="content">
    <div id="main-content"></div>
  </main>
</div>

<script>
const auth = firebase.auth();
const db = firebase.firestore();
let currentTeacherId = null;

auth.onAuthStateChanged(async user => {
  if (!user) location.href = 'index.html';
  currentTeacherId = user.uid;
  const doc = await db.collection('users').doc(currentTeacherId).get();
  const data = doc.data();
  if (!data || data.type !== 'teacher') {
    alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„');
    return auth.signOut().then(_ => location.href='index.html');
  }
  document.getElementById('teacher-name').textContent = `Ø£. ${data.name}`;
  document.querySelectorAll('.sidebar button[data-sec]').forEach(b =>
    b.addEventListener('click', () => showSection(b.dataset.sec))
  );
  showSection('classes');
});

function showSection(sec) {
  const main = document.getElementById('main-content');
  if (sec === 'classes') {
    main.innerHTML = ` ... Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ÙØµÙˆÙ„ ... `;
    loadTeacherClasses();
  }
  else if (sec === 'students') {
    main.innerHTML = ` ... Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ø·Ù„Ø§Ø¨ ... `;
  }
  else if (sec === 'tests') {
    main.innerHTML = `
      <h2>Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª</h2>
      <div>
        <label>Ø§Ù„Ø³Ù†Ø©: </label><span id="year"></span>
        <label>Ø§Ù„Ø´Ù‡Ø±:</label>
        <select id="eval-month">` +
        ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"]
          .map(m => `<option>${m}</option>`).join('') +
        `</select>
        <label>Ø§Ù„ÙØµÙ„:</label><select id="eval-class"></select>
        <label>Ø§Ù„Ø·Ø§Ù„Ø¨:</label><select id="eval-student"></select>
        <p>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: <span id="stu-name"></span></p>
        <label>Ø§Ø®ØªØ¨Ø§Ø± (10):</label><input type="number" id="input-test" min="0" max="10"/>
        <label>ÙˆØ§Ø¬Ø¨ (10):</label><input type="number" id="input-home" min="0" max="10"/>
        <label>Ù…Ø´Ø§Ø±ÙƒØ© (10):</label><input type="number" id="input-part" min="0" max="10"/>
        <label>Ø³Ù„ÙˆÙƒ (10):</label><input type="number" id="input-beh" value="10" min="0" max="10"/>
        <button class="save-btn" onclick="loadEvalResults()">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
      </div>
      <div id="eval-container"></div>`;
    document.getElementById('year').textContent = new Date().getFullYear();
    loadEvalClasses();
  }
  else if (sec === 'evaluation') {
    main.innerHTML = ` ... Ù‚Ø³Ù… Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ... `;
  }
}

//--- Ø¨Ù‚ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù„: loadTeacherClasses, addClass, loadClassDropdowns, addStudent ...
//--- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ‚ÙŠÙŠÙ…:
async function loadEvalClasses() {
  const sel = document.getElementById('eval-class');
  sel.innerHTML = '';
  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
  snap.forEach(d => {
    const dd = d.data(); const opt = document.createElement('option');
    opt.value = d.id; opt.textContent = `${dd.grade} - ${dd.system} - ${dd.section}`;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', populateStudentSelect);
}
async function populateStudentSelect() {
  const classId = document.getElementById('eval-class').value;
  const sel = document.getElementById('eval-student');
  sel.innerHTML = '';
  const snap = await db.collection('students').where('classId','==',classId).get();
  snap.docs.forEach(doc => {
    const dd = doc.data();
    const opt = document.createElement('option');
    opt.value = doc.id; opt.textContent = dd.name;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', () => {
    const name = sel.options[sel.selectedIndex].text;
    document.getElementById('stu-name').textContent = name;
  });
}
async function loadEvalResults() {
  const test = +document.getElementById('input-test').value;
  const home = +document.getElementById('input-home').value;
  const part = +document.getElementById('input-part').value;
  const beh = +document.getElementById('input-beh').value;
  const total = test + home + part + beh;
  let gradeText;
  if (test === 0) gradeText = 'ØºÙŠØ§Ø¨';
  else if (test < 7) gradeText = 'ØªØ´Ø¬ÙŠØ¹ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±';
  else if (total === 40) gradeText = 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±';
  else if (total >= 36) gradeText = 'Ù…Ù…ØªØ§Ø²';
  else gradeText = 'Ù†Ø±Ø¬Ùˆ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ´Ø¬ÙŠØ¹Ù‡';

  const html = `
    <table><thead><tr>
      <th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ø®ØªØ¨Ø§Ø±</th><th>ÙˆØ§Ø¬Ø¨</th><th>Ù…Ø´Ø§Ø±ÙƒØ©</th><th>Ø³Ù„ÙˆÙƒ</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>ØªÙ‚Ø¯ÙŠØ±</th><th>Ø·Ø¨Ø§Ø¹Ø©</th>
    </tr></thead><tbody>
      <tr>
        <td>${document.getElementById('stu-name').textContent}</td>
        <td>${test === 0 ? '-' : test}</td>
        <td>${test === 0 ? '-' : home}</td>
        <td>${test === 0 ? '-' : part}</td>
        <td>${test === 0 ? '-' : beh}</td>
        <td>${test === 0 ? '-' : total}</td>
        <td>${gradeText}</td>
        <td>${gradeText === 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±' ? '<button onclick="printPDF()">Ø·Ø¨Ø§Ø¹Ø© Ø´Ù‡Ø§Ø¯Ø©</button>' : ''}</td>
      </tr>
    </tbody></table>`;
  document.getElementById('eval-container').innerHTML = html;
}
function printPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.setFontSize(16);
  doc.text('Ø´Ù‡Ø§Ø¯Ø© ØªÙ‚Ø¯ÙŠØ±', 80, 20);
  const name = document.getElementById('stu-name').textContent;
  const total = document.querySelector('#eval-container td:nth-child(6)').textContent;
  doc.setFontSize(14);
  doc.text(`Ø§Ù„Ø·Ø§Ù„Ø¨: ${name}`, 20, 40);
  doc.text(`Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${total} / 40`, 20, 50);
  doc.text('Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±', 20, 60);
  doc.save('certificate.pdf');
}
</script>
</body>
</html>
