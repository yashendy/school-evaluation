<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>ููุญุฉ ุชุญูู ุงููุนูู</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    /* ุฃููุงุท CSS ููุง ูู ุงูููุฏ ุงูุณุงุจู */
    /* ... ุฃุฏุฑุฌูุงูุง ููุง ููู ุงุณุชุบููุช ุนู ุงูุชูุฑุงุฑ ูุถูู ุงููุณุงุญุฉ ... */
  </style>
</head>
<body>
  <div class="main-container">
    <aside class="sidebar">
      <img src="logo.png" alt="Logo">
      <h3 id="teacher-name">ุชุญููู...</h3>
      <button data-sec="classes">๐ ุงููุตูู</button>
      <button data-sec="students">๐จโ๐ ุงูุทูุงุจ</button>
      <button data-sec="tests">๐งช ุฅุฏุฎุงู ุงูุงุฎุชุจุงุฑุงุช</button>
      <button data-sec="evaluation">๐ ุงูุชููููุงุช</button>
      <button onclick="auth.signOut().then(()=>location.href='index.html')">๐ช ุชุณุฌูู ุงูุฎุฑูุฌ</button>
    </aside>
    <main class="content"><div id="main-content"></div></main>
  </div>
<script>
const auth = firebase.auth();
const db = firebase.firestore();
let currentTeacherId = null;

auth.onAuthStateChanged(async user => {
  if (!user) return location.href = 'index.html';
  currentTeacherId = user.uid;
  const doc = await db.collection('users').doc(currentTeacherId).get();
  const data = doc.data();
  if (!data || data.type !== 'teacher') {
    alert('ููุณ ูุฏูู ุตูุงุญูุฉ ุงูุฏุฎูู');
    return auth.signOut().then(() => location.href='index.html');
  }
  document.getElementById('teacher-name').textContent = `ุฃ. ${data.name}`;
  document.querySelectorAll('.sidebar button[data-sec]').forEach(btn => {
    btn.addEventListener('click', () => showSection(btn.dataset.sec));
  });
  showSection('classes');
});

function showSection(sec) {
  const main = document.getElementById('main-content');
  main.innerHTML = ''; // ุชูุธูู ุงููุณุงุญุฉ

  if (sec === 'classes') {
    main.innerHTML = `
      <div id="classes-section">
        <h2>๐ ุฅุฏุงุฑุฉ ุงููุตูู</h2>
        <div>
          <select id="c-grade">
            <option>ุงูุตู ุงูุฃูู</option><option>ุงูุตู ุงูุซุงูู</option><option>ุงูุตู ุงูุซุงูุซ</option>
            <option>ุงูุตู ุงูุฑุงุจุน</option><option>ุงูุตู ุงูุฎุงูุณ</option><option>ุงูุตู ุงูุณุงุฏุณ</option>
          </select>
          <select id="c-system"><option>ุนุฑุจู</option><option>ูุบุงุช</option></select>
          <select id="c-section"><option>A</option><option>B</option><option>C</option><option>D</option></select>
          <button class="save-btn" onclick="addClass()">ุฅุถุงูุฉ ูุตู</button>
        </div>
        <h3>๐ ูุตูู ุงููุนูู</h3>
        <table id="classes-table"><thead><tr>
          <th>ุงูุตู</th><th>ุงููุธุงู</th><th>ุงููุณู</th><th>ุฅุฌุฑุงุก</th>
        </tr></thead><tbody></tbody></table>
      </div>`;
    loadTeacherClasses();
  }

  else if (sec === 'students') {
    main.innerHTML = `
      <div id="students-section">
        <h2>๐จโ๐ ุฅุถุงูุฉ ุทุงูุจ ุฌุฏูุฏ</h2>
        <div>
          <select id="s-grade"><option>ุงูุตู ุงูุฃูู</option><option>ุงูุตู ุงูุซุงูู</option><option>ุงูุตู ุงูุซุงูุซ</option><option>ุงูุตู ุงูุฑุงุจุน</option><option>ุงูุตู ุงูุฎุงูุณ</option><option>ุงูุตู ุงูุณุงุฏุณ</option></select>
          <select id="s-system"><option>ุนุฑุจู</option><option>ูุบุงุช</option></select>
          <select id="s-section"><option>A</option><option>B</option><option>C</option><option>D</option></select>
          <input type="text" id="s-name" placeholder="ุงุณู ุงูุทุงูุจ"/>
          <select id="s-gender"><option value="male">ุฐูุฑ</option><option value="female">ุฃูุซู</option></select>
          <select id="s-religion"><option value="muslim">ูุณูู</option><option value="christian">ูุณูุญู</option></select>
          <button class="save-btn" onclick="addStudent()">ุฅุถุงูุฉ ุงูุทุงูุจ</button>
        </div>
        <h3>๐ ุทูุงุจ ุงููุตู</h3>
        <table id="students-table"><thead><tr>
          <th>ุงูุงุณู</th><th>ุงูููุน</th><th>ุงูุฏูุงูุฉ</th><th>ุฑูู ุงูุฌููุณ</th>
        </tr></thead><tbody></tbody></table>
      </div>`;
    loadClassDropdowns();
  }

  else if (sec === 'tests') {
    main.innerHTML = `
      <div id="tests-section">
        <h2>๐งช ุฅุฏุฎุงู ุงูุงุฎุชุจุงุฑุงุช</h2>
        <div>
          <label>ุงูุณูุฉ: </label><span id="year"></span>
          <label>ุงูุดูุฑ:</label><select id="eval-month">${
            ["ููุงูุฑ","ูุจุฑุงูุฑ","ูุงุฑุณ","ุฃุจุฑูู","ูุงูู","ููููู","ููููู","ุฃุบุณุทุณ","ุณุจุชูุจุฑ","ุฃูุชูุจุฑ","ููููุจุฑ","ุฏูุณูุจุฑ"]
              .map(m => `<option>${m}</option>`).join('')
          }</select>
          <label>ุงููุตู:</label><select id="eval-class"></select>
          <label>ุงูุทุงูุจ:</label><select id="eval-student"></select>
          <p>ุงุณู ุงูุทุงูุจ: <span id="stu-name"></span></p>
          <label>ุงุฎุชุจุงุฑ (10):</label><input type="number" id="input-test" min="0" max="10"/>
          <label>ูุงุฌุจ (10):</label><input type="number" id="input-home" min="0" max="10"/>
          <label>ูุดุงุฑูุฉ (10):</label><input type="number" id="input-part" min="0" max="10"/>
          <label>ุณููู (10):</label><input type="number" id="input-beh" value="10" min="0" max="10"/>
          <button class="save-btn" onclick="loadEvalResults()">ุนุฑุถ ุงููุชุงุฆุฌ</button>
        </div>
        <div id="eval-container"></div>
      </div>`;
    document.getElementById('year').textContent = new Date().getFullYear();
    loadEvalClasses();
  }

  else if (sec === 'evaluation') {
    main.innerHTML = `
      <div id="evaluation-section">
        <h2>๐ ุงูุชููููุงุช</h2>
        <select id="eval-class"></select>
        <select id="eval-month"><option>ููุงูุฑ</option><option>ูุจุฑุงูุฑ</option><option>ูุงุฑุณ</option><option>ุฃุจุฑูู</option></select>
        <button class="save-btn" onclick="loadEvalResults()">ุนุฑุถ ุงููุชุงุฆุฌ</button>
        <div id="eval-container"></div>
        <button id="print-btn" class="save-btn" style="display:none;" onclick="printEval()">ุทุจุงุนุฉ ุงูุดูุงุฏุฉ</button>
      </div>`;
    loadEvalClasses();
  }
}
<!-- ุฏูุงู ุงููุตูู -->
<script>
async function addClass() {
  const grade = document.getElementById('c-grade').value;
  const system = document.getElementById('c-system').value;
  const section = document.getElementById('c-section').value;
  const existing = await db.collection('classes')
    .where('teacher','==',currentTeacherId)
    .where('grade','==',grade)
    .where('system','==',system)
    .where('section','==',section)
    .get();
  if (!existing.empty) return alert('ูุฐุง ุงููุตู ููุฌูุฏ ูุณุจูุงู');
  await db.collection('classes').add({ grade, system, section, teacher: currentTeacherId });
  loadTeacherClasses();
}

async function loadTeacherClasses() {
  const tbody = document.querySelector('#classes-table tbody');
  tbody.innerHTML = '';
  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
  snap.forEach(doc => {
    const d = doc.data();
    tbody.innerHTML += `<tr><td>${d.grade}</td><td>${d.system}</td><td>${d.section}</td><td><button class="delete-btn" onclick="deleteClass('${doc.id}')">ุญุฐู</button></td></tr>`;
  });
}

async function deleteClass(id) {
  await db.collection('classes').doc(id).delete();
  loadTeacherClasses();
}
</script>

<!-- ุฏูุงู ุงูุทูุงุจ -->
<script>
async function addStudent() {
  const g = document.getElementById('s-grade').value;
  const s = document.getElementById('s-system').value;
  const c = document.getElementById('s-section').value;
  const name = document.getElementById('s-name').value.trim();
  const gender = document.getElementById('s-gender').value;
  const religion = document.getElementById('s-religion').value;
  if (!name || !g || !s || !c || !gender || !religion) {
    return alert('ูุฌุจ ููุก ุฌููุน ุงูุญููู');
  }
  const dup = await db.collection('students')
    .where('teacher','=','==',currentTeacherId)
    .where('name','==',name).get();
  if (!dup.empty) return alert('ุงูุงุณู ููุฑุฑ');
  const classSnap = await db.collection('classes')
    .where('grade','==',g).where('system','==',s).where('section','==',c).where('teacher','==',currentTeacherId).get();
  if (classSnap.empty) return alert('ุงููุตู ุบูุฑ ููุฌูุฏ');
  const classId = classSnap.docs[0].id;
  const seat = await generateSeat(gender, religion, classId);
  await db.collection('students').add({ name, gender, religion, seatNumber: seat, classId, teacher: currentTeacherId });
  displayStudents(classId);
}

async function generateSeat(gender, religion, classId) {
  const snap = await db.collection('students').where('classId','==',classId).get();
  const count = snap.size + 1;
  const codeG = gender === 'male' ? '1' : '2';
  const codeR = religion === 'muslim' ? '1' : '2';
  return codeG + codeR + String(count).padStart(4, '0');
}

async function loadClassDropdowns() {
  // ูุฐู ุงูุฏุงูุฉ ุณุชููู ุจุชุญููู ุงูุทูุงุจ ูููุตู ุงูุงูุชุฑุงุถู
  const classSnap = await db.collection('classes').where('teacher','==',currentTeacherId).limit(1).get();
  if (!classSnap.empty) displayStudents(classSnap.docs[0].id);
}

async function displayStudents(classId) {
  const tbody = document.querySelector('#students-table tbody');
  tbody.innerHTML = '';
  const snap = await db.collection('students').where('classId','==',classId).orderBy('seatNumber').get();
  snap.forEach(doc => {
    const d = doc.data();
    tbody.innerHTML += `<tr><td>${d.name}</td><td>${d.gender==='male'?'ุฐูุฑ':'ุฃูุซู'}</td><td>${d.religion==='muslim'?'ูุณูู':'ูุณูุญู'}</td><td>${d.seatNumber}</td></tr>`;
  });
}
</script>

<!-- ุฏูุงู ุงูุงุฎุชุจุงุฑุงุช ูุงูุทุจุงุนุฉ -->
<script>
async function loadEvalClasses() {
  const sel = document.getElementById('eval-class');
  sel.innerHTML = '';
  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
  snap.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.id;
    const dd = d.data();
    opt.textContent = `${dd.grade} - ${dd.system} - ${dd.section}`;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', populateStudentSelect);
}

async function populateStudentSelect() {
  const classId = document.getElementById('eval-class').value;
  const sel = document.getElementById('eval-student');
  sel.innerHTML = '';
  const snap = await db.collection('students').where('classId','==',classId).get();
  snap.forEach(doc => {
    const opt = document.createElement('option');
    opt.value = doc.id;
    opt.textContent = doc.data().name;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', () => {
    document.getElementById('stu-name').textContent = sel.options[sel.selectedIndex].text;
  });
}

async function loadEvalResults() {
  const test = +document.getElementById('input-test').value;
  const home = +document.getElementById('input-home').value;
  const part = +document.getElementById('input-part').value;
  const beh = +document.getElementById('input-beh').value;
  const total = test + home + part + beh;
  let gradeText;
  if (test === 0) gradeText = 'ุบูุงุจ';
  else if (test < 7) gradeText = 'ุชุดุฌูุน ูู ููู ุงูุฃูุฑ';
  else if (total === 40) gradeText = 'ููุชุงุฒ ูุน ุงูุดูุฑ';
  else if (total >= 36) gradeText = 'ููุชุงุฒ';
  else gradeText = 'ูุฑุฌู ูู ููู ุงูุฃูุฑ ูุชุงุจุนุฉ ุงูุทุงูุจ ูุชุดุฌูุนู';
  
  document.getElementById('eval-container').innerHTML = `
    <table><thead><tr>
      <th>ุงูุงุณู</th><th>ุงุฎุชุจุงุฑ</th><th>ูุงุฌุจ</th><th>ูุดุงุฑูุฉ</th><th>ุณููู</th><th>ุงููุฌููุน</th><th>ุชูุฏูุฑ</th><th>ุทุจุงุนุฉ</th>
    </tr></thead><tbody>
      <tr>
        <td>${document.getElementById('stu-name').textContent}</td>
        <td>${test===0 ? '-' : test}</td>
        <td>${test===0 ? '-' : home}</td>
        <td>${test===0 ? '-' : part}</td>
        <td>${test===0 ? '-' : beh}</td>
        <td>${test===0 ? '-' : total}</td>
        <td>${gradeText}</td>
        <td>${gradeText==='ููุชุงุฒ ูุน ุงูุดูุฑ'?'<button onclick="printPDF()">ุดูุงุฏุฉ</button>':''}</td>
      </tr>
    </tbody></table>`;
}

function printPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const name = document.getElementById('stu-name').textContent;
  const total = document.querySelector('#eval-container td:nth-child(6)').textContent;
  doc.setFontSize(16).text('ุดูุงุฏุฉ ุชูุฏูุฑ',80,20);
  doc.setFontSize(14).text(`ุงูุทุงูุจ: ${name}`,20,40);
  doc.text(`ุงููุฌููุน: ${total} / 40`,20,50);
  doc.text('ููุชุงุฒ ูุน ุงูุดูุฑ',20,60);
  doc.save('certificate.pdf');
}
</script>
</body>
</html>

