<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Ø±ÙˆØ§Ø¨Ø· Firebase Ùˆ jsPDF -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body { margin:0; padding:0; font-family: Arial, sans-serif; background:#f0f2f5; }
    .main-container { display:flex; min-height:100vh; }
    .sidebar { width:220px; background:#222; color:#fff; padding:20px; box-sizing:border-box; }
    .sidebar img { width:100%; margin-bottom:20px; }
    .sidebar h3 { margin:10px 0; font-size:18px; }
    .sidebar button { display:block; width:100%; padding:10px; margin-bottom:10px; background:#444; border:none; color:#fff; cursor:pointer; text-align:right; }
    .content { flex:1; background:#fff; padding:20px; box-sizing:border-box; }
    .save-btn, .delete-btn { padding:5px 10px; margin:5px; cursor:pointer; }
  </style>
</head>
<body>
  <div class="main-container">
    <aside class="sidebar">
      <img src="logo.png" alt="Logo">
      <h3 id="teacher-name">ØªØ­Ù…ÙŠÙ„...</h3>
      <button data-sec="classes">ğŸ“˜ Ø§Ù„ÙØµÙˆÙ„</button>
      <button data-sec="students">ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      <button data-sec="tests">ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      <button onclick="window.location.href='evaluations.html'">ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
      <button onclick="auth.signOut().then(()=>location.href='index.html')">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </aside>
    <main class="content">
      <div id="main-content">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const auth = firebase.auth();
      const db = firebase.firestore();
      let currentTeacherId = null;

      auth.onAuthStateChanged(async user => {
        if (!user) return location.href = 'index.html';
        currentTeacherId = user.uid;

        const userDoc = await db.collection('users').doc(currentTeacherId).get();
        const data = userDoc.data();
        if (!data || data.type !== 'teacher') {
          alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„');
          return auth.signOut().then(() => location.href = 'index.html');
        }

        document.getElementById('teacher-name').textContent = `Ø£. ${data.name}`;
        document.querySelectorAll('.sidebar button[data-sec]').forEach(btn =>
          btn.addEventListener('click', () => showSection(btn.dataset.sec))
        );

        showSection('classes');
      });

      function showSection(sec) {
        const main = document.getElementById('main-content');
        if (!main) return console.error('Ø¹Ù†ØµØ± main-content ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
        main.innerHTML = '';

        if (sec === 'classes') {
          main.innerHTML = `
            <h2>ğŸ“˜ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„</h2>
            <div>
              <select id="c-grade"><option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option></select>
              <select id="c-system"><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option></select>
              <select id="c-section"><option>A</option><option>B</option><option>C</option><option>D</option></select>
              <button class="save-btn" onclick="addClass()">Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</button>
            </div>
            <table id="classes-table">
              <thead><tr><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ù†Ø¸Ø§Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
              <tbody></tbody>
            </table>`;
          loadTeacherClasses();
        }
        else if (sec === 'students') {
          main.innerHTML = `
            <h2>ğŸ‘¨â€ğŸ“ Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</h2>
            <div>
              <select id="s-grade"><option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option></select>
              <select id="s-system"><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option></select>
              <select id="s-section"><option>A</option><option>B</option><option>C</option><option>D</option></select>
              <input id="s-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" />
              <select id="s-gender"><option value="male">Ø°ÙƒØ±</option><option value="female">Ø£Ù†Ø«Ù‰</option></select>
              <select id="s-religion"><option value="muslim">Ù…Ø³Ù„Ù…</option><option value="christian">Ù…Ø³ÙŠØ­ÙŠ</option></select>
              <button class="save-btn" onclick="addStudent()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
              <button class="save-btn" onclick="loadStudentList()">Ø¹Ø±Ø¶ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„</button>
              <input type="search" id="student-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." list="students-list" />
              <datalist id="students-list"></datalist>
            </div>
            <h3>ğŸ“‹ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„</h3>
            <table id="students-table"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø§Ù„Ø¯ÙŠØ§Ù†Ø©</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</th></tr></thead><tbody></tbody></table>`;
          loadClassDropdowns();
        }
        else if (sec === 'tests') {
          main.innerHTML = `
            <h2>ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h2>
            <div>
              <label>Ø§Ù„Ø´Ù‡Ø±:</label>
              <select id="eval-month">
                ${["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"].map(m=>`<option>${m}</option>`).join('')}
              </select>
              <label>Ø§Ù„ÙØµÙ„:</label><select id="eval-class" onchange="loadEvalStudents()"></select>
              <label>Ø§Ù„Ø·Ø§Ù„Ø¨:</label><select id="eval-student" onchange="updateStudentName()"></select>
              <p>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨: <span id="stu-name"></span></p>
              <label>Ø§Ø®ØªØ¨Ø§Ø±:</label><input type="number" id="input-test" min="0" max="10" />
              <label>ÙˆØ§Ø¬Ø¨:</label><input type="number" id="input-home" min="0" max="10" />
              <label>Ù…Ø´Ø§Ø±ÙƒØ©:</label><input type="number" id="input-part" min="0" max="10" />
              <label>Ø³Ù„ÙˆÙƒ:</label><input type="number" id="input-beh" value="10" min="0" max="10" />
              <button class="save-btn" onclick="submitEvaluation()">Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
            </div>
            <table id="eval-summary-table" style="width:100%; margin-top:20px; display:none;">
              <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ø®ØªØ¨Ø§Ø±</th><th>ÙˆØ§Ø¬Ø¨</th><th>Ù…Ø´Ø§Ø±ÙƒØ©</th><th>Ø³Ù„ÙˆÙƒ</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead><tbody></tbody>
            </table>`;
          loadEvalClasses();
        }
      }

      // â€”â€”â€” Ø¯ÙˆØ§Ù„ Classes â€”â€”â€”
      async function addClass() {
        const grade = document.getElementById('c-grade').value;
        const system = document.getElementById('c-system').value;
        const section = document.getElementById('c-section').value;

        const existing = await db.collection('classes')
          .where('teacher','==',currentTeacherId)
          .where('grade','==',grade)
          .where('system','==',system)
          .where('section','==',section)
          .get();

        if (!existing.empty) { alert('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ù…Ø¶Ø§Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹'); return; }
        await db.collection('classes').add({ grade, system, section, teacher: currentTeacherId });
        alert('âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØµÙ„');
        loadTeacherClasses();
      }

      async function loadTeacherClasses() {
        const tbody = document.querySelector('#classes-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
        snap.forEach(doc => {
          const d = doc.data();
          tbody.innerHTML += `<tr><td>${d.grade}</td><td>${d.system}</td><td>${d.section}</td><td><button class="delete-btn" onclick="deleteClass('${doc.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td></tr>`;
        });
      }

      async function deleteClass(classId) {
        await db.collection('classes').doc(classId).delete();
        alert('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØµÙ„');
        loadTeacherClasses();
      }

      // â€”â€”â€” Ø¯ÙˆØ§Ù„ Students â€”â€”â€”
      async function addStudent() {
        const g = document.getElementById('s-grade').value;
        const s = document.getElementById('s-system').value;
        const c = document.getElementById('s-section').value;
        const name = document.getElementById('s-name').value.trim();
        const gender = document.getElementById('s-gender').value;
        const religion = document.getElementById('s-religion').value;

        if (!name||!g||!s||!c||!gender||!religion) { alert('â— ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }

        const duplicate = await db.collection('students')
          .where('teacher','==',currentTeacherId).where('name','==',name).get();
        if (!duplicate.empty) { alert('âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹'); return; }

        const classSnap = await db.collection('classes')
          .where('grade','==',g).where('system','==',s).where('section','==',c).where('teacher','==',currentTeacherId).get();
        if (classSnap.empty) { alert('âš ï¸ Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }

        const classId = classSnap.docs[0].id;
        const seat = await generateSeat(gender, religion, classId);
        await db.collection('students').add({ name, gender, religion, seatNumber: seat, classId, teacher: currentTeacherId });
        alert(`âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ ${name} Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³: ${seat}`);
        displayStudents(classId);
      }

      async function generateSeat(gender, religion, classId) {
        const snap = await db.collection('students').where('classId','==',classId).get();
        const count = snap.size + 1;
        const codeG = gender==='male'?'1':'2';
        const codeR = religion==='muslim'?'1':'2';
        return codeG + codeR + String(count).padStart(4,'0');
      }

      async function loadClassDropdowns() {
        document.getElementById('s-grade').innerHTML = `<option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>`;
        document.getElementById('s-system').innerHTML = `<option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option>`;
        document.getElementById('s-section').innerHTML = `<option>A</option><option>B</option><option>C</option><option>D</option>`;
        const snap = await db.collection('classes').where('teacher','==',currentTeacherId).limit(1).get();
        if (!snap.empty) displayStudents(snap.docs[0].id);
      }

      async function loadStudentList() {
        const g = document.getElementById('s-grade').value;
        const s = document.getElementById('s-system').value;
        const c = document.getElementById('s-section').value;
        const snap = await db.collection('classes').where('grade','==',g).where('system','==',s).where('section','==',c).where('teacher','==',currentTeacherId).get();
        if (snap.empty) { alert('âš ï¸ Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
        const classId = snap.docs[0].id;
        displayStudents(classId);
        const list = document.getElementById('students-list');
        list.innerHTML = '';
        const studentsSnap = await db.collection('students').where('classId','==',classId).get();
        studentsSnap.forEach(doc => {
          const opt = document.createElement('option');
          opt.value = doc.data().name;
          list.appendChild(opt);
        });
      }

      async function displayStudents(classId) {
        const tbody = document.querySelector('#students-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const snap = await db.collection('students').where('classId','==',classId).orderBy('seatNumber').get();
        snap.forEach(doc => {
          const d = doc.data();
          tbody.innerHTML += `<tr><td>${d.name}</td><td>${d.gender==='male'?'Ø°ÙƒØ±':'Ø£Ù†Ø«Ù‰'}</td><td>${d.religion==='muslim'?'Ù…Ø³Ù„Ù…':'Ù…Ø³ÙŠØ­ÙŠ'}</td><td>${d.seatNumber}</td></tr>`;
        });
      }

      // â€”â€”â€” Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… â€”â€”â€”
      async function loadEvalClasses() {
        const sel = document.getElementById('eval-class');
        sel.innerHTML = '';
        const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
        snap.forEach(doc => {
          const opt = document.createElement('option');
          const d = doc.data();
          opt.value = doc.id;
          opt.textContent = `${d.grade} - ${d.system} - ${d.section}`;
          sel.appendChild(opt);
        });
        if (snap.docs.length) loadEvalStudents();
      }

      async function loadEvalStudents() {
        const classId = document.getElementById('eval-class').value;
        const sel = document.getElementById('eval-student');
        sel.innerHTML = '';
        const snap = await db.collection('students').where('classId','==',classId).orderBy('seatNumber').get();
        snap.forEach(doc => {
          const opt = document.createElement('option');
          opt.value = doc.id;
          opt.textContent = doc.data().name;
          sel.appendChild(opt);
        });
        updateStudentName();
      }

      async function updateStudentName() {
        const studentId = document.getElementById('eval-student').value;
        const span = document.getElementById('stu-name');
        if (!studentId) return span.textContent = '';
        const doc = await db.collection('students').doc(studentId).get();
        if (doc.exists) span.textContent = doc.data().name;
      }

      async function submitEvaluation() {
        const classId = document.getElementById('eval-class').value;
        const studentId = document.getElementById('eval-student').value;
        const month = document.getElementById('eval-month').value;
        const year = new Date().getFullYear();
        const test = parseInt(document.getElementById('input-test').value) || 0;
        const home = parseInt(document.getElementById('input-home').value) || 0;
        const part = parseInt(document.getElementById('input-part').value) || 0;
        const beh = parseInt(document.getElementById('input-beh').value) || 0;
        const total = test + home + part + beh;

        if (!studentId || !classId || !month) { alert('âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }

        const check = await db.collection('evaluations').where('classId','==',classId).where('studentId','==',studentId).where('month','==',month).get();
        if (!check.empty) { alert('âš ï¸ ØªÙ… Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±'); return; }

        const studentDoc = await db.collection('students').doc(studentId).get();
        const name = studentDoc.exists ? studentDoc.data().name : 'Ø·Ø§Ù„Ø¨';
        await db.collection('evaluations').add({ classId, studentId, teacher: currentTeacherId, name, test, home, part, beh, total, month, year });
        alert('âœ”ï¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ø­ÙÙˆØ¸ Ø¨Ù†Ø¬Ø§Ø­');
        showEvaluationSummary();
      }

      async function showEvaluationSummary() {
        const classId = document.getElementById('eval-class').value;
        const month = document.getElementById('eval-month').value;
        const table = document.getElementById('eval-summary-table');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        const snap = await db.collection('evaluations').where('classId','==',classId).where('month','==',month).get();
        if (snap.empty) { table.style.display = 'none'; return; }

        snap.forEach(doc => {
          const d = doc.data();
          tbody.innerHTML += `<tr><td>${d.name}</td><td>${d.test}</td><td>${d.home}</td><td>${d.part}</td><td>${d.beh}</td><td>${d.total}</td></tr>`;
        });

        table.style.display = '';
      }
    });
  </script>
</body>
</html>
