<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>لوحة تحكم المعلم</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#f4f6fa; direction:rtl; }
    .main-container { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:#0288d1; color:#fff; padding:30px 20px; text-align:center; }
    .sidebar img { width:100px; margin-bottom:10px; }
    #teacher-name { font-size:22px; margin-bottom:30px; }
    .sidebar button { width:100%; padding:12px; margin:8px 0; background:#fff; color:#0288d1; border:none; border-radius:6px; cursor:pointer; }
    .sidebar button:hover { background:#cbefff; }
    .content { flex:1; padding:40px; font-size:18px; color:#333; }
    select,input,button { width:100%; padding:8px; margin:6px 0; font-size:16px; border:1px solid #ccc; border-radius:4px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff; }
    th,td { border:1px solid #ccc; padding:10px; text-align:center; }
    th { background:#eee; }
    .save-btn { background:#0288d1; color:#fff; border:none; padding:8px 16px; font-size:16px; border-radius:5px; cursor:pointer; }
    .grade-absent { background:#f0f0f0; }
    .grade-top { background:#d4edda; }
    .grade-good { background:#cce5ff; }
    .grade-encourage { background:#ffe5b4; }
  </style>
</head>
<body>
<div class="main-container">
  <aside class="sidebar">
    <img src="logo.png" alt="Logo">
    <h3 id="teacher-name">تحميل...</h3>
    <button data-sec="classes">📘 الفصول</button>
    <button data-sec="students">👨‍🎓 الطلاب</button>
    <button data-sec="evaluation">📝 التقييمات</button>
    <button onclick="auth.signOut().then(()=>location.href='index.html')">🚪 تسجيل الخروج</button>
  </aside>
  <main class="content">
    <div id="main-content"></div>
  </main>
</div>

<script>
const auth = firebase.auth();
const db = firebase.firestore();
let currentTeacherId = null;

auth.onAuthStateChanged(async user => {
  if(!user) return location.href='index.html';
  currentTeacherId = user.uid;
  const doc = await db.collection('users').doc(user.uid).get();
  document.getElementById('teacher-name').textContent = `أ. ${doc.data().name}`;
  document.querySelectorAll('.sidebar button[data-sec]').forEach(b =>
    b.addEventListener('click', ()=> showSection(b.dataset.sec))
  );
  showSection('classes');
});

function showSection(sec){
  const main = document.getElementById('main-content');
  if(sec==='classes'){
    main.innerHTML = `
      <h2>➕ إدارة الفصول</h2>
      <div>
        <select id="c-grade"><option>الصف الرابع</option><option>الصف الخامس</option><option>الصف السادس</option></select>
        <select id="c-system"><option>عربي</option><option>لغات</option></select>
        <select id="c-section"><option>A</option><option>B</option></select>
        <button class="save-btn" onclick="addClass()">إضافة فصل</button>
      </div>`;
  }
  else if(sec==='students'){
    main.innerHTML = `
      <h2>➕ إضافة طالب جديد</h2>
      <div>
        <select id="s-grade"></select><select id="s-system"></select><select id="s-section"></select>
        <input type="text" id="s-name" placeholder="اسم الطالب"/>
        <select id="s-gender"><option value="male">ذكر</option><option value="female">أنثى</option></select>
        <select id="s-religion"><option value="muslim">مسلم</option><option value="christian">مسيحي</option></select>
        <button class="save-btn" onclick="addStudent()">إضافة الطالب</button>
      </div>
      <h3>📋 جدول الطلاب لهذا الفصل</h3>
      <table id="students-table"><thead><tr><th>الاسم</th><th>النوع</th><th>الديانة</th><th>رقم الجلوس</th></tr></thead><tbody></tbody></table>`;
    loadClassDropdowns();
  }
  else if(sec==='evaluation'){
    main.innerHTML = `
      <h2>التقييمات</h2>
      <select id="eval-class"><option>اختر الفصل</option></select>
      <select id="eval-month"><option value="يناير">يناير</option><option value="فبراير">فبراير</option><option value="مايو">مايو</option></select>
      <button class="save-btn" onclick="loadEvalResults()">عرض النتائج</button>
      <div id="eval-container"></div>
      <button id="print-btn" class="save-btn" style="display:none;" onclick="printEval()">طباعة شهادة الفصل</button>`;
    loadEvalClasses();
  }
}

// == الفصول والطلاب ==
async function addClass(){
  const grade = document.getElementById('c-grade').value;
  const system = document.getElementById('c-system').value;
  const section = document.getElementById('c-section').value;
  await db.collection('classes').add({grade, system, section, teacher: currentTeacherId});
  alert('تم إضافة الفصل');
}
async function loadClassDropdowns(){
  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
  const gS=document.getElementById('s-grade'), sS=document.getElementById('s-system'), cS=document.getElementById('s-section');
  gS.innerHTML=sS.innerHTML=cS.innerHTML='';
  snap.forEach(d=>{
    const dd=d.data();
    gS.innerHTML+=`<option>${dd.grade}</option>`;
    sS.innerHTML+=`<option>${dd.system}</option>`;
    cS.innerHTML+=`<option>${dd.section}</option>`;
  });
}
async function generateSeat(gender,religion,classId){
  const snap = await db.collection('students').where('classId','==',classId).get();
  const count = snap.size + 1;
  const codeG = gender==='male'? '1':'2';
  const codeR = religion==='muslim'? '1':'2';
  return codeG+codeR+String(count).padStart(4,'0');
}
async function addStudent(){
  const g = document.getElementById('s-grade').value;
  const s = document.getElementById('s-system').value;
  const c = document.getElementById('s-section').value;
  const name = document.getElementById('s-name').value.trim();
  const gender = document.getElementById('s-gender').value;
  const religion = document.getElementById('s-religion').value;
  const snap = await db.collection('classes')
    .where('grade','==',g)
    .where('system','==',s)
    .where('section','==',c)
    .where('teacher','==',currentTeacherId)
    .get();
  if(snap.empty){ return alert('الفصل غير موجود'); }
  const classId = snap.docs[0].id;
  const seat = await generateSeat(gender, religion, classId);
  await db.collection('students').add({name, gender, religion, seatNumber: seat, classId, teacher: currentTeacherId});
  alert(`تم إضافة الطالب ${name} رقم الجلوس: ${seat}`);
  displayStudents(classId);
}
async function displayStudents(classId){
  const tbody = document.querySelector('#students-table tbody');
  tbody.innerHTML = '';
  const snap = await db.collection('students').where('classId','==',classId).orderBy('seatNumber').get();
  snap.forEach(d=>{
    const e=d.data();
    tbody.innerHTML += `<tr><td>${e.name}</td><td>${e.gender==='male'?'ذكر':'أنثى'}</td><td>${e.religion==='muslim'?'مسلم':'مسيحي'}</td><td>${e.seatNumber}</td></tr>`;
  });
}

// == التقييمات ==
async function loadEvalClasses(){
  const sel = document.getElementById('eval-class');
  sel.innerHTML = '';
  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
  snap.forEach(d=>{
    const o=document.createElement('option');
    o.value = d.id; o.textContent = `${d.data().grade} - ${d.data().system} - ${d.data().section}`;
    sel.appendChild(o);
  });
}
async function loadEvalResults(){
  const cid = document.getElementById('eval-class').value;
  const month = document.getElementById('eval-month').value;
  const snap = await db.collection('evaluations')
    .where('teacher','==',currentTeacherId)
    .where('classId','==',cid)
    .where('month','==',month)
    .orderBy('seatNumber')
    .get();
  const container = document.getElementById('eval-container');
  if(snap.empty){
    container.innerHTML = '<p>لا توجد نتائج لهذا الشهر</p>';
    document.getElementById('print-btn').style.display='none'; return;
  }
  document.getElementById('print-btn').style.display='block';
  let html=`<table><thead><tr><th>جلوس</th><th>اسم</th><th>اختبار</th><th>واجب</th><th>مشاركة</th><th>سلوك</th><th>المجموع</th><th>تقدير</th></tr></thead><tbody>`;
  snap.docs.forEach(d=>{
    const e=d.data(); let absentAll = true;
    ['test','home','part','beh'].forEach(f=>{
      if(e[f] !== 0) absentAll = false;
    });
    const display = {};
    ['test','home','part','beh'].forEach(f=>{
      display[f] = e[f] === 0 ? '-' : e[f];
    });
    display.total = e.total===0?'-':e.total;
    let gradeText='', cls='';
    if(absentAll){ gradeText='غياب'; cls='grade-absent'; }
    else if(e.total===40){ gradeText='ممتاز مع الشكر'; cls='grade-top'; }
    else if(e.total>=36){ gradeText='ممتاز'; cls='grade-good'; }
    else { gradeText='نرجو من ولي الأمر متابعة الطالب وتشجيعه'; cls='grade-encourage'; }
    html += `<tr class="${cls}"><td>${e.seatNumber}</td><td>${e.name}</td><td>${display.test}</td><td>${display.home}</td><td>${display.part}</td><td>${display.beh}</td><td>${display.total}</td><td>${gradeText}</td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}
function printEval(){
  // استعمل نفس الكود اللي شرحته سابقًا لـ printClassSheet لكن مع العناصر داخل #eval-container
}

</script>
</body>
</html>
