<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة تحكم المعلم</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <style>
    body { margin:0; padding:0; font-family: Arial, sans-serif; background:#f0f2f5; }
    .main-container { display:flex; min-height:100vh; }
    .sidebar { width:220px; background:#add8e6; color:#fff; padding:20px; box-sizing:border-box; }
    .sidebar img { width:100%; margin-bottom:20px; }
    .sidebar h3 { margin:10px 0; font-size:18px; color:#002b36; }
    .sidebar button { display:block; width:100%; padding:10px; margin-bottom:10px; background:#444; border:none; color:#fff; cursor:pointer; text-align:right; border-radius:6px; }
    .content { flex:1; background:#fff; padding:20px; box-sizing:border-box; }
    .save-btn, .delete-btn { padding:6px 10px; margin:5px; cursor:pointer; border-radius:6px; border:1px solid #ccc; background:#f7f7f7; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { border:1px solid #dfe3e7; padding:8px; text-align:center; }
    th { background:#f2f5f7; }
    input, select { padding:8px; border:1px solid #d0d7de; border-radius:6px; }
    .row { display:grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap:10px; align-items:center; margin:8px 0; }
    .muted { color:#666; font-size:13px; margin-top:6px; }

    /* إدخال التقييم */
    .form-grid{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap:10px 12px;
      align-items:center;
      max-width:720px;
    }
    .form-grid label{ justify-self:end; color:#222; }
    .form-grid input,.form-grid select{
      width:100%; padding:8px; border:1px solid #d0d7de; border-radius:6px;
    }
    .form-grid .full{ grid-column:1 / -1; }
    .btn-cert{background:#2e7d32;color:#fff;border:0;border-radius:8px;padding:10px 12px;cursor:pointer}
  </style>
</head>
<body>
  <div class="main-container">
    <aside class="sidebar">
      <img src="logo.png" alt="Logo">
      <h3 id="teacher-name">جاري التحميل...</h3>
      <button data-sec="classes">📘 الفصول</button>
      <button data-sec="students">👨‍🎓 الطلاب</button>
      <button data-sec="tests">🧪 إدخال التقييم</button>
      <button onclick="auth.signOut().then(()=>location.href='index.html')">🚪 تسجيل الخروج</button>
      <button onclick="window.location.href='evaluations.html'">📄 عرض التقييمات</button>
    </aside>

    <main class="content">
      <div id="main-content">جاري التحميل...</div>
    </main>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // نجعل auth عالمي للأزرار في الـsidebar
      window.auth = firebase.auth();
      const db = firebase.firestore();
      let currentTeacherId = null;

      auth.onAuthStateChanged(async user => {
        if (!user) return location.href = 'index.html';
        currentTeacherId = user.uid;

        const userDoc = await db.collection('users').doc(currentTeacherId).get();
        const data = userDoc.data();
        if (!data || data.type !== 'teacher') {
          alert('❌ ليس لديك صلاحية الوصول');
          await auth.signOut();
          return (location.href = 'index.html');
        }

        document.getElementById('teacher-name').textContent = `أ. ${data.name}`;
        document.querySelectorAll('.sidebar button[data-sec]').forEach(btn =>
          btn.addEventListener('click', () => showSection(btn.dataset.sec))
        );

        showSection('classes');
      });

      function showSection(sec) {
        const main = document.getElementById('main-content');
        main.innerHTML = '';

        if (sec === 'classes') {
          main.innerHTML = `
            <h2>📘 إدارة الفصول</h2>
            <div class="row">
              <select id="c-grade">
                <option>الصف الأول</option><option>الصف الثاني</option><option>الصف الثالث</option>
                <option>الصف الرابع</option><option>الصف الخامس</option><option>الصف السادس</option>
              </select>
              <select id="c-system"><option>عربي</option><option>لغات</option></select>
              <select id="c-section"><option>A</option><option>B</option><option>C</option><option>D</option></select>
              <button class="save-btn" id="btn-add-class">إضافة فصل</button>
            </div>
            <table id="classes-table">
              <thead><tr><th>الصف</th><th>النظام</th><th>القسم</th><th>إجراء</th></tr></thead>
              <tbody></tbody>
            </table>`;
          requestAnimationFrame(() => {
            document.getElementById('btn-add-class').addEventListener('click', addClass);
            loadTeacherClasses();
          });
        }

        else if (sec === 'students') {
          main.innerHTML = `
            <h2>👨‍🎓 إضافة طالب</h2>
            <div class="row">
              <select id="s-grade"></select>
              <select id="s-system"></select>
              <select id="s-section"></select>
              <input id="s-name" placeholder="اسم الطالب" />
              <select id="s-gender"><option value="male">ذكر</option><option value="female">أنثى</option></select>
              <select id="s-religion"><option value="muslim">مسلم</option><option value="christian">مسيحي</option></select>
              <button class="save-btn" id="btn-add-student">إضافة الطالب</button>
              <button class="save-btn" id="btn-load-students">عرض طلاب الفصل</button>
              <input type="search" id="student-search" placeholder="ابحث باسم الطالب..." list="students-list" />
              <datalist id="students-list"></datalist>
            </div>
            <h3>📋 طلاب الفصل</h3>
            <table id="students-table"><thead><tr><th>الاسم</th><th>الجنس</th><th>الديانة</th><th>رقم الجلوس</th></tr></thead><tbody></tbody></table>`;
          requestAnimationFrame(() => {
            document.getElementById('btn-add-student').addEventListener('click', addStudent);
            document.getElementById('btn-load-students').addEventListener('click', loadStudentList);
            loadClassDropdowns();
          });
        }

        else if (sec === 'tests') {
          main.innerHTML = `
            <h2>🧪 إدخال التقييم</h2>

            <div class="form-grid" id="eval-form">
              <label>الشهر:</label>
              <select id="eval-month">
                ${["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"].map(m => `<option>${m}</option>`).join('')}
              </select>

              <label>الفصل:</label>
              <select id="eval-class"></select>

              <label>الطالب:</label>
              <select id="eval-student"></select>

              <label>اسم الطالب:</label>
              <div id="stu-name" class="muted" style="text-align:right"></div>

              <label>اختبار (0-10):</label>
              <input type="number" id="input-test" min="0" max="10" />

              <label>واجب (0-10):</label>
              <input type="number" id="input-home" min="0" max="10" />

              <label>مشاركة (0-10):</label>
              <input type="number" id="input-part" min="0" max="10" />

              <label>سلوك (0-10):</label>
              <input type="number" id="input-beh" value="10" min="0" max="10" />

              <div class="full" style="margin-top:8px">
                <button class="save-btn" id="btn-save-eval" style="width:100%">💾 حفظ التقييم</button>
              </div>

              <!-- سيُحقن هنا زر شهادة التقدير عند الحصول على 40 -->
              <div class="full" id="cert-slot"></div>
            </div>

            <h3 style="margin-top:16px">✅ تم إدخال التقييم لهؤلاء الطلاب (للفصل/الشهر الحاليين)</h3>
            <table id="eval-summary-table" style="width:100%; margin-top:8px; display:none;">
              <thead>
                <tr>
                  <th>الاسم</th><th>اختبار</th><th>واجب</th><th>مشاركة</th>
                  <th>سلوك</th><th>المجموع</th><th>التقدير</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>`;
          requestAnimationFrame(() => {
            loadEvalClasses();
            document.getElementById('eval-class').addEventListener('change', async () => {
              await loadEvalStudents(); await showEvaluationSummary(); removeCertButton();
            });
            document.getElementById('eval-month').addEventListener('change', () => { showEvaluationSummary(); removeCertButton(); });
            document.getElementById('eval-student').addEventListener('change', updateStudentName);
            document.getElementById('btn-save-eval').addEventListener('click', submitEvaluation);
          });
        }
      }

      // ——— دوال Classes ———
      async function addClass() {
        const grade = document.getElementById('c-grade').value;
        const system = document.getElementById('c-system').value;
        const section = document.getElementById('c-section').value;

        const existing = await db.collection('classes')
          .where('teacher','==',currentTeacherId)
          .where('grade','==',grade)
          .where('system','==',system)
          .where('section','==',section)
          .get();

        if (!existing.empty) { alert('⚠️ هذا الفصل مضاف مسبقاً'); return; }
        await db.collection('classes').add({ grade, system, section, teacher: currentTeacherId });
        loadTeacherClasses();
      }

      async function loadTeacherClasses() {
        const tbody = document.querySelector('#classes-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
        snap.forEach(doc => {
          const d = doc.data();
          tbody.innerHTML += `<tr><td>${d.grade}</td><td>${d.system}</td><td>${d.section}</td><td><button class="delete-btn" onclick="deleteClass('${doc.id}')">🗑️ حذف</button></td></tr>`;
        });
      }

      async function deleteClass(classId) {
        await db.collection('classes').doc(classId).delete();
        loadTeacherClasses();
      }

      // ——— دوال Students ———
      async function addStudent() {
        const g = document.getElementById('s-grade').value;
        const s = document.getElementById('s-system').value;
        const c = document.getElementById('s-section').value; /* ← تم إصلاح الخطأ هنا */
        const name = document.getElementById('s-name').value.trim();
        const gender = document.getElementById('s-gender').value;
        const religion = document.getElementById('s-religion').value;

        if (!name||!g||!s||!c||!gender||!religion) { alert('❗ يرجى ملء جميع الحقول'); return; }

        const duplicate = await db.collection('students')
          .where('teacher','==',currentTeacherId).where('name','==',name).get();
        if (!duplicate.empty) { alert('⚠️ الاسم موجود مسبقاً'); return; }

        const classSnap = await db.collection('classes')
          .where('grade','==',g).where('system','==',s).where('section','==',c).where('teacher','==',currentTeacherId).get();
        if (classSnap.empty) { alert('⚠️ الفصل غير موجود'); return; }

        const classId = classSnap.docs[0].id;
        const seat = await generateSeat(gender, religion, classId);
        await db.collection('students').add({ name, gender, religion, seatNumber: seat, classId, teacher: currentTeacherId });
        displayStudents(classId);
      }

      async function generateSeat(gender, religion, classId) {
        const snap = await db.collection('students').where('classId','==',classId).get();
        const count = snap.size + 1;
        const codeG = gender==='male'?'1':'2';
        const codeR = religion==='muslim'?'1':'2';
        return codeG + codeR + String(count).padStart(4,'0');
      }

      async function loadClassDropdowns() {
        document.getElementById('s-grade').innerHTML = `<option>الصف الأول</option><option>الصف الثاني</option><option>الصف الثالث</option><option>الصف الرابع</option><option>الصف الخامس</option><option>الصف السادس</option>`;
        document.getElementById('s-system').innerHTML = `<option>عربي</option><option>لغات</option>`;
        document.getElementById('s-section').innerHTML = `<option>A</option><option>B</option><option>C</option><option>D</option>`;
        const snap = await db.collection('classes').where('teacher','==',currentTeacherId).limit(1).get();
        if (!snap.empty) displayStudents(snap.docs[0].id);
      }

      async function loadStudentList() {
        const g = document.getElementById('s-grade').value;
        const s = document.getElementById('s-system').value;
        const c = document.getElementById('s-section').value;
        const snap = await db.collection('classes')
          .where('grade','==',g).where('system','==',s).where('section','==',c)
          .where('teacher','==',currentTeacherId).get();
        if (snap.empty) { alert('⚠️ الفصل غير موجود'); return; }
        const classId = snap.docs[0].id;
        displayStudents(classId);
        const list = document.getElementById('students-list');
        list.innerHTML = '';
        const studentsSnap = await db.collection('students').where('classId','==',classId).orderBy('seatNumber').get();
        studentsSnap.forEach(doc => {
          const opt = document.createElement('option');
          opt.value = doc.data().name;
          list.appendChild(opt);
        });
      }

      async function displayStudents(classId) {
        const tbody = document.querySelector('#students-table tbody');
        if (!tbody) return;
        tbody.innerHTML = '';
        const snap = await db.collection('students').where('classId','==',classId).orderBy('seatNumber').get();
        snap.forEach(doc => {
          const d = doc.data();
          tbody.innerHTML += `<tr><td style="text-align:right">${d.name}</td><td>${d.gender==='male'?'ذكر':'أنثى'}</td><td>${d.religion==='muslim'?'مسلم':'مسيحي'}</td><td>${d.seatNumber}</td></tr>`;
        });
      }

      // ——— دوال التقييم ———
      async function loadEvalClasses() {
        const sel = document.getElementById('eval-class');
        sel.innerHTML = '';
        const snap = await db.collection('classes').where('teacher', '==', currentTeacherId).get();
        snap.forEach(doc => {
          const opt = document.createElement('option');
          const d = doc.data();
          opt.value = doc.id;
          opt.textContent = `${d.grade} - ${d.system} - ${d.section}`;
          sel.appendChild(opt);
        });
        if (snap.docs.length) {
          await loadEvalStudents();
          await showEvaluationSummary();
        }
      }

      async function loadEvalStudents() {
        const classId = document.getElementById('eval-class').value;
        const sel = document.getElementById('eval-student');
        sel.innerHTML = '';
        const snap = await db.collection('students').where('classId', '==', classId).orderBy('seatNumber').get();
        snap.forEach(doc => {
          const opt = document.createElement('option');
          opt.value = doc.id;
          opt.textContent = doc.data().name;
          sel.appendChild(opt);
        });
        updateStudentName();
      }

      async function updateStudentName() {
        const studentId = document.getElementById('eval-student').value;
        const span = document.getElementById('stu-name');
        if (!studentId) return span.textContent = '';
        const doc = await db.collection('students').doc(studentId).get();
        if (doc.exists) span.textContent = doc.data().name;
      }

      function removeCertButton(){
        const slot = document.getElementById('cert-slot');
        if (slot) slot.innerHTML = '';
      }

      async function submitEvaluation() {
        const classId = document.getElementById('eval-class').value;
        const studentId = document.getElementById('eval-student').value;
        const month = document.getElementById('eval-month').value;
        const year = new Date().getFullYear();
        const test = parseInt(document.getElementById('input-test').value) || 0;
        const home = parseInt(document.getElementById('input-home').value) || 0;
        const part = parseInt(document.getElementById('input-part').value) || 0;
        const beh  = parseInt(document.getElementById('input-beh').value)  || 0;
        const total = test + home + part + beh;

        if (!studentId || !classId || !month) {
          alert('⚠️ تأكد من إدخال جميع البيانات');
          return;
        }

        // منع التكرار لنفس الشهر/الفصل/الطالب
        const check = await db.collection('evaluations')
          .where('classId', '==', classId)
          .where('studentId', '==', studentId)
          .where('month', '==', month)
          .get();

        if (!check.empty) {
          alert('⚠️ تم إدخال تقييم لهذا الطالب في هذا الشهر بالفعل');
          return;
        }

        const studentDoc = await db.collection('students').doc(studentId).get();
        const name = studentDoc.exists ? studentDoc.data().name : 'طالب';

        await db.collection('evaluations').add({
          classId, studentId, teacher: currentTeacherId,
          name, test, home, part, beh, total, month, year
        });

        await showEvaluationSummary();
        alert('✔️ تم حفظ التقييم');

        // زر شهادة التقدير عند 40/40
        removeCertButton();
        if (total === 40) {
          const slot = document.getElementById('cert-slot');
          const btn = document.createElement('button');
          btn.className = 'btn-cert';
          btn.id = 'btn-certificate';
          btn.textContent = '🏆 طباعة شهادة التقدير';
          slot.appendChild(btn);

          btn.addEventListener('click', async () => {
            const cls = await db.collection('classes').doc(classId).get();
            const cdata = cls.data();
            const classText = `${cdata.grade} - ${cdata.system} - ${cdata.section}`;
            const tdoc = await db.collection('users').doc(currentTeacherId).get();
            const tname = tdoc.exists ? (tdoc.data().name || '') : '';
            const q = new URLSearchParams({
              name, month, year: String(year),
              klass: classText,
              teacher: `أ. ${tname}`
            });
            // افتح صفحة الشهادة (تأكدي وجود certificate.html + الخلفية)
            window.open(`certificate.html?${q.toString()}`, '_blank', 'noopener');
          });
        }
      }

      async function showEvaluationSummary() {
        const classId = document.getElementById('eval-class').value;
        const month = document.getElementById('eval-month').value;
        const table = document.getElementById('eval-summary-table');
        const tbody = table.querySelector('tbody');
        tbody.innerHTML = '';

        if (!classId || !month) { table.style.display = 'none'; return; }

        const snap = await db.collection('evaluations')
          .where('classId', '==', classId)
          .where('month', '==', month)
          .orderBy('name')
          .get();

        if (snap.empty) {
          table.style.display = 'none';
          return;
        }

        snap.forEach(doc => {
          const d = doc.data();
          const testMark = d.test === 0 ? 'غ' : d.test;
          let evaluation = '';
          if (d.test === 0) evaluation = 'غياب';
          else if (d.total === 40) evaluation = 'ممتاز مع الشكر';
          else if (d.total >= 36) evaluation = 'ممتاز';
          else evaluation = 'يرجى تشجيع الطفل لرفع مستواه';

          tbody.innerHTML += `
            <tr>
              <td style="text-align:right">${d.name}</td>
              <td>${testMark}</td>
              <td>${d.home}</td>
              <td>${d.part}</td>
              <td>${d.beh}</td>
              <td>${d.total}</td>
              <td>${evaluation}</td>
            </tr>`;
        });
        table.style.display = '';
      }

      // تصدير دوال مهمة للنطاق العام (لو فيه HTML قديم بينادي onchange)
      window.loadEvalStudents = loadEvalStudents;
      window.showEvaluationSummary = showEvaluationSummary;
      window.updateStudentName = updateStudentName;
      window.displayStudents = displayStudents;
    });
  </script>
</body>
</html>
