\<\!DOCTYPE html\>

\<html lang="ar" dir="rtl"\>
\<head\>
ย \<meta charset="UTF-8" /\>
ย \<title\>ููุญุฉ ุชุญูู ุงููุนูู\</title\>
ย \<meta name="viewport" content="width=device-width, initial-scale=1.0" /\>
ย ย \<script src="[https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js](https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js)"\>\</script\>
ย \<script src="[https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js](https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js)"\>\</script\>
ย \<script src="[https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js](https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js)"\>\</script\>
ย \<script src="[https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js](https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js)"\>\</script\>
ย \<script src="firebase-config.js"\>\</script\>
ย \<style\>
ย ย /\* ููุง ุงูุชูุณูู CSS ููุง ุณุจู \*/
ย \</style\>
\</head\>
\<body\>
ย \<div class="main-container"\>
ย ย \<aside class="sidebar"\>
ย ย ย \<img src="logo.png" alt="Logo" /\>
ย ย ย \<h3 id="teacher-name"\>ุชุญููู...\</h3\>
ย ย ย \<button data-sec="classes"\>๐ ุงููุตูู\</button\>
ย ย ย \<button data-sec="students"\>๐จโ๐ ุงูุทูุงุจ\</button\>
ย ย ย \<button data-sec="tests"\>๐งช ุฅุฏุฎุงู ุงูุงุฎุชุจุงุฑุงุช\</button\>
ย ย ย \<button onclick="window.location.href='evaluations.html'"\>๐ ุนุฑุถ ุงูุชููููุงุช\</button\>
ย ย ย \<button onclick="auth.signOut().then(()=\>location.href='index.html')"\>๐ช ุชุณุฌูู ุงูุฎุฑูุฌ\</button\>
ย ย \</aside\>
ย ย \<main class="content"\>\<div id="main-content"\>\</div\>\</main\>
ย \</div\>

ย \<script\>
ย ย // โ ุงููุฑุญูุฉ 1: ุชุณุฌูู ุงูุฏุฎูู
ย ย const auth = firebase.auth();
ย ย const db = firebase.firestore();
ย ย let currentTeacherId = null;

ย ย auth.onAuthStateChanged(async user =\> {
ย ย ย if (\!user) return location.href = 'index.html';
ย ย ย currentTeacherId = user.uid;
ย ย ย const doc = await db.collection('users').doc(currentTeacherId).get();
ย ย ย const data = doc.data();
ย ย ย if (\!data || data.type \!== 'teacher') {
ย ย ย ย alert('โ ููุณ ูุฏูู ุตูุงุญูุฉ ุงูุฏุฎูู ุฅูู ูุฐู ุงูุตูุญุฉ');
ย ย ย ย return auth.signOut().then(() =\> location.href = 'index.html');
ย ย ย }
ย ย ย document.getElementById('teacher-name').textContent = `ุฃ. ${data.name}`;
ย ย ย document.querySelectorAll('.sidebar button[data-sec]').forEach(btn =\> {
ย ย ย ย btn.addEventListener('click', () =\> showSection(btn.dataset.sec));
ย ย ย });
ย ย ย showSection('classes');
ย ย });

ย ย // โ ุงููุฑุญูุฉ 2: ุฏุงูุฉ ุงูุชููู ุจูู ุงูุฃูุณุงู
ย ย function showSection(sec) {
ย ย ย const main = document.getElementById('main-content');
ย ย ย main.innerHTML = '';

ย ย ย if (sec === 'classes') {
ย ย ย ย main.innerHTML = `  ย ย ย ย ย <div id="classes-section"><h2>๐ ุฅุฏุงุฑุฉ ุงููุตูู</h2> ย ย ย ย ย ย <div> ย ย ย ย ย ย ย <select id="c-grade"> ย ย ย ย ย ย ย ย <option>ุงูุตู ุงูุฃูู</option><option>ุงูุตู ุงูุซุงูู</option><option>ุงูุตู ุงูุซุงูุซ</option> ย ย ย ย ย ย ย ย <option>ุงูุตู ุงูุฑุงุจุน</option><option>ุงูุตู ุงูุฎุงูุณ</option><option>ุงูุตู ุงูุณุงุฏุณ</option> ย ย ย ย ย ย ย </select> ย ย ย ย ย ย ย <select id="c-system"><option>ุนุฑุจู</option><option>ูุบุงุช</option></select> ย ย ย ย ย ย ย <select id="c-section"><option>A</option><option>B</option><option>C</option><option>D</option></select> ย ย ย ย ย ย ย <button class="save-btn" onclick="addClass()">ุฅุถุงูุฉ ูุตู</button> ย ย ย ย ย ย </div> ย ย ย ย ย ย <h3>๐ ูุตูู ุงููุนูู</h3> ย ย ย ย ย ย <table id="classes-table"><thead><tr> ย ย ย ย ย ย ย <th>ุงูุตู</th><th>ุงููุธุงู</th><th>ุงููุณู</th><th>ุฅุฌุฑุงุก</th> ย ย ย ย ย ย </tr></thead><tbody></tbody></table> ย ย ย ย ย </div> `;
ย ย ย ย ย ย
ย ย ย ย loadTeacherClasses();
ย ย ย } else if (sec === 'students') {
ย ย ย ย main.innerHTML = `  ย ย ย ย ย <div id="students-section"><h2>๐จโ๐ ุฅุถุงูุฉ ุทุงูุจ ุฌุฏูุฏ</h2> ย ย ย ย ย ย <div> ย ย ย ย ย ย ย <select id="s-grade"> ย ย ย ย ย ย ย ย <option>ุงูุตู ุงูุฃูู</option><option>ุงูุตู ุงูุซุงูู</option><option>ุงูุตู ุงูุซุงูุซ</option> ย ย ย ย ย ย ย ย <option>ุงูุตู ุงูุฑุงุจุน</option><option>ุงูุตู ุงูุฎุงูุณ</option><option>ุงูุตู ุงูุณุงุฏุณ</option> ย ย ย ย ย ย ย </select> ย ย ย ย ย ย ย <select id="s-system"><option>ุนุฑุจู</option><option>ูุบุงุช</option></select> ย ย ย ย ย ย ย <select id="s-section"><option>A</option><option>B</option><option>C</option><option>D</option></select> ย ย ย ย ย ย ย <input type="text" id="s-name" placeholder="ุงุณู ุงูุทุงูุจ" /> ย ย ย ย ย ย ย <select id="s-gender"><option value="male">ุฐูุฑ</option><option value="female">ุฃูุซู</option></select> ย ย ย ย ย ย ย <select id="s-religion"><option value="muslim">ูุณูู</option><option value="christian">ูุณูุญู</option></select> ย ย ย ย ย ย ย <button class="save-btn" onclick="addStudent()">ุฅุถุงูุฉ ุงูุทุงูุจ</button> ย ย ย ย ย ย ย <button class="save-btn" onclick="loadStudentList()">ุนุฑุถ ุทูุงุจ ุงููุตู</button> ย ย ย ย ย ย ย <input type="search" id="student-search" placeholder="ุงุจุญุซ ุจุงุณู ุงูุทุงูุจ..." list="students-list" /> ย ย ย ย ย ย ย <datalist id="students-list"></datalist> ย ย ย ย ย ย </div> ย ย ย ย ย ย <h3>๐ ุทูุงุจ ุงููุตู</h3> ย ย ย ย ย ย <table id="students-table"><thead><tr> ย ย ย ย ย ย ย <th>ุงูุงุณู</th><th>ุงูููุน</th><th>ุงูุฏูุงูุฉ</th><th>ุฑูู ุงูุฌููุณ</th> ย ย ย ย ย ย </tr></thead><tbody></tbody></table> ย ย ย ย ย </div> `;
ย ย ย ย loadClassDropdowns();
ย ย ย } else if (sec === 'tests') {
ย ย ย ย main.innerHTML = `ย ย ย ย ย <div id="tests-section"><h2>๐งช ุฅุฏุฎุงู ุงูุงุฎุชุจุงุฑุงุช</h2> ย ย ย ย ย ย <div> ย ย ย ย ย ย ย <label>ุงูุณูุฉ:</label><span id="year">${new Date().getFullYear()}</span> ย ย ย ย ย ย ย <label>ุงูุดูุฑ:</label> ย ย ย ย ย ย ย <select id="eval-month"> ย ย ย ย ย ย ย ย ${["ููุงูุฑ","ูุจุฑุงูุฑ","ูุงุฑุณ","ุฃุจุฑูู","ูุงูู","ููููู","ููููู","ุฃุบุณุทุณ","ุณุจุชูุจุฑ","ุฃูุชูุจุฑ","ููููุจุฑ","ุฏูุณูุจุฑ"] ย ย ย ย ย ย ย ย ย .map(m =>`\<option\>${m}\</option\>\`).join('')}
ย ย ย ย ย ย ย \</select\>
ย ย ย ย ย ย ย \<label\>ุงููุตู:\</label\>\<select id="eval-class" onchange="loadEvalStudents()"\>\</select\>
ย ย ย ย ย ย ย \<label\>ุงูุทุงูุจ:\</label\>\<select id="eval-student" onchange="updateStudentName()"\>\</select\>
ย ย ย ย ย ย ย \<p\>ุงุณู ุงูุทุงูุจ: \<span id="stu-name"\>\</span\>\</p\>
ย ย ย ย ย ย ย \<label\>ุงุฎุชุจุงุฑ (10):\</label\>\<input type="number" id="input-test" min="0" max="10"/\>
ย ย ย ย ย ย ย \<label\>ูุงุฌุจ (10):\</label\>\<input type="number" id="input-home" min="0" max="10"/\>
ย ย ย ย ย ย ย \<label\>ูุดุงุฑูุฉ (10):\</label\>\<input type="number" id="input-part" min="0" max="10"/\>
ย ย ย ย ย ย ย \<label\>ุณููู (10):\</label\>\<input type="number" id="input-beh" value="10" min="0" max="10"/\>
ย ย ย ย ย ย ย \<button class="save-btn" onclick="submitEvaluation()"\>ุญูุธ ุงูุชูููู\</button\>
ย ย ย ย ย ย \</div\>

ย ย ย ย ย ย \<table id="eval-summary-table" style="width:100%; margin-top:20px; display:none;"\>
ย ย ย ย ย ย ย \<thead\>
ย ย ย ย ย ย ย ย \<tr\>\<th\>ุงูุงุณู\</th\>\<th\>ุงุฎุชุจุงุฑ\</th\>\<th\>ูุงุฌุจ\</th\>\<th\>ูุดุงุฑูุฉ\</th\>\<th\>ุณููู\</th\>\<th\>ุงููุฌููุน\</th\>\</tr\>
ย ย ย ย ย ย ย \</thead\>
ย ย ย ย ย ย ย \<tbody\>\</tbody\>
ย ย ย ย ย ย \</table\>
ย ย ย ย ย \</div\>\`;
ย ย ย ย loadEvalClasses();
ย ย ย }
ย ย }

ย ย // โ ุฅุถุงูุฉ ูุตู ุฌุฏูุฏ
async function addClass() {
ย const grade = document.getElementById('c-grade').value;
ย const system = document.getElementById('c-system').value;
ย const section = document.getElementById('c-section').value;

ย const existing = await db.collection('classes')
ย ย .where('teacher', '==', currentTeacherId)
ย ย .where('grade', '==', grade)
ย ย .where('system', '==', system)
ย ย .where('section', '==', section)
ย ย .get();

ย if (\!existing.empty) {
ย ย alert('โ๏ธ ูุฐุง ุงููุตู ูุถุงู ูุณุจูุงู');
ย ย return;
ย }

ย await db.collection('classes').add({
ย ย grade,
ย ย system,
ย ย section,
ย ย teacher: currentTeacherId
ย });

ย alert('โ๏ธ ุชู ุฅุถุงูุฉ ุงููุตู');
ย loadTeacherClasses();
}

// โ ุชุญููู ูุตูู ุงููุนูู ูุนุฑุถูุง ูู ุงูุฌุฏูู
async function loadTeacherClasses() {
ย const tbody = document.querySelector('\#classes-table tbody');
ย if (\!tbody) return;
ย tbody.innerHTML = '';

ย const snap = await db.collection('classes')
ย ย .where('teacher', '==', currentTeacherId)
ย ย .get();

ย snap.forEach(doc =\> {
ย ย const d = doc.data();
ย ย tbody.innerHTML += `  ย ย ย <tr> ย ย ย ย <td>${d.grade}</td> ย ย ย ย <td>${d.system}</td> ย ย ย ย <td>${d.section}</td> ย ย ย ย <td><button class="delete-btn" onclick="deleteClass('${doc.id}')">๐๏ธ ุญุฐู</button></td> ย ย ย </tr> `;
ย });
}

// โ ุญุฐู ูุตู
async function deleteClass(classId) {
ย await db.collection('classes').doc(classId).delete();
ย alert('๐๏ธ ุชู ุญุฐู ุงููุตู');
ย loadTeacherClasses();
}

// โ ุฅุถุงูุฉ ุทุงูุจ ุฌุฏูุฏ
async function addStudent() {
ย const g = document.getElementById('s-grade').value;
ย const s = document.getElementById('s-system').value;
ย const c = document.getElementById('s-section').value;
ย const name = document.getElementById('s-name').value.trim();
ย const gender = document.getElementById('s-gender').value;
ย const religion = document.getElementById('s-religion').value;

ย if (\!name || \!g || \!s || \!c || \!gender || \!religion) {
ย ย return alert('โ ูุฌุจ ููุก ุฌููุน ุงูุญููู ุงูุฎุงุตุฉ ุจุงูุทุงูุจ');
ย }

ย // ุงูุชุญูู ูู ุงูุชูุฑุงุฑ ุฏุงุฎู ุฌููุน ุงูุตููู
ย const duplicate = await db.collection('students')
ย ย .where('teacher', '==', currentTeacherId)
ย ย .where('name', '==', name)
ย ย .get();

ย if (\!duplicate.empty) {
ย ย return alert('โ๏ธ ุงูุงุณู ููุฌูุฏ ุจุงููุนู ูุฑุฌู ุงูุชุฃูุฏ ูู ุงุณู ุงูุทุงูุจ');
ย }

ย const classSnap = await db.collection('classes')
ย ย .where('grade', '==', g)
ย ย .where('system', '==', s)
ย ย .where('section', '==', c)
ย ย .where('teacher', '==', currentTeacherId)
ย ย .get();

ย if (classSnap.empty) {
ย ย return alert('โ๏ธ ุนููุง... ุฃูุช ูู ุชุฏุฑุณ ููุฐุง ุงููุตู');
ย }

ย const classId = classSnap.docs[0].id;
ย const seat = await generateSeat(gender, religion, classId);

ย await db.collection('students').add({
ย ย name, gender, religion,
ย ย seatNumber: seat,
ย ย classId,
ย ย teacher: currentTeacherId
ย });

ย alert(`โ๏ธ ุชู ุฅุถุงูุฉ ุงูุทุงูุจ ${name} ุฑูู ุงูุฌููุณ: ${seat}`);
ย displayStudents(classId);
}

// โ ุชูููุฏ ุฑูู ุงูุฌููุณ
async function generateSeat(gender, religion, classId) {
ย const snap = await db.collection('students').where('classId','==',classId).get();
ย const count = snap.size + 1;
ย const codeG = gender === 'male' ? '1' : '2';
ย const codeR = religion === 'muslim' ? '1' : '2';
ย return codeG + codeR + String(count).padStart(4, '0');
}

// โ ุชุญููู ุงูููุงุฆู ุงูููุณุฏูุฉ ุงูุซุงุจุชุฉ
async function loadClassDropdowns() {
ย const grades = document.getElementById('s-grade');
ย grades.innerHTML = `  ย ย <option>ุงูุตู ุงูุฃูู</option> ย ย <option>ุงูุตู ุงูุซุงูู</option> ย ย <option>ุงูุตู ุงูุซุงูุซ</option> ย ย <option>ุงูุตู ุงูุฑุงุจุน</option> ย ย <option>ุงูุตู ุงูุฎุงูุณ</option> ย ย <option>ุงูุตู ุงูุณุงุฏุณ</option> `;

ย const systems = document.getElementById('s-system');
ย systems.innerHTML = `<option>ุนุฑุจู</option><option>ูุบุงุช</option>`;

ย const sections = document.getElementById('s-section');
ย sections.innerHTML = `<option>A</option><option>B</option><option>C</option><option>D</option>`;

ย const snap = await db.collection('classes').where('teacher','==',currentTeacherId).limit(1).get();
ย if (\!snap.empty) {
ย ย const classId = snap.docs[0].id;
ย ย displayStudents(classId);
ย }
}

// โ ุนุฑุถ ุทูุงุจ ุงููุตู ุงููุญุฏุฏ
async function displayStudents(classId) {
ย const tbody = document.querySelector('\#students-table tbody');
ย if (\!tbody) return;
ย tbody.innerHTML = '';

ย const snap = await db.collection('students')
ย ย .where('classId', '==', classId)
ย ย .orderBy('seatNumber')
ย ย .get();

ย snap.forEach(doc =\> {
ย ย const d = doc.data();
ย ย tbody.innerHTML += `  ย ย ย <tr> ย ย ย ย <td>${d.name}</td> ย ย ย ย <td>${d.gender === 'male' ? 'ุฐูุฑ' : 'ุฃูุซู'}</td> ย ย ย ย <td>${d.religion === 'muslim' ? 'ูุณูู' : 'ูุณูุญู'}</td> ย ย ย ย <td>${d.seatNumber}</td> ย ย ย </tr> `;
ย });
}

// โ ุฒุฑ "ุนุฑุถ ุทูุงุจ ุงููุตู"
async function loadStudentList() {
ย const g = document.getElementById('s-grade').value;
ย const s = document.getElementById('s-system').value;
ย const c = document.getElementById('s-section').value;

ย const snap = await db.collection('classes')
ย ย .where('grade', '==', g)
ย ย .where('system', '==', s)
ย ย .where('section', '==', c)
ย ย .where('teacher', '==', currentTeacherId)
ย ย .get();

ย if (snap.empty) {
ย ย alert('โ๏ธ ุงููุตู ุบูุฑ ููุฌูุฏ');
ย ย return;
ย }

ย const classId = snap.docs[0].id;
ย displayStudents(classId);

ย // ุชุนุจุฆุฉ datalist ููุจุญุซ
ย const list = document.getElementById('students-list');
ย list.innerHTML = '';
ย const studentsSnap = await db.collection('students').where('classId', '==', classId).get();

ย studentsSnap.forEach(doc =\> {
ย ย const d = doc.data();
ย ย const opt = document.createElement('option');
ย ย opt.value = d.name;
ย ย list.appendChild(opt);
ย });
}

// ุชุญููู ูุตูู ุงููุนูู ููุงุฆูุฉ ุฅุฏุฎุงู ุงูุชูููู
async function loadEvalClasses() {
ย const sel = document.getElementById('eval-class');
ย sel.innerHTML = '';

ย const snap = await db.collection('classes')
ย ย .where('teacher', '==', currentTeacherId)
ย ย .get();

ย snap.forEach(doc =\> {
ย ย const d = doc.data();
ย ย const opt = document.createElement('option');
ย ย opt.value = doc.id;
ย ย opt.textContent = `${d.grade} - ${d.system} - ${d.section}`;
ย ย sel.appendChild(opt);
ย });

ย if (snap.docs.length \> 0) {
ย ย loadEvalStudents();
ย }
}

// ุชุญููู ุทูุงุจ ุงููุตู ุงููุฎุชุงุฑ
async function loadEvalStudents() {
ย const classId = document.getElementById('eval-class').value;
ย const sel = document.getElementById('eval-student');
ย sel.innerHTML = '';

ย const snap = await db.collection('students')
ย ย .where('classId', '==', classId)
ย ย .orderBy('seatNumber')
ย ย .get();

ย snap.forEach(doc =\> {
ย ย const d = doc.data();
ย ย const opt = document.createElement('option');
ย ย opt.value = doc.id;
ย ย opt.textContent = d.name;
ย ย sel.appendChild(opt);
ย });

ย updateStudentName();
}

// ุนุฑุถ ุงุณู ุงูุทุงูุจ ุงููุญุฏุฏ
async function updateStudentName() {
ย const studentId = document.getElementById('eval-student').value;
ย const span = document.getElementById('stu-name');
ย if (\!studentId) return span.textContent = '';
ย const doc = await db.collection('students').doc(studentId).get();
ย if (doc.exists) span.textContent = doc.data().name;
}

// ุญูุธ ุงูุชูููู ููุทุงูุจ
async function submitEvaluation() {
ย const classId = document.getElementById('eval-class').value;
ย const studentId = document.getElementById('eval-student').value;
ย const month = document.getElementById('eval-month').value;
ย const year = new Date().getFullYear();

ย const test = parseInt(document.getElementById('input-test').value) || 0;
ย const home = parseInt(document.getElementById('input-home').value) || 0;
ย const part = parseInt(document.getElementById('input-part').value) || 0;
ย const beh = parseInt(document.getElementById('input-beh').value) || 0;
ย const total = test + home + part + beh;

ย if (\!studentId || \!classId || \!month) return alert('โ๏ธ ุชุฃูุฏ ูู ุงุฎุชูุงุฑ ุงููุตู ูุงูุทุงูุจ ูุงูุดูุฑ');

ย // ุงูุชุญูู ูู ุงูุชูุฑุงุฑ
ย const check = await db.collection('evaluations')
ย ย .where('classId', '==', classId)
ย ย .where('studentId', '==', studentId)
ย ย .where('month', '==', month)
ย ย .get();

ย if (\!check.empty) {
ย ย return alert('โ๏ธ ุชู ุชูููู ูุฐุง ุงูุทุงูุจ ููุฐุง ุงูุดูุฑ ูุณุจูุงู');
ย }

ย const studentDoc = await db.collection('students').doc(studentId).get();
ย const name = studentDoc.exists ? studentDoc.data().name : 'ุทุงูุจ';

ย await db.collection('evaluations').add({
ย ย classId,
ย ย studentId,
ย ย teacher: currentTeacherId,
ย ย name,
ย ย test,
ย ย home,
ย ย part,
ย ย beh,
ย ย total,
ย ย month,
ย ย year
ย });

ย alert('โ๏ธ ุชู ุญูุธ ุงูุชูููู ุจูุฌุงุญ');
ย showEvaluationSummary();
}

// ุนุฑุถ ููุฎุต ุงูุชูููู ูู ุงูุฌุฏูู ุฃุณูู ุงูุตูุญุฉ
async function showEvaluationSummary() {
ย const classId = document.getElementById('eval-class').value;
ย const month = document.getElementById('eval-month').value;

ย const table = document.getElementById('eval-summary-table');
ย const tbody = table.querySelector('tbody');
ย tbody.innerHTML = '';

ย const snap = await db.collection('evaluations')
ย ย .where('classId', '==', classId)
ย ย .where('month', '==', month)
ย ย .get();

ย if (snap.empty) {
ย ย table.style.display = 'none';
ย ย return;
ย }

ย snap.forEach(doc =\> {
ย ย const d = doc.data();
ย ย const row = `<tr> ย ย ย <td>${d.name}</td> ย ย ย <td>${d.test}</td> ย ย ย <td>${d.home}</td> ย ย ย <td>${d.part}</td> ย ย ย <td>${d.beh}</td> ย ย ย <td>${d.total}</td> ย ย </tr>`;
ย ย tbody.innerHTML += row;
ย });

ย table.style.display = '';
}
ย \</script\>ย

\</body\>
\</html\>
