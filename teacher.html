<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة تحكم المعلم</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/3.0.1/jspdf.umd.min.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f4f6fa; direction: rtl; }
    .main-container { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: #0288d1; color: #fff; padding: 30px 20px; text-align: center; }
    .sidebar img { width: 100px; margin-bottom: 10px; }
    #teacher-name { font-size: 22px; margin-bottom: 30px; }
    .sidebar button {
      width: 100%; padding: 12px; margin: 8px 0;
      background: #fff; color: #0288d1; border: none;
      border-radius: 6px; cursor: pointer;
    }
    .sidebar button:hover { background: #cbefff; }
    .content { flex: 1; padding: 40px; font-size: 18px; color: #333; }
    select, input, button {
      width: 100%; padding: 8px; margin: 6px 0;
      font-size: 16px; border: 1px solid #ccc; border-radius: 4px;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    th { background: #eee; }
    .save-btn {
      background: #0288d1; color: #fff;
      border: none; padding: 8px 16px;
      font-size: 16px; border-radius: 5px; cursor: pointer;
    }
    .delete-btn {
      background: #e53935; color: #fff;
      border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer;
    }
    .grade-absent { background: #f0f0f0; }
    .grade-top { background: #d4edda; }
    .grade-good { background: #cce5ff; }
    .grade-encourage { background: #ffe5b4; }
  </style>
</head>
<body>
<div class="main-container">
  <aside class="sidebar">
    <img src="logo.png" alt="Logo" />
    <h3 id="teacher-name">تحميل...</h3>
    <button data-sec="classes">📘 الفصول</button>
    <button data-sec="students">👨‍🎓 الطلاب</button>
    <button data-sec="tests">🧪 إدخال الاختبارات</button>
    <button data-sec="evaluation">📝 التقييمات</button>
    <button onclick="auth.signOut().then(()=>location.href='index.html')">🚪 تسجيل الخروج</button>
  </aside>
  <main class="content">
    <div id="main-content"></div>
  </main>
</div>
<script>
const auth = firebase.auth();
const db = firebase.firestore();
let currentTeacherId = null;

auth.onAuthStateChanged(async user => {
  if (!user) return location.href = 'index.html';

  currentTeacherId = user.uid;
  const doc = await db.collection('users').doc(currentTeacherId).get();
  const data = doc.data();

  if (!data || data.type !== 'teacher') {
    alert('ليس لديك صلاحية الدخول إلى هذه الصفحة');
    return auth.signOut().then(() => location.href = 'index.html');
  }

  document.getElementById('teacher-name').textContent = `أ. ${data.name}`;

  document.querySelectorAll('.sidebar button[data-sec]').forEach(button => {
    button.addEventListener('click', () => showSection(button.dataset.sec));
  });

  showSection('classes'); // الافتراضي
});
function showSection(sec) {
  const main = document.getElementById('main-content');

  if (sec === 'classes') {
    main.innerHTML = `
      <h2>📘 إدارة الفصول</h2>
      <div>
        <select id="c-grade">
          <option>الصف الأول</option><option>الصف الثاني</option>
          <option>الصف الثالث</option><option>الصف الرابع</option>
          <option>الصف الخامس</option><option>الصف السادس</option>
        </select>
        <select id="c-system"><option>عربي</option><option>لغات</option></select>
        <select id="c-section"><option>A</option><option>B</option><option>C</option><option>D</option></select>
        <button class="save-btn" onclick="addClass()">إضافة فصل</button>
      </div>
      <h3>📚 فصول المعلم</h3>
      <table id="classes-table">
        <thead><tr><th>الصف</th><th>النظام</th><th>القسم</th><th>إجراء</th></tr></thead>
        <tbody></tbody>
      </table>
    `;
    loadTeacherClasses();
  }

  else if (sec === 'students') {
    main.innerHTML = `
      <h2>👨‍🎓 إضافة طالب جديد</h2>
      <div>
        <select id="s-grade">
          <option>الصف الأول</option><option>الصف الثاني</option>
          <option>الصف الثالث</option><option>الصف الرابع</option>
          <option>الصف الخامس</option><option>الصف السادس</option>
        </select>
        <select id="s-system"><option>عربي</option><option>لغات</option></select>
        <select id="s-section"><option>A</option><option>B</option><option>C</option><option>D</option></select>
        <input type="text" id="s-name" placeholder="اسم الطالب" />
        <select id="s-gender"><option value="male">ذكر</option><option value="female">أنثى</option></select>
        <select id="s-religion"><option value="muslim">مسلم</option><option value="christian">مسيحي</option></select>
        <button class="save-btn" onclick="addStudent()">إضافة الطالب</button>
      </div>
      <h3>📋 طلاب الفصل</h3>
      <table id="students-table">
        <thead><tr><th>الاسم</th><th>النوع</th><th>الديانة</th><th>رقم الجلوس</th></tr></thead>
        <tbody></tbody>
      </table>
    `;
    loadClassDropdowns();
  }
}
async function addClass() {
  const grade = document.getElementById('c-grade').value;
  const system = document.getElementById('c-system').value;
  const section = document.getElementById('c-section').value;

  const existing = await db.collection('classes')
    .where('teacher','==',currentTeacherId)
    .where('grade','==',grade)
    .where('system','==',system)
    .where('section','==',section)
    .get();

  if (!existing.empty) return alert('⚠️ هذا الفصل مضاف مسبقًا');
  await db.collection('classes').add({ grade, system, section, teacher: currentTeacherId });
  alert('✔️ تم إضافة الفصل');
  loadTeacherClasses();
}

async function loadTeacherClasses() {
  const tbody = document.querySelector('#classes-table tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  const snap = await db.collection('classes').where('teacher', '==', currentTeacherId).get();
  snap.forEach(doc => {
    const d = doc.data();
    tbody.innerHTML += `
      <tr>
        <td>${d.grade}</td><td>${d.system}</td><td>${d.section}</td>
        <td><button class="delete-btn" onclick="deleteClass('${doc.id}')">حذف</button></td>
      </tr>`;
  });
}

async function deleteClass(id) {
  await db.collection('classes').doc(id).delete();
  alert('تم حذف الفصل');
  loadTeacherClasses();
}

async function loadClassDropdowns() {
  const grade = document.getElementById('s-grade').value;
  const system = document.getElementById('s-system').value;
  const section = document.getElementById('s-section').value;

  const snap = await db.collection('classes')
    .where('teacher','==',currentTeacherId).get();

  if (!snap.empty) {
    const firstClass = snap.docs[0].data();
    const classId = snap.docs[0].id;
    displayStudents(classId);
  }
}

async function displayStudents(classId) {
  const tbody = document.querySelector('#students-table tbody');
  tbody.innerHTML = '';
  const snap = await db.collection('students')
    .where('classId','==',classId)
    .orderBy('seatNumber').get();

  snap.forEach(doc => {
    const d = doc.data();
    tbody.innerHTML += `
      <tr>
        <td>${d.name}</td>
        <td>${d.gender === 'male' ? 'ذكر' : 'أنثى'}</td>
        <td>${d.religion === 'muslim' ? 'مسلم' : 'مسيحي'}</td>
        <td>${d.seatNumber}</td>
      </tr>`;
  });
}
async function addStudent() {
  const g = document.getElementById('s-grade').value;
  const s = document.getElementById('s-system').value;
  const c = document.getElementById('s-section').value;
  const name = document.getElementById('s-name').value.trim();
  const gender = document.getElementById('s-gender').value;
  const religion = document.getElementById('s-religion').value;

  if (!name || !g || !s || !c || !gender || !religion) {
    return alert("⚠️ يجب ملء جميع الخانات الخاصة بالطالب");
  }

  // البحث عن الفصل
  const classSnap = await db.collection('classes')
    .where('grade','==',g)
    .where('system','==',s)
    .where('section','==',c)
    .where('teacher','==',currentTeacherId).get();

  if (classSnap.empty) return alert('⚠️ الفصل غير موجود');
  const classId = classSnap.docs[0].id;

  // التحقق من الاسم في كل الصفوف
  const nameSnap = await db.collection('students')
    .where('teacher', '==', currentTeacherId)
    .where('name', '==', name)
    .get();

  if (!nameSnap.empty) return alert("⚠️ الاسم موجود بالفعل يرجى التأكد من اسم الطالب");

  // توليد رقم الجلوس
  const seat = await generateSeat(gender, religion, classId);

  // الإضافة
  await db.collection('students').add({
    name, gender, religion,
    seatNumber: seat,
    classId, teacher: currentTeacherId
  });

  alert(`✔️ تم إضافة الطالب ${name} برقم جلوس: ${seat}`);
  displayStudents(classId);
}

async function generateSeat(gender, religion, classId) {
  const snap = await db.collection('students').where('classId','==',classId).get();
  const count = snap.size + 1;
  const codeG = gender === 'male' ? '1' : '2';
  const codeR = religion === 'muslim' ? '1' : '2';
  return codeG + codeR + String(count).padStart(4, '0');
}
async function loadEvalClasses() {
  const sel = document.getElementById('eval-class');
  sel.innerHTML = '';
  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
  snap.forEach(d => {
    const opt = document.createElement('option');
    opt.value = d.id;
    const dd = d.data();
    opt.textContent = `${dd.grade} - ${dd.system} - ${dd.section}`;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', populateStudentSelect);
}

async function populateStudentSelect() {
  const classId = document.getElementById('eval-class').value;
  const sel = document.getElementById('eval-student');
  sel.innerHTML = '';
  const snap = await db.collection('students').where('classId','==',classId).get();
  snap.docs.forEach(doc => {
    const dd = doc.data();
    const opt = document.createElement('option');
    opt.value = doc.id;
    opt.textContent = dd.name;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', () => {
    const name = sel.options[sel.selectedIndex].text;
    document.getElementById('stu-name').textContent = name;
  });
}

async function loadEvalResults() {
  const test = +document.getElementById('input-test').value;
  const home = +document.getElementById('input-home').value;
  const part = +document.getElementById('input-part').value;
  const beh = +document.getElementById('input-beh').value;
  const total = test + home + part + beh;

  let gradeText;
  if (test === 0) gradeText = 'غياب';
  else if (test < 7) gradeText = 'تشجيع من ولي الأمر';
  else if (total === 40) gradeText = 'ممتاز مع الشكر';
  else if (total >= 36) gradeText = 'ممتاز';
  else gradeText = 'نرجو من ولي الأمر متابعة الطالب وتشجيعه';

  const html = `
    <table><thead><tr>
      <th>الاسم</th><th>اختبار</th><th>واجب</th><th>مشاركة</th><th>سلوك</th><th>المجموع</th><th>تقدير</th><th>طباعة</th>
    </tr></thead><tbody>
      <tr>
        <td>${document.getElementById('stu-name').textContent}</td>
        <td>${test === 0 ? '-' : test}</td>
        <td>${test === 0 ? '-' : home}</td>
        <td>${test === 0 ? '-' : part}</td>
        <td>${test === 0 ? '-' : beh}</td>
        <td>${test === 0 ? '-' : total}</td>
        <td>${gradeText}</td>
        <td>${gradeText === 'ممتاز مع الشكر' ? '<button onclick="printPDF()">طباعة شهادة</button>' : ''}</td>
      </tr>
    </tbody></table>`;
  document.getElementById('eval-container').innerHTML = html;
}

function printPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const name = document.getElementById('stu-name').textContent;
  const total = document.querySelector('#eval-container td:nth-child(6)').textContent;

  doc.setFontSize(16);
  doc.text('🎓 شهادة تقدير', 80, 20);
  doc.setFontSize(14);
  doc.text(`الطالب: ${name}`, 20, 40);
  doc.text(`المجموع: ${total} / 40`, 20, 50);
  doc.text('ممتاز مع الشكر والتقدير', 20, 60);
  doc.save('certificate.pdf');
}
</script>
</body>
</html>
