<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8"/>
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>
  <style>
    body { margin:0; font-family:'Segoe UI',sans-serif; background:#f4f6fa; direction:rtl; }
    .main-container { display:flex; min-height:100vh; }
    .sidebar { width:260px; background:#0288d1; color:#fff; padding:30px 20px; text-align:center; }
    .sidebar img { width:100px; margin-bottom:10px; }
    #teacher-name { font-size:22px; margin-bottom:30px; }
    .sidebar button { width:100%; padding:12px; margin:8px 0; background:#fff; color:#0288d1; border:none;border-radius:6px;cursor:pointer; }
    .sidebar button:hover { background:#cbefff; }
    .content { flex:1; padding:40px; font-size:18px; color:#333; }
    select,input,button { width:100%; padding:8px; margin:6px 0; font-size:16px; border:1px solid #ccc; border-radius:4px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; background:#fff; }
    th,td { border:1px solid #ccc; padding:10px; text-align:center; }
    th { background:#eee; }
    .save-btn { background:#0288d1; color:#fff; border:none; padding:8px 16px; font-size:16px; border-radius:5px; cursor:pointer; }
    .grade-absent { background:#f0f0f0; }
    .grade-top { background:#d4edda; }
    .grade-good { background:#cce5ff; }
    .grade-encourage { background:#ffe5b4; }
    .delete-btn { background:#e53935; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer; }
  </style>
</head>
<body>
<div class="main-container">
  <aside class="sidebar">
    <img src="logo.png" alt="Logo">
    <h3 id="teacher-name">ØªØ­Ù…ÙŠÙ„...</h3>
    <button data-sec="classes">ğŸ“˜ Ø§Ù„ÙØµÙˆÙ„</button>
    <button data-sec="students">ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
    <button data-sec="evaluation">ğŸ“ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
    <button onclick="auth.signOut().then(()=>location.href='index.html')">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
  </aside>
  <main class="content"><div id="main-content"></div></main>
</div>

<script>
const auth = firebase.auth();
const db = firebase.firestore();
let currentTeacherId = null;

auth.onAuthStateChanged(async user => {
  if (!user) return location.href = 'index.html';
  
  currentTeacherId = user.uid;
  const doc = await db.collection('users').doc(currentTeacherId).get();
  const data = doc.data();
  if (!data || data.type !== 'teacher') {
    alert('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©');
    return auth.signOut().then(() => location.href = 'index.html');
  }

  document.getElementById('teacher-name').textContent = `Ø£. ${data.name}`;
  document.querySelectorAll('.sidebar button[data-sec]').forEach(b =>
    b.addEventListener('click', () => showSection(b.dataset.sec))
  );
  showSection('classes');
  loadTeacherClasses();
});

function showSection(sec) {
  const main = document.getElementById('main-content');
  if (sec === 'classes') {
    main.innerHTML = `
      <h2>â• Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„</h2>
      <div>
        <select id="c-grade"><option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option></select>
        <select id="c-system"><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option></select>
        <select id="c-section"><option>A</option><option>B</option></select>
        <button class="save-btn" onclick="addClass()">Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</button>
      </div>
      <h3>ğŸ“˜ ÙØµÙˆÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…</h3>
      <table id="classes-table">
        <thead><tr><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ù†Ø¸Ø§Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
        <tbody></tbody>
      </table>`;
    loadTeacherClasses();
  }
  else if (sec === 'students') {
    main.innerHTML = `
      <h2>â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
      <div>
        <select id="s-grade"></select><select id="s-system"></select><select id="s-section"></select>
        <input type="text" id="s-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨"/>
        <select id="s-gender"><option value="male">Ø°ÙƒØ±</option><option value="female">Ø£Ù†Ø«Ù‰</option></select>
        <select id="s-religion"><option value="muslim">Ù…Ø³Ù„Ù…</option><option value="christian">Ù…Ø³ÙŠØ­ÙŠ</option></select>
        <button class="save-btn" onclick="addStudent()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨</button>
      </div>
      <h3>ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„</h3>
      <table id="students-table"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¯ÙŠØ§Ù†Ø©</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</th></tr></thead><tbody></tbody></table>`;
    loadClassDropdowns();
  }
  else if (sec === 'evaluation') {
    main.innerHTML = `
      <h2>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</h2>
      <select id="eval-class"><option>Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</option></select>
      <select id="eval-month"><option value="ÙŠÙ†Ø§ÙŠØ±">ÙŠÙ†Ø§ÙŠØ±</option><option value="ÙØ¨Ø±Ø§ÙŠØ±">ÙØ¨Ø±Ø§ÙŠØ±</option><option value="Ù…Ø§ÙŠÙˆ">Ù…Ø§ÙŠÙˆ</option></select>
      <button class="save-btn" onclick="loadEvalResults()">Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
      <div id="eval-container"></div>
      <button id="print-btn" class="save-btn" style="display:none;" onclick="printEval()">Ø·Ø¨Ø§Ø¹Ø© Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ÙØµÙ„</button>`;
    loadEvalClasses();
  }
}

async function addClass() {
  const grade = document.getElementById('c-grade').value;
  const system = document.getElementById('c-system').value;
  const section = document.getElementById('c-section').value;

  const existing = await db.collection('classes')
    .where('teacher','==',currentTeacherId)
    .where('grade','==',grade)
    .where('system','==',system)
    .where('section','==',section)
    .get();

  if (!existing.empty) return alert('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ù…Ø¶Ø§Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹');

  await db.collection('classes').add({ grade, system, section, teacher: currentTeacherId });
  alert('âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØµÙ„');
  loadTeacherClasses();
}

async function loadTeacherClasses() {
  const tbody = document.querySelector('#classes-table tbody');
  if (!tbody) return;
  tbody.innerHTML = '';
  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
  snap.forEach(doc => {
    const d = doc.data();
    tbody.innerHTML += `<tr>
      <td>${d.grade}</td>
      <td>${d.system}</td>
      <td>${d.section}</td>
      <td><button class="delete-btn" onclick="deleteClass('${doc.id}')">Ø­Ø°Ù</button></td>
    </tr>`;
  });
}

async function deleteClass(classId) {
  await db.collection('classes').doc(classId).delete();
  alert('ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØµÙ„');
  loadTeacherClasses();
}

// ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø·Ù„Ø§Ø¨ Ø¯ÙˆÙ† ØªØ¹Ø¯ÙŠÙ„
async function loadClassDropdowns() {
  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
  ['s-grade','s-system','s-section'].forEach(id => document.getElementById(id).innerHTML = '');
  snap.forEach(d => {
    const dd = d.data();
    document.getElementById('s-grade').innerHTML += `<option>${dd.grade}</option>`;
    document.getElementById('s-system').innerHTML += `<option>${dd.system}</option>`;
    document.getElementById('s-section').innerHTML += `<option>${dd.section}</option>`;
  });
}
async function generateSeat(gender, religion, classId) {
  const snap = await db.collection('students').where('classId','==',classId).get();
  const count = snap.size + 1;
  const codeG = gender==='male'? '1':'2';
  const codeR = religion==='muslim'? '1':'2';
  return codeG + codeR + String(count).padStart(4,'0');
}
async function addStudent() {
  const g = document.getElementById('s-grade').value;
  const s = document.getElementById('s-system').value;
  const c = document.getElementById('s-section').value;
  const name = document.getElementById('s-name').value.trim();
  const gender = document.getElementById('s-gender').value;
  const religion = document.getElementById('s-religion').value;
  const snap = await db.collection('classes')
    .where('grade','==',g).where('system','==',s)
    .where('section','==',c).where('teacher','==',currentTeacherId).get();
  if (snap.empty) return alert('âš ï¸ Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
  const classId = snap.docs[0].id;
  const seat = await generateSeat(gender, religion, classId);
  await db.collection('students').add({ name, gender, religion, seatNumber: seat, classId, teacher: currentTeacherId });
  alert(`âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ ${name} Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³: ${seat}`);
  displayStudents(classId);
}
async function displayStudents(classId) {
  const tbody = document.querySelector('#students-table tbody');
  tbody.innerHTML = '';
  const snap = await db.collection('students').where('classId','==',classId).orderBy('seatNumber').get();
  snap.forEach(e => {
    const data = e.data();
    tbody.innerHTML += `<tr>
      <td>${data.name}</td>
      <td>${data.gender==='male'?'Ø°ÙƒØ±':'Ø£Ù†Ø«Ù‰'}</td>
      <td>${data.religion==='muslim'?'Ù…Ø³Ù„Ù…':'Ù…Ø³ÙŠØ­ÙŠ'}</td>
      <td>${data.seatNumber}</td>
    </tr>`;
  });
}
async function loadEvalClasses() {
  const sel = document.getElementById('eval-class');
  sel.innerHTML = '';
  const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
  snap.forEach(d => {
    const o = document.createElement('option');
    o.value = d.id;
    const dd = d.data();
    o.textContent = `${dd.grade} - ${dd.system} - ${dd.section}`;
    sel.appendChild(o);
  });
}
async function loadEvalResults() {
  const cid = document.getElementById('eval-class').value;
  const month = document.getElementById('eval-month').value;
  const snap = await db.collection('evaluations')
    .where('teacher','==',currentTeacherId)
    .where('classId','==',cid)
    .where('month','==',month)
    .orderBy('seatNumber')
    .get();
  const container = document.getElementById('eval-container');
  if (snap.empty) {
    container.innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</p>';
    document.getElementById('print-btn').style.display = 'none';
    return;
  }
  document.getElementById('print-btn').style.display = 'block';
  let html = `<table><thead><tr><th>Ø§Ù„Ø¬Ù„ÙˆØ³</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ø®ØªØ¨Ø§Ø±</th><th>ÙˆØ§Ø¬Ø¨</th><th>Ù…Ø´Ø§Ø±ÙƒØ©</th><th>Ø³Ù„ÙˆÙƒ</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>ØªÙ‚Ø¯ÙŠØ±</th></tr></thead><tbody>`;
  snap.docs.forEach(d => {
    const e = d.data();
    let absentAll = ['test','home','part','beh'].every(f => e[f]===0);
    const display = {};
    ['test','home','part','beh'].forEach(f => display[f] = e[f]===0?'-':e[f]);
    display.total = e.total===0?'-':e.total;
    let gradeText='', cls='';
    if (absentAll) {gradeText='ØºÙŠØ§Ø¨'; cls='grade-absent';}
    else if (e.total===40) {gradeText='Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±'; cls='grade-top';}
    else if (e.total>=36) {gradeText='Ù…Ù…ØªØ§Ø²'; cls='grade-good';}
    else {gradeText='Ù†Ø±Ø¬Ùˆ Ù…Ù† ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø± Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ´Ø¬ÙŠØ¹Ù‡'; cls='grade-encourage';}
    html += `<tr class="${cls}"><td>${e.seatNumber}</td><td>${e.name}</td><td>${display.test}</td><td>${display.home}</td><td>${display.part}</td><td>${display.beh}</td><td>${display.total}</td><td>${gradeText}</td></tr>`;
  });
  html += '</tbody></table>';
  container.innerHTML = html;
}
function printEval() { window.print(); }
</script>
</body>
</html>
