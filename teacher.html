<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¹Ù„Ù…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="firebase-config.js"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{ color-scheme: light; }
    body { margin:0; padding:0; font-family: Arial, sans-serif; background:#f0f2f5; }
    .main-container { display:flex; min-height:100vh; }
    .sidebar { width:230px; background:#add8e6; color:#fff; padding:20px; box-sizing:border-box; }
    .sidebar img { width:100%; margin-bottom:20px; }
    .sidebar h3 { margin:10px 0; font-size:18px; color:#002b36; }
    .sidebar button { display:block; width:100%; padding:10px; margin-bottom:10px; background:#444; border:none; color:#fff; cursor:pointer; text-align:right; border-radius:6px; }
    .content { flex:1; background:#fff; padding:20px; box-sizing:border-box; }
    .save-btn, .delete-btn { padding:8px 12px; margin:5px; cursor:pointer; border-radius:8px; border:1px solid #cfd6e4; background:#f7f9ff; }
    table { width:100%; border-collapse:collapse; margin-top:12px; }
    th,td { border:1px solid #dfe3e7; padding:8px; text-align:center; font-size:14px }
    th { background:#f2f5f7; }
    input, select { padding:10px; border:1px solid #d0d7de; border-radius:8px; font-size:14px }
    .row { display:grid; grid-template-columns: repeat(2, minmax(220px, 1fr)); gap:10px; align-items:center; margin:8px 0; }
    .muted { color:#666; font-size:13px; margin-top:6px; }
    .form-grid{ display:grid; grid-template-columns: 160px 1fr; gap:10px 12px; align-items:center; max-width:720px; }
    .form-grid label{ justify-self:end; color:#222; }
    .form-grid input,.form-grid select{ width:100%; padding:8px; border:1px solid #d0d7de; border-radius:6px; }
    .form-grid .full{ grid-column:1 / -1; }
    .btn-cert{ background:#2e7d32; color:#fff; border:0; border-radius:8px; padding:6px 10px; cursor:pointer; }
    .btn-cert[disabled]{opacity:.35; cursor:not-allowed}
    .card{ background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:16px; max-width:780px }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px }
    .note{ font-size:13px; color:#556; margin-top:6px }
  </style>
</head>
<body>
  <div class="main-container">
    <aside class="sidebar">
      <img src="logo.png" alt="Logo">
      <h3 id="teacher-name">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h3>
      <button data-sec="profile">ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</button>
      <button data-sec="classes">ğŸ“˜ Ø§Ù„ÙØµÙˆÙ„</button>
      <button data-sec="students">ğŸ‘¨â€ğŸ“ Ø§Ù„Ø·Ù„Ø§Ø¨</button>
      <button data-sec="tests">ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>
      <!-- âœ… Ø§Ù„Ø²Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙŠÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯ -->
      <button id="btn-open-evals">ğŸ“„ Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª</button>
      <button onclick="auth.signOut().then(()=>location.href='index.html')">ğŸšª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </aside>

    <main class="content">
      <div id="main-content">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
    </main>
  </div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  /* ===== Ø«ÙˆØ§Ø¨Øª ===== */
  const RUN_WIDTH = 5;
  const GENDER_CODE   = { male: '1', female: '2' };
  const RELIGION_CODE = { muslim: '1', christian: '2' };
  const CERT_PAGE = 'certificate.html';

  window.auth = firebase.auth();
  const db = firebase.firestore();

  /* ===== Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ===== */
  let currentTeacherId = null;
  let currentTeacherName = '';
  let currentTeacherEmail = '';
  let currentTeacherSubject = '';

  auth.onAuthStateChanged(async function(user){
    if (!user) { location.href = 'index.html'; return; }
    currentTeacherId = user.uid;
    currentTeacherEmail = user.email || '';

    const userDoc = await db.collection('users').doc(currentTeacherId).get();
    const data = userDoc.data();
    if (!data || data.type !== 'teacher') {
      alert('âŒ Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„');
      await auth.signOut();
      location.href = 'index.html';
      return;
    }

    currentTeacherName = data.name || '';
    currentTeacherSubject = data.subject || '';
    document.getElementById('teacher-name').textContent = 'Ø£. ' + currentTeacherName;

    // âœ… Ø±Ø¨Ø· Ø²Ø± Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„ÙØªØ­ ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯ ÙˆØªÙ…Ø±ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…
    const openEvalsBtn = document.getElementById('btn-open-evals');
    if (openEvalsBtn) {
      openEvalsBtn.onclick = function(){
        // ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ø®ØªÙŠØ§Ø±ÙŠÙ‹Ø§
        sessionStorage.setItem('teacherId', currentTeacherId);
        sessionStorage.setItem('teacherName', currentTeacherName || '');
        sessionStorage.setItem('teacherSubject', currentTeacherSubject || '');

        const url = 'evaluations.html'
          + '?teacher=' + encodeURIComponent(currentTeacherId)
          + '&tname=' + encodeURIComponent(currentTeacherName || '')
          + '&subject=' + encodeURIComponent(currentTeacherSubject || '');
        window.open(url, '_blank', 'noopener'); // ØªØ¨ÙˆÙŠØ¨ Ø¬Ø¯ÙŠØ¯
      };
    }

    document.querySelectorAll('.sidebar button[data-sec]')
      .forEach(function(btn){ btn.addEventListener('click', function(){ showSection(btn.dataset.sec); }); });

    showSection('profile');
  });

  /* ===== ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ===== */
  function showSection(sec){
    const main = document.getElementById('main-content');
    main.innerHTML = '';

    /* Ø¨ÙŠØ§Ù†Ø§ØªÙŠ */
    if (sec === 'profile') {
      main.innerHTML =
        '<h2>ğŸ‘¤ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…</h2>' +
        '<div class="card">' +
          '<div class="row">' +
            '<label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:</label>' +
            '<input id="p-name" type="text" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ">' +

            '<label>Ø§Ù„Ù…Ø§Ø¯Ø©:</label>' +
            '<input id="p-subject" type="text" placeholder="Ù…Ø«Ø§Ù„: Ø§Ù„ØªØ±Ø¨ÙŠØ© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠØ©">' +

            '<label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:</label>' +
            '<input id="p-phone" type="tel" inputmode="tel" placeholder="01xxxxxxxxx">' +

            '<label>Ø§Ù„Ù†ÙˆØ¹:</label>' +
            '<select id="p-gender"><option value="male">Ø°ÙƒØ±</option><option value="female">Ø£Ù†Ø«Ù‰</option></select>' +

            '<label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:</label>' +
            '<input id="p-email" type="email" disabled>' +
          '</div>' +
          '<div class="actions">' +
            '<button id="btn-save-profile" class="save-btn">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>' +
            '<button id="btn-reset-pass" class="save-btn">ğŸ”’ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>' +
          '</div>' +
          '<div class="note">ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù… Ø£Ø¹Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸.</div>' +
        '</div>';
      requestAnimationFrame(function(){
        loadProfileForm();
        document.getElementById('btn-save-profile').addEventListener('click', saveProfileForm);
        document.getElementById('btn-reset-pass').addEventListener('click', sendResetEmail);
      });
      return;
    }

    /* Ø§Ù„ÙØµÙˆÙ„ */
    if (sec === 'classes') {
      main.innerHTML =
        '<h2>ğŸ“˜ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØµÙˆÙ„</h2>' +
        '<div class="row">' +
          '<select id="c-grade">' +
            '<option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>' +
            '<option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>' +
          '</select>' +
          '<select id="c-system"><option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option></select>' +
          '<select id="c-section"><option>A</option><option>B</option><option>C</option><option>D</option></select>' +
          '<button class="save-btn" id="btn-add-class">Ø¥Ø¶Ø§ÙØ© ÙØµÙ„</button>' +
        '</div>' +
        '<table id="classes-table">' +
          '<thead><tr><th>Ø§Ù„ØµÙ</th><th>Ø§Ù„Ù†Ø¸Ø§Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>' +
          '<tbody></tbody>' +
        '</table>';
      requestAnimationFrame(function(){
        document.getElementById('btn-add-class').addEventListener('click', addClass);
        loadTeacherClasses();
      });
      return;
    }

    /* Ø§Ù„Ø·Ù„Ø§Ø¨ */
    if (sec === 'students') {
      main.innerHTML =
        '<h2>ğŸ‘¨â€ğŸ“ Ø¥Ø¶Ø§ÙØ©/Ø¥Ø¯Ø§Ø±Ø© Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„</h2>' +
        '<div class="row">' +
          '<select id="s-grade"></select>' +
          '<select id="s-system"></select>' +
          '<select id="s-section"></select>' +
          '<input id="s-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨">' +
          '<select id="s-gender"><option value="male">Ø°ÙƒØ±</option><option value="female">Ø£Ù†Ø«Ù‰</option></select>' +
          '<select id="s-religion"><option value="muslim">Ù…Ø³Ù„Ù…</option><option value="christian">Ù…Ø³ÙŠØ­ÙŠ</option></select>' +

          '<button class="save-btn" id="btn-add-student">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨</button>' +
          '<button class="save-btn" id="btn-load-students">Ø¹Ø±Ø¶ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„</button>' +

          '<button class="save-btn" id="btn-import-excel">â¬†ï¸ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¥ÙƒØ³Ù„</button>' +
          '<button class="save-btn" id="btn-download-template">â¬‡ï¸ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ù„Ø¨</button>' +
          '<input type="file" id="excel-file" accept=".xlsx,.xls,.csv" style="display:none">' +

          '<button class="save-btn" id="btn-export-xlsx">â¬‡ï¸ ØªØµØ¯ÙŠØ± (XLSX) â€” Ø£Ø³Ù…Ø§Ø¡ + Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</button>' +
          '<button class="save-btn" id="btn-export-seats-pdf">ğŸ–¨ï¸ PDF Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</button>' +

          '<input type="search" id="student-search" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..." list="students-list">' +
          '<datalist id="students-list"></datalist>' +
        </div>' +

        '<div class="muted">ØµÙŠØºØ© Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: <b>Ø§Ù„Ø§Ø³Ù… | Ø§Ù„Ø¬Ù†Ø³ | Ø§Ù„Ø¯ÙŠØ§Ù†Ø©</b> (Ø°ÙƒØ±/Ø£Ù†Ø«Ù‰ØŒ Ù…Ø³Ù„Ù…/Ù…Ø³ÙŠØ­ÙŠ).<br>' +
        'Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³ ÙŠÙÙ†Ø´Ø£ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§: [Ø¬Ù†Ø³][Ø¯ÙŠØ§Ù†Ø©][' + RUN_WIDTH + ' Ø®Ø§Ù†Ø§Øª].</div>' +

        '<h3>ğŸ“‹ Ø·Ù„Ø§Ø¨ Ø§Ù„ÙØµÙ„</h3>' +
        '<table id="students-table">' +
          '<thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø§Ù„Ø¯ÙŠØ§Ù†Ø©</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</th></tr></thead>' +
          '<tbody></tbody>' +
        '</table>';
      requestAnimationFrame(function(){
        document.getElementById('btn-add-student').addEventListener('click', addStudent);
        document.getElementById('btn-load-students').addEventListener('click', loadStudentList);
        document.getElementById('btn-import-excel').addEventListener('click', function(){ document.getElementById('excel-file').click(); });
        document.getElementById('excel-file').addEventListener('change', handleExcelFileSelect);
        document.getElementById('btn-download-template').addEventListener('click', downloadExcelTemplate);
        document.getElementById('btn-export-xlsx').addEventListener('click', exportStudentsXLSX);
        document.getElementById('btn-export-seats-pdf').addEventListener('click', downloadSeatsPDF);
        loadClassDropdowns();
      });
      return;
    }

    /* Ø§Ù„ØªÙ‚ÙŠÙŠÙ… */
    if (sec === 'tests') {
      var monthOptions = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±']
        .map(function(m){ return '<option>'+m+'</option>'; }).join('');
      main.innerHTML =
        '<h2>ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</h2>' +
        '<div class="form-grid" id="eval-form">' +
          '<label>Ø§Ù„Ø´Ù‡Ø±:</label>' +
          '<select id="eval-month">' + monthOptions + '</select>' +

          '<label>Ø§Ù„ÙØµÙ„:</label>' +
          '<select id="eval-class"></select>' +

          '<label>Ø§Ù„Ø·Ø§Ù„Ø¨:</label>' +
          '<select id="eval-student"></select>' +

          '<label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</label>' +
          '<div id="stu-name" class="muted" style="text-align:right"></div>' +

          '<label>Ø§Ø®ØªØ¨Ø§Ø± (0-10):</label>' +
          '<input type="number" id="input-test" min="0" max="10">' +

          '<label>ÙˆØ§Ø¬Ø¨ (0-10):</label>' +
          '<input type="number" id="input-home" min="0" max="10">' +

          '<label>Ù…Ø´Ø§Ø±ÙƒØ© (0-10):</label>' +
          '<input type="number" id="input-part" min="0" max="10">' +

          '<label>Ø³Ù„ÙˆÙƒ (0-10):</label>' +
          '<input type="number" id="input-beh" value="10" min="0" max="10">' +

          '<div class="full" style="margin-top:8px">' +
            '<button class="save-btn" id="btn-save-eval" style="width:100%">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</button>' +
          '</div>' +
        '</div>' +

        '<h3 style="margin-top:16px">âœ… ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ù„Ù„ÙØµÙ„/Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†)</h3>' +
        '<table id="eval-summary-table" style="width:100%; margin-top:8px; display:none;">' +
          '<thead><tr>' +
            '<th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ø®ØªØ¨Ø§Ø±</th><th>ÙˆØ§Ø¬Ø¨</th><th>Ù…Ø´Ø§Ø±ÙƒØ©</th>' +
            '<th>Ø³Ù„ÙˆÙƒ</th><th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹</th><th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th><th>Ø´Ù‡Ø§Ø¯Ø©</th>' +
          '</tr></thead><tbody></tbody></table>';
      requestAnimationFrame(function(){
        loadEvalClasses();
        document.getElementById('eval-class').addEventListener('change', async function(){ await loadEvalStudents(); await showEvaluationSummary(); });
        document.getElementById('eval-month').addEventListener('change', showEvaluationSummary);
        document.getElementById('eval-student').addEventListener('change', updateStudentName);
        document.getElementById('btn-save-eval').addEventListener('click', submitEvaluation);
      });
      return;
    }
  }

  /* ===== PROFILE ===== */
  async function loadProfileForm(){
    try{
      const doc = await db.collection('users').doc(currentTeacherId).get();
      const d = doc.data() || {};
      document.getElementById('p-name').value    = d.name || '';
      document.getElementById('p-subject').value = d.subject || '';
      document.getElementById('p-phone').value   = d.phone || '';
      document.getElementById('p-gender').value  = (d.gender==='female'?'female':'male');
      document.getElementById('p-email').value   = currentTeacherEmail || d.email || '';
    }catch(e){ console.error(e); alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.'); }
  }

  async function saveProfileForm(){
    const name    = document.getElementById('p-name').value.trim();
    const subject = document.getElementById('p-subject').value.trim();
    const phone   = document.getElementById('p-phone').value.trim();
    const gender  = document.getElementById('p-gender').value;
    if (!name){ alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù….'); return; }

    try{
      await db.collection('users').doc(currentTeacherId).set({
        name, subject, phone, gender, type:'teacher'
      }, { merge:true });

      currentTeacherName = name;
      currentTeacherSubject = subject;
      document.getElementById('teacher-name').textContent = 'Ø£. ' + currentTeacherName;
      alert('âœ”ï¸ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ');
    }catch(e){ console.error(e); alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸'); }
  }

  async function sendResetEmail(){
    try{
      const email = currentTeacherEmail || document.getElementById('p-email').value;
      if (!email){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„.'); return; }
      await auth.sendPasswordResetEmail(email);
      alert('ğŸ“§ ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø§Ø¨Ø· ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±.');
    }catch(e){ alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: ' + e.message); }
  }

  /* ===== CLASSES ===== */
  async function addClass(){
    const grade = document.getElementById('c-grade').value;
    const system = document.getElementById('c-system').value;
    const section = document.getElementById('c-section').value;

    const existing = await db.collection('classes')
      .where('teacher','==',currentTeacherId)
      .where('grade','==',grade)
      .where('system','==',system)
      .where('section','==',section).get();

    if (!existing.empty) { alert('âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„ Ù…Ø¶Ø§Ù Ù…Ø³Ø¨Ù‚Ø§Ù‹'); return; }
    await db.collection('classes').add({ grade, system, section, teacher: currentTeacherId });
    loadTeacherClasses();
  }

  async function loadTeacherClasses(){
    const tbody = document.querySelector('#classes-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const snap = await db.collection('classes').where('teacher','==',currentTeacherId).get();
    snap.forEach(function(doc){
      const d = doc.data();
      tbody.innerHTML += '<tr><td>'+d.grade+'</td><td>'+d.system+'</td><td>'+d.section+'</td>'+
        '<td><button class="delete-btn" onclick="deleteClass(\''+doc.id+'\')">ğŸ—‘ï¸ Ø­Ø°Ù</button></td></tr>';
    });
  }

  async function deleteClass(classId){
    await db.collection('classes').doc(classId).delete();
    loadTeacherClasses();
  }

  /* ===== SEAT NUMBERS ===== */
  async function ensureStudentsCounterDoc(){
    const ref = db.collection('counters').doc('students');
    const snap = await ref.get();
    if (!snap.exists) await ref.set({ next: 0 }, { merge: true });
    return ref;
  }

  async function allocateRunNumbers(count){
    if (count <= 0) return [];
    const ref = await ensureStudentsCounterDoc();
    const block = await db.runTransaction(async function(tx){
      const snap = await tx.get(ref);
      const data = snap.data() || { next: 0 };
      const start = Number(data.next) || 0;
      const newNext = start + count;
      tx.update(ref, { next: newNext });
      const pad = function(n){ return String(n).padStart(RUN_WIDTH, '0'); };
      const arr = [];
      for (var i=0;i<count;i++){ arr.push(pad(start + i + 1)); }
      return arr;
    });
    return block;
  }

  function buildSeatNumber(gender, religion, runStr){
    const g = GENDER_CODE[gender] || '0';
    const r = RELIGION_CODE[religion] || '0';
    return g + r + runStr;
  }

  /* ===== STUDENTS ===== */
  async function addStudent(){
    const g = document.getElementById('s-grade').value;
    const s = document.getElementById('s-system').value;
    const c = document.getElementById('s-section').value;
    const name = document.getElementById('s-name').value.trim();
    const gender = document.getElementById('s-gender').value;
    const religion = document.getElementById('s-religion').value;

    if (!name||!g||!s||!c||!gender||!religion) { alert('â— ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„'); return; }

    const duplicate = await db.collection('students').where('teacher','==',currentTeacherId).where('name','==',name).get();
    if (!duplicate.empty) { alert('âš ï¸ Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹'); return; }

    const classSnap = await db.collection('classes')
      .where('grade','==',g).where('system','==',s).where('section','==',c).where('teacher','==',currentTeacherId).get();
    if (classSnap.empty) { alert('âš ï¸ Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }

    const classId = classSnap.docs[0].id;
    const block = await allocateRunNumbers(1);
    const seatNumber = buildSeatNumber(gender, religion, block[0]);

    await db.collection('students').add({ name, gender, religion, seatNumber, classId, teacher: currentTeacherId });
    displayStudents(classId);
    alert('âœ”ï¸ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ ÙˆØªØ®ØµÙŠØµ Ø±Ù‚Ù… Ø¬Ù„ÙˆØ³ ÙØ±ÙŠØ¯');
    document.getElementById('s-name').value = '';
  }

  function setDefaultsForSelectors(){
    document.getElementById('s-grade').innerHTML =
      '<option>Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù„Ø«</option>' +
      '<option>Ø§Ù„ØµÙ Ø§Ù„Ø±Ø§Ø¨Ø¹</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø®Ø§Ù…Ø³</option><option>Ø§Ù„ØµÙ Ø§Ù„Ø³Ø§Ø¯Ø³</option>';
    document.getElementById('s-system').innerHTML = '<option>Ø¹Ø±Ø¨ÙŠ</option><option>Ù„ØºØ§Øª</option>';
    document.getElementById('s-section').innerHTML = '<option>A</option><option>B</option><option>C</option><option>D</option>';
  }

  async function loadClassDropdowns(){
    setDefaultsForSelectors();
    const snap = await db.collection('classes').where('teacher','==',currentTeacherId).limit(1).get();
    if (!snap.empty) displayStudents(snap.docs[0].id);
  }

  async function getSelectedClassWithLabel(){
    const g = document.getElementById('s-grade').value;
    const s = document.getElementById('s-system').value;
    const c = document.getElementById('s-section').value;

    const snap = await db.collection('classes')
      .where('grade','==',g).where('system','==',s).where('section','==',c).where('teacher','==',currentTeacherId).get();

    if (snap.empty) return { classId: null, label: g + ' - ' + s + ' - ' + c };

    const doc = snap.docs[0]; const d = doc.data();
    return { classId: doc.id, label: d.grade + ' - ' + d.system + ' - ' + d.section };
  }

  async function loadStudentList(){
    const sel = await getSelectedClassWithLabel();
    if (!sel.classId) { alert('âš ï¸ Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'); return; }
    displayStudents(sel.classId);

    const list = document.getElementById('students-list');
    list.innerHTML = '';
    const studentsSnap = await db.collection('students').where('classId','==',sel.classId).orderBy('seatNumber').get();
    studentsSnap.forEach(function(doc){
      const opt = document.createElement('option');
      opt.value = doc.data().name;
      list.appendChild(opt);
    });
  }

  async function displayStudents(classId){
    const tbody = document.querySelector('#students-table tbody');
    if (!tbody) return;
    tbody.innerHTML = '';
    const snap = await db.collection('students').where('classId','==',classId).orderBy('seatNumber').get();
    snap.forEach(function(doc){
      const d = doc.data();
      tbody.innerHTML += '<tr><td style="text-align:right">'+d.name+'</td><td>'+(d.gender==='male'?'Ø°ÙƒØ±':'Ø£Ù†Ø«Ù‰')+
        '</td><td>'+(d.religion==='muslim'?'Ù…Ø³Ù„Ù…':'Ù…Ø³ÙŠØ­ÙŠ')+'</td><td>'+d.seatNumber+'</td></tr>';
    });
  }

  function readExcelFile(file){
    return new Promise(function(resolve, reject){
      const reader = new FileReader();
      reader.onload = function(evt){
        try{
          const data = new Uint8Array(evt.target.result);
          const wb = XLSX.read(data, { type:'array' });
          const ws = wb.Sheets[wb.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
          resolve(json);
        }catch(e){ reject(e); }
      };
      reader.onerror = reject;
      reader.readAsArrayBuffer(file);
    });
  }

  function downloadExcelTemplate(){
    const headers = ['Ø§Ù„Ø§Ø³Ù…','Ø§Ù„Ø¬Ù†Ø³','Ø§Ù„Ø¯ÙŠØ§Ù†Ø©'];
    const sample  = [['Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯','Ø°ÙƒØ±','Ù…Ø³Ù„Ù…'], ['Ù…Ø±ÙŠÙ… Ø³Ø§Ù…ÙŠ','Ø£Ù†Ø«Ù‰','Ù…Ø³ÙŠØ­ÙŠ']];
    const csv = [headers.join(','), sample[0].join(','), sample[1].join(',')].join('\n');
    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'Ù‚Ø§Ù„Ø¨_Ø§Ù„Ø·Ù„Ø§Ø¨.csv';
    document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  }

  async function handleExcelFileSelect(e){
    const file = e.target.files && e.target.files[0];
    if (!file) return;

    const cls = await getSelectedClassWithLabel();
    if (!cls.classId) { alert('âš ï¸ Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.'); e.target.value=''; return; }

    try{
      const rows = await readExcelFile(file);
      if (!rows.length) { alert('âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµØ§Ù„Ø­Ø© ÙÙŠ Ø§Ù„Ù…Ù„Ù'); e.target.value=''; return; }

      const normalized = []; const errors = [];
      rows.forEach(function(r, idx){
        const name = r['Ø§Ù„Ø§Ø³Ù…'] || r['Name'] || r['name'] || '';
        const genderText = String(r['Ø§Ù„Ø¬Ù†Ø³'] || r['Gender'] || r['gender'] || '').trim();
        const religionText = String(r['Ø§Ù„Ø¯ÙŠØ§Ù†Ø©'] || r['Religion'] || r['religion'] || '').trim();
        if (!name || !genderText || !religionText) { errors.push('Ø§Ù„Ø³Ø·Ø± ' + (idx+2) + ': Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©'); return; }
        const gmap = { 'Ø°ÙƒØ±':'male','Ø£Ù†Ø«Ù‰':'female','male':'male','female':'female','Ø§Ù†Ø«Ù‰':'female' };
        const rmap = { 'Ù…Ø³Ù„Ù…':'muslim','Ù…Ø³ÙŠØ­ÙŠ':'christian','muslim':'muslim','christian':'christian' };
        const gender = gmap[genderText] || null;
        const religion = rmap[religionText] || null;
        if (!gender) errors.push('Ø§Ù„Ø³Ø·Ø± ' + (idx+2) + ': Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ù†Ø³ ØºÙŠØ± ØµØ­ÙŠØ­Ø© ('+genderText+')');
        if (!religion) errors.push('Ø§Ù„Ø³Ø·Ø± ' + (idx+2) + ': Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¯ÙŠØ§Ù†Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø© ('+religionText+')');
        if (gender && religion) normalized.push({ name: String(name).trim(), gender: gender, religion: religion });
      });

      if (errors.length) {
        alert('âš ï¸ Ø£Ø®Ø·Ø§Ø¡ ÙÙŠ Ø§Ù„Ù…Ù„Ù:\n' + errors.join('\n'));
        if (!normalized.length) { e.target.value=''; return; }
      }

      if (!confirm('Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© '+normalized.length+' Ø·Ø§Ù„Ø¨/Ø·Ø§Ù„Ø¨Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙØµÙ„: [ '+cls.label+' ]\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ')) { e.target.value=''; return; }

      const runBlock = await allocateRunNumbers(normalized.length);
      const batch = db.batch();
      normalized.forEach(function(st, i){
        const seatNumber = buildSeatNumber(st.gender, st.religion, runBlock[i]);
        const ref = db.collection('students').doc();
        batch.set(ref, { name: st.name, gender: st.gender, religion: st.religion, seatNumber: seatNumber, classId: cls.classId, teacher: currentTeacherId });
      });

      await batch.commit();
      alert('âœ”ï¸ ØªÙ… Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØªØ®ØµÙŠØµ Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬Ù„ÙˆØ³');
      displayStudents(cls.classId);
      e.target.value = '';
    }catch(err){
      console.error(err);
      alert('â— Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.');
      e.target.value = '';
    }
  }

  /* ===== EXPORTS ===== */
  async function fetchStudentsOfSelectedClass(){
    const sel = await getSelectedClassWithLabel();
    if (!sel.classId) throw new Error('Ø§Ù„ÙØµÙ„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯');
    const snap = await db.collection('students').where('classId','==',sel.classId).orderBy('seatNumber').get();
    const rows = snap.docs.map(function(d){ return Object.assign({ id:d.id }, d.data()); });
    return { classId: sel.classId, label: sel.label, rows: rows };
  }

  async function exportStudentsXLSX(){
    try{
      const out = await fetchStudentsOfSelectedClass();
      if (!out.rows.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„'); return; }
      const headers = ['Ø§Ù„Ø§Ø³Ù…','Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³','Ø§Ù„Ø¬Ù†Ø³','Ø§Ù„Ø¯ÙŠØ§Ù†Ø©','Ø§Ù„ÙØµÙ„'];
      const mapGender = function(g){ return g==='male'?'Ø°ÙƒØ±':'Ø£Ù†Ø«Ù‰'; };
      const mapRel = function(r){ return r==='muslim'?'Ù…Ø³Ù„Ù…':'Ù…Ø³ÙŠØ­ÙŠ'; };
      const g = document.getElementById('s-grade').value;
      const s = document.getElementById('s-system').value;
      const c = document.getElementById('s-section').value;
      const klass = g + ' - ' + s + ' - ' + c;
      const data = out.rows.map(function(r){ return [r.name, r.seatNumber, mapGender(r.gender), mapRel(r.religion), klass]; });
      const ws = XLSX.utils.aoa_to_sheet([headers].concat(data));
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, 'students');
      XLSX.writeFile(wb, 'Ø·Ù„Ø§Ø¨_'+klass.replace(/ /g,'')+'.xlsx', { compression:true });
    }catch(e){ console.error(e); alert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„ØªØµØ¯ÙŠØ±'); }
  }

  async function downloadSeatsPDF(){
    try{
      const out = await fetchStudentsOfSelectedClass();
      if (!out.rows.length){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ÙØµÙ„'); return; }
      const mapGender = function(g){ return g==='male'?'Ø°ÙƒØ±':'Ø£Ù†Ø«Ù‰'; };
      const mapRel = function(r){ return r==='muslim'?'Ù…Ø³Ù„Ù…':'Ù…Ø³ÙŠØ­ÙŠ'; };

      var rowsHtml = out.rows.map(function(r){
        return '<tr><td style="text-align:right">'+r.name+'</td><td>'+r.seatNumber+'</td><td>'+mapGender(r.gender)+'</td><td>'+mapRel(r.religion)+'</td></tr>';
      }).join('');

      var html = '<!DOCTYPE html><html lang="ar" dir="rtl"><head>' +
      '<meta charset="utf-8"><title>Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬Ù„ÙˆØ³ - '+out.label+'</title>' +
      '<style>@page{ size: A4 portrait; margin: 12mm; } body{ font-family: \\"Segoe UI\\", Tahoma, Arial; -webkit-print-color-adjust:exact; print-color-adjust:exact; }' +
      'h2{ text-align:center; margin:0 0 8px; } .muted{ text-align:center; color:#555; margin-bottom:10px }' +
      'table{ width:100%; border-collapse:collapse; font-size:13px } th,td{ border:1px solid #dfe3e7; padding:6px 8px; text-align:center } th{ background:#f2f5f7 }' +
      '.footer{ margin-top:12px; display:flex; justify-content:space-between; font-size:12px; color:#555 }</style></head><body>' +
      '<h2>ÙƒØ´Ù Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</h2><div class="muted">'+out.label+'</div>' +
      '<table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø§Ù„Ø¯ÙŠØ§Ù†Ø©</th></tr></thead><tbody>' +
      rowsHtml + '</tbody></table>' +
      '<div class="footer"><div>Ø§Ù„ØªØ§Ø±ÙŠØ®: '+new Date().toLocaleDateString('ar-EG')+'</div><div>Ø§Ù„Ù…Ø¹Ù„Ù…: Ø£. '+(currentTeacherName||'')+'</div></div>' +
      '<script>setTimeout(function(){window.print()},400);<\/script></body></html>';

      var win = window.open('', '_blank'); win.document.open(); win.document.write(html); win.document.close();
    }catch(e){ console.error(e); alert('ØªØ¹Ø°Ù‘Ø± Ø¥Ù†Ø´Ø§Ø¡ PDF'); }
  }

  /* ===== EVALUATIONS ===== */
  function openCertificateForStudent(studentName){
    const month = document.getElementById('eval-month').value;
    const year  = new Date().getFullYear();
    const classText = document.getElementById('eval-class').selectedOptions[0] ? document.getElementById('eval-class').selectedOptions[0].textContent : '';
    const q = new URLSearchParams({
      name: studentName,
      month: month,
      year: String(year),
      klass: classText,
      teacher: 'Ø£. ' + (currentTeacherName || ''),
      subject: currentTeacherSubject || ''
    });
    const url = CERT_PAGE + '?' + q.toString();
    const win = window.open(url, '_blank', 'noopener');
    if (!win) {
      const a = document.createElement('a'); a.href = url; a.target = '_blank'; a.rel = 'noopener';
      document.body.appendChild(a); a.click(); a.remove();
    }
  }

  async function loadEvalClasses(){
    const sel = document.getElementById('eval-class');
    sel.innerHTML = '';
    const snap = await db.collection('classes').where('teacher', '==', currentTeacherId).get();
    snap.forEach(function(doc){
      const d = doc.data();
      const opt = document.createElement('option');
      opt.value = doc.id; opt.textContent = d.grade + ' - ' + d.system + ' - ' + d.section;
      sel.appendChild(opt);
    });
    if (snap.docs.length) { await loadEvalStudents(); await showEvaluationSummary(); }
  }

  async function loadEvalStudents(){
    const classId = document.getElementById('eval-class').value;
    const sel = document.getElementById('eval-student'); sel.innerHTML = '';
    const snap = await db.collection('students').where('classId', '==', classId).orderBy('seatNumber').get();
    snap.forEach(function(doc){
      const opt = document.createElement('option');
      opt.value = doc.id; opt.textContent = doc.data().name;
      sel.appendChild(opt);
    });
    updateStudentName();
  }

  async function updateStudentName(){
    const studentId = document.getElementById('eval-student').value;
    const span = document.getElementById('stu-name');
    if (!studentId) { span.textContent = ''; return; }
    const doc = await db.collection('students').doc(studentId).get();
    if (doc.exists) span.textContent = doc.data().name;
  }

  async function submitEvaluation(){
    const classId = document.getElementById('eval-class').value;
    const studentId = document.getElementById('eval-student').value;
    const month = document.getElementById('eval-month').value;
    const year = new Date().getFullYear();
    const test = parseInt(document.getElementById('input-test').value,10) || 0;
    const home = parseInt(document.getElementById('input-home').value,10) || 0;
    const part = parseInt(document.getElementById('input-part').value,10) || 0;
    const beh  = parseInt(document.getElementById('input-beh').value,10)  || 0;
    const total = test + home + part + beh;

    if (!studentId || !classId || !month) { alert('âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'); return; }

    const check = await db.collection('evaluations')
      .where('classId','==',classId).where('studentId','==',studentId).where('month','==',month).get();
    if (!check.empty) { alert('âš ï¸ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ ØªÙ‚ÙŠÙŠÙ… Ù„Ù‡Ø°Ø§ Ø§Ù„Ø·Ø§Ù„Ø¨ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± Ø¨Ø§Ù„ÙØ¹Ù„'); return; }

    const studentDoc = await db.collection('students').doc(studentId).get();
    const name = studentDoc.exists ? (studentDoc.data().name || 'Ø·Ø§Ù„Ø¨') : 'Ø·Ø§Ù„Ø¨';

    await db.collection('evaluations').add({
      classId: classId, studentId: studentId, teacher: currentTeacherId,
      name: name, test: test, home: home, part: part, beh: beh, total: total, month: month, year: year
    });

    await showEvaluationSummary();
    alert('âœ”ï¸ ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…');

    if (total === 40) {
      const openIt = confirm('ğŸ‰ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø­ØµÙ„ Ø¹Ù„Ù‰ 40/40 â€” ÙØªØ­ Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠØ±ØŸ');
      if (openIt) openCertificateForStudent(name);
    }
  }

  async function showEvaluationSummary(){
    const classId = document.getElementById('eval-class').value;
    const month = document.getElementById('eval-month').value;
    const table = document.getElementById('eval-summary-table');
    const tbody = table.querySelector('tbody');
    tbody.innerHTML = '';

    if (!classId || !month) { table.style.display = 'none'; return; }

    const snap = await db.collection('evaluations')
      .where('classId','==',classId).where('month','==',month).orderBy('name').get();

    if (snap.empty) { table.style.display = 'none'; return; }

    snap.forEach(function(doc){
      const d = doc.data();
      const totalNum = Number(d.total);
      const testMark = (d.test === 0) ? 'Øº' : d.test;

      var evaluation = '';
      if (d.test === 0) evaluation = 'ØºÙŠØ§Ø¨';
      else if (totalNum === 40) evaluation = 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±';
      else if (totalNum >= 36) evaluation = 'Ù…Ù…ØªØ§Ø²';
      else evaluation = 'ÙŠØ±Ø¬Ù‰ ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ø·ÙÙ„ Ù„Ø±ÙØ¹ Ù…Ø³ØªÙˆØ§Ù‡';

      const certCell = (totalNum === 40)
        ? '<button type="button" class="btn-cert cert-btn" data-name="'+d.name+'">ğŸ† Ø´Ù‡Ø§Ø¯Ø©</button>'
        : 'â€”';

      tbody.innerHTML += '<tr>' +
        '<td style="text-align:right">'+d.name+'</td>' +
        '<td>'+testMark+'</td>' +
        '<td>'+d.home+'</td>' +
        '<td>'+d.part+'</td>' +
        '<td>'+d.beh+'</td>' +
        '<td>'+totalNum+'</td>' +
        '<td>'+evaluation+'</td>' +
        '<td>'+certCell+'</td>' +
      '</tr>';
    });

    table.style.display = '';
    table.querySelector('tbody').onclick = function(e){
      const btn = e.target.closest('.cert-btn');
      if (!btn) return;
      e.preventDefault();
      openCertificateForStudent(btn.dataset.name || '');
    };
  }

  // expose deleteClass
  window.deleteClass = deleteClass;
});
</script>
</body>
</html>
