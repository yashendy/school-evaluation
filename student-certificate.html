<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>شهادة درجات الطالب</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<style>
  /* طباعة A4 بالعرض */
  @page{ size: A4 landscape; margin: 10mm; }
  html,body{ height:100%; }
  body{
    margin:0;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    background:#f2f4f7;
    color:#111;
  }

  .sheet{
    width: 277mm;           /* 297 - هوامش 2x10 */
    min-height: 187mm;      /* 210 - هوامش 2x10 */
    margin: 10mm auto;
    background:#fff;
    box-shadow: 0 8px 24px rgba(0,0,0,.08);
    border-radius: 8px;
    display:flex;
    flex-direction:column;
  }

  .header{
    display:flex;
    align-items:center;
    gap:16px;
    padding:14px 18px;
    border-bottom: 2px solid #e6e9ef;
  }
  .logo{
    width:72px; height:72px; object-fit:contain;
  }
  .title{
    flex:1; text-align:center;
  }
  .title h1{
    margin:0; font-size:28px; letter-spacing:.3px; color:#0d6efd;
  }
  .subtitle{
    text-align:center; margin:2px 0 0; color:#555; font-size:14px;
  }

  .meta{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:8px 12px;
    padding:12px 18px 0;
    font-size:15px;
  }
  .meta b{ color:#222 }

  .content{
    padding:10px 18px 18px;
    flex:1;
    display:flex;
    flex-direction:column;
  }

  table{
    width:100%; border-collapse:collapse; margin-top:10px;
    font-size:15px;
  }
  th,td{
    border:1px solid #e6e9ef; padding:10px; text-align:center;
  }
  th{
    background:#f7f8fb; font-weight:700;
  }
  .muted{ color:#666; }

  .footer{
    margin-top:auto;
    display:flex; justify-content:space-between; align-items:flex-end;
    padding:14px 18px 18px;
    font-size:14px; color:#555;
  }

  .screen-bar{
    position:sticky; top:0; background:#fff; padding:10px 12px; display:flex; gap:8px; justify-content:flex-end;
    border-bottom:1px dashed #e6e9ef; z-index:5;
  }
  .btn{
    padding:8px 14px; border-radius:10px; border:1px solid #cfd6e4; background:#f7f9ff; color:#0d6efd; cursor:pointer;
  }
  .btn.primary{ background:#0d6efd; color:#fff; border-color:#0d6efd; }
  .hide-print{ display:block; }
  @media print{
    body{ background:#fff; }
    .sheet{ margin:0; width:auto; min-height:auto; box-shadow:none; border-radius:0; }
    .hide-print{ display:none !important; }
  }
</style>
</head>
<body>

  <!-- أزرار على الشاشة فقط -->
  <div class="screen-bar hide-print">
    <button class="btn" onclick="history.back()">رجوع</button>
    <button class="btn primary" onclick="window.print()">🖨️ طباعة</button>
  </div>

  <div class="sheet" id="sheet">
    <!-- رأس الشهادة -->
    <div class="header">
      <img class="logo" src="logo.png" alt="Logo" onerror="this.style.visibility='hidden'">
      <div class="title">
        <h1>معهد الدراسات الإدارية والفنية</h1>
        <div class="subtitle">شهادة درجات شهرية للطالب</div>
      </div>
      <!-- مساحة يمين للروازنة (فارغة) -->
      <div style="width:72px"></div>
    </div>

    <!-- بيانات أساسية -->
    <div class="meta">
      <div><b>اسم الطالب:</b> <span id="st-name">—</span></div>
      <div><b>رقم الجلوس:</b> <span id="st-seat">—</span></div>
      <div><b>الفصل:</b> <span id="st-class">—</span></div>
      <div><b>الشهر/العام:</b> <span id="st-when">—</span></div>
    </div>

    <div class="content">
      <!-- جدول الدرجات -->
      <table id="grades">
        <thead>
          <tr>
            <th>المادة</th>
            <th>اختبار (10)</th>
            <th>واجب (10)</th>
            <th>مشاركة (10)</th>
            <th>سلوك (10)</th>
            <th>المجموع (40)</th>
            <th>التقدير</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="no-data" class="muted" style="text-align:center; padding:12px; display:none">
        لا توجد درجات لهذا الشهر.
      </div>
    </div>

    <div class="footer">
      <div>تاريخ الطباعة: <span id="print-date"></span></div>
      <div class="muted">—</div>
    </div>
  </div>

<script>
  const db = firebase.firestore();
  const MONTHS = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];

  const teacherCache = new Map();
  async function getTeacherMeta(id){
    if (!id) return {subject:'—', name:'—'};
    if (teacherCache.has(id)) return teacherCache.get(id);
    const d = await db.collection('users').doc(id).get();
    const meta = d.exists ? {subject: d.data().subject || '—', name: d.data().name || '—'} : {subject:'—', name:'—'};
    teacherCache.set(id, meta);
    return meta;
  }

  function getParam(k){ return new URLSearchParams(location.search).get(k); }

  function evalLabel(total, test){
    const t = Number(total)||0;
    if (test === 0) return 'غياب';
    if (t === 40) return 'ممتاز مع الشكر';
    if (t >= 36) return 'ممتاز';
    return 'يرجى تشجيع الطالب';
  }

  async function loadCertificate(){
    const seat = (getParam('seat') || '').trim();
    const month = (getParam('month') || '').trim();
    const year = Number(getParam('year')) || new Date().getFullYear();

    if (!seat || !month || !MONTHS.includes(month)){
      alert('البيانات ناقصة في الرابط. احرصي على تمرير seat و month و year.');
      return;
    }

    // الطالب
    const stQ = await db.collection('students').where('seatNumber','==', seat).limit(1).get();
    if (stQ.empty){ alert('رقم الجلوس غير صحيح.'); return; }
    const stDoc = stQ.docs[0];
    const st = stDoc.data();

    // الفصل
    let klass = '—';
    if (st.classId){
      const c = await db.collection('classes').doc(st.classId).get();
      if (c.exists){
        const d = c.data();
        klass = `${d.grade} - ${d.system} - ${d.section}`;
      }
    }

    // هات تقييمات هذا الشهر/العام
    const evQ = await db.collection('evaluations')
      .where('studentId','==', stDoc.id)
      .where('month','==', month)
      .where('year','==', year)
      .get();

    const tbody = document.querySelector('#grades tbody');
    tbody.innerHTML = '';

    if (evQ.empty){
      document.getElementById('no-data').style.display = 'block';
    }else{
      document.getElementById('no-data').style.display = 'none';

      // جهّزي الصفوف (المادة من حساب المعلّم)
      const rows = [];
      for (const d of evQ.docs){
        const e = d.data();
        const meta = await getTeacherMeta(e.teacher);
        rows.push({
          subject: meta.subject || '—',
          test: Number(e.test)||0,
          home: Number(e.home)||0,
          part: Number(e.part)||0,
          beh : Number(e.beh)||0,
          total: Number(e.total)||0,
          eval: evalLabel(e.total, e.test)
        });
      }

      // رتّب حسب اسم المادة
      rows.sort((a,b)=> (a.subject||'').localeCompare(b.subject||'', 'ar'));

      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:right">${r.subject}</td>
          <td>${r.test===0?'غ':r.test}</td>
          <td>${r.home}</td>
          <td>${r.part}</td>
          <td>${r.beh}</td>
          <td>${r.total}</td>
          <td>${r.eval}</td>`;
        tbody.appendChild(tr);
      });
    }

    // عبّي الرأس
    document.getElementById('st-name').textContent  = st.name || '—';
    document.getElementById('st-seat').textContent  = st.seatNumber || seat;
    document.getElementById('st-class').textContent = klass;
    document.getElementById('st-when').textContent  = `${month} / ${year}`;

    // تاريخ الطباعة
    const now = new Date();
    const dd = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
    document.getElementById('print-date').textContent = dd;

    // اطبع تلقائيًا بعد اكتمال البناء (لو فتحنا من زر طباعة)
    setTimeout(()=>window.print(), 400);
  }

  window.addEventListener('load', loadCertificate);
</script>
</body>
</html>
