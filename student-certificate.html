<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>Ø´Ù‡Ø§Ø¯Ø© Ø¯Ø±Ø¬Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<style>
  /* Ø·Ø¨Ø§Ø¹Ø© A4 Ø¨Ø§Ù„Ø¹Ø±Ø¶ */
  @page{ size: A4 landscape; margin: 10mm; }
  html,body{ height:100%; }
  body{
    margin:0;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    background:#f2f4f7;
    color:#111;
  }

  .sheet{
    width: 277mm;           /* 297 - Ù‡ÙˆØ§Ù…Ø´ 2x10 */
    min-height: 187mm;      /* 210 - Ù‡ÙˆØ§Ù…Ø´ 2x10 */
    margin: 10mm auto;
    background:#fff;
    box-shadow: 0 8px 24px rgba(0,0,0,.08);
    border-radius: 8px;
    display:flex;
    flex-direction:column;
  }

  .header{
    display:flex;
    align-items:center;
    gap:16px;
    padding:14px 18px;
    border-bottom: 2px solid #e6e9ef;
  }
  .logo{
    width:72px; height:72px; object-fit:contain;
  }
  .title{
    flex:1; text-align:center;
  }
  .title h1{
    margin:0; font-size:28px; letter-spacing:.3px; color:#0d6efd;
  }
  .subtitle{
    text-align:center; margin:2px 0 0; color:#555; font-size:14px;
  }

  .meta{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:8px 12px;
    padding:12px 18px 0;
    font-size:15px;
  }
  .meta b{ color:#222 }

  .content{
    padding:10px 18px 18px;
    flex:1;
    display:flex;
    flex-direction:column;
  }

  table{
    width:100%; border-collapse:collapse; margin-top:10px;
    font-size:15px;
  }
  th,td{
    border:1px solid #e6e9ef; padding:10px; text-align:center;
  }
  th{
    background:#f7f8fb; font-weight:700;
  }
  .muted{ color:#666; }

  .footer{
    margin-top:auto;
    display:flex; justify-content:space-between; align-items:flex-end;
    padding:14px 18px 18px;
    font-size:14px; color:#555;
  }

  .screen-bar{
    position:sticky; top:0; background:#fff; padding:10px 12px; display:flex; gap:8px; justify-content:flex-end;
    border-bottom:1px dashed #e6e9ef; z-index:5;
  }
  .btn{
    padding:8px 14px; border-radius:10px; border:1px solid #cfd6e4; background:#f7f9ff; color:#0d6efd; cursor:pointer;
  }
  .btn.primary{ background:#0d6efd; color:#fff; border-color:#0d6efd; }
  .hide-print{ display:block; }
  @media print{
    body{ background:#fff; }
    .sheet{ margin:0; width:auto; min-height:auto; box-shadow:none; border-radius:0; }
    .hide-print{ display:none !important; }
  }
</style>
</head>
<body>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø© ÙÙ‚Ø· -->
  <div class="screen-bar hide-print">
    <button class="btn" onclick="history.back()">Ø±Ø¬ÙˆØ¹</button>
    <button class="btn primary" onclick="window.print()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
  </div>

  <div class="sheet" id="sheet">
    <!-- Ø±Ø£Ø³ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© -->
    <div class="header">
      <img class="logo" src="logo.png" alt="Logo" onerror="this.style.visibility='hidden'">
      <div class="title">
        <h1>Ù…Ø¹Ù‡Ø¯ Ø§Ù„Ø¯Ø±Ø§Ø³Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙˆØ§Ù„ÙÙ†ÙŠØ©</h1>
        <div class="subtitle">Ø´Ù‡Ø§Ø¯Ø© Ø¯Ø±Ø¬Ø§Øª Ø´Ù‡Ø±ÙŠØ© Ù„Ù„Ø·Ø§Ù„Ø¨</div>
      </div>
      <!-- Ù…Ø³Ø§Ø­Ø© ÙŠÙ…ÙŠÙ† Ù„Ù„Ø±ÙˆØ§Ø²Ù†Ø© (ÙØ§Ø±ØºØ©) -->
      <div style="width:72px"></div>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ© -->
    <div class="meta">
      <div><b>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</b> <span id="st-name">â€”</span></div>
      <div><b>Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³:</b> <span id="st-seat">â€”</span></div>
      <div><b>Ø§Ù„ÙØµÙ„:</b> <span id="st-class">â€”</span></div>
      <div><b>Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ø¹Ø§Ù…:</b> <span id="st-when">â€”</span></div>
    </div>

    <div class="content">
      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª -->
      <table id="grades">
        <thead>
          <tr>
            <th>Ø§Ù„Ù…Ø§Ø¯Ø©</th>
            <th>Ø§Ø®ØªØ¨Ø§Ø± (10)</th>
            <th>ÙˆØ§Ø¬Ø¨ (10)</th>
            <th>Ù…Ø´Ø§Ø±ÙƒØ© (10)</th>
            <th>Ø³Ù„ÙˆÙƒ (10)</th>
            <th>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (40)</th>
            <th>Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="no-data" class="muted" style="text-align:center; padding:12px; display:none">
        Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±Ø¬Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.
      </div>
    </div>

    <div class="footer">
      <div>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: <span id="print-date"></span></div>
      <div class="muted">â€”</div>
    </div>
  </div>

<script>
  const db = firebase.firestore();
  const MONTHS = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];

  const teacherCache = new Map();
  async function getTeacherMeta(id){
    if (!id) return {subject:'â€”', name:'â€”'};
    if (teacherCache.has(id)) return teacherCache.get(id);
    const d = await db.collection('users').doc(id).get();
    const meta = d.exists ? {subject: d.data().subject || 'â€”', name: d.data().name || 'â€”'} : {subject:'â€”', name:'â€”'};
    teacherCache.set(id, meta);
    return meta;
  }

  function getParam(k){ return new URLSearchParams(location.search).get(k); }

  function evalLabel(total, test){
    const t = Number(total)||0;
    if (test === 0) return 'ØºÙŠØ§Ø¨';
    if (t === 40) return 'Ù…Ù…ØªØ§Ø² Ù…Ø¹ Ø§Ù„Ø´ÙƒØ±';
    if (t >= 36) return 'Ù…Ù…ØªØ§Ø²';
    return 'ÙŠØ±Ø¬Ù‰ ØªØ´Ø¬ÙŠØ¹ Ø§Ù„Ø·Ø§Ù„Ø¨';
  }

  async function loadCertificate(){
    const seat = (getParam('seat') || '').trim();
    const month = (getParam('month') || '').trim();
    const year = Number(getParam('year')) || new Date().getFullYear();

    if (!seat || !month || !MONTHS.includes(month)){
      alert('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ© ÙÙŠ Ø§Ù„Ø±Ø§Ø¨Ø·. Ø§Ø­Ø±ØµÙŠ Ø¹Ù„Ù‰ ØªÙ…Ø±ÙŠØ± seat Ùˆ month Ùˆ year.');
      return;
    }

    // Ø§Ù„Ø·Ø§Ù„Ø¨
    const stQ = await db.collection('students').where('seatNumber','==', seat).limit(1).get();
    if (stQ.empty){ alert('Ø±Ù‚Ù… Ø§Ù„Ø¬Ù„ÙˆØ³ ØºÙŠØ± ØµØ­ÙŠØ­.'); return; }
    const stDoc = stQ.docs[0];
    const st = stDoc.data();

    // Ø§Ù„ÙØµÙ„
    let klass = 'â€”';
    if (st.classId){
      const c = await db.collection('classes').doc(st.classId).get();
      if (c.exists){
        const d = c.data();
        klass = `${d.grade} - ${d.system} - ${d.section}`;
      }
    }

    // Ù‡Ø§Øª ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ø¹Ø§Ù…
    const evQ = await db.collection('evaluations')
      .where('studentId','==', stDoc.id)
      .where('month','==', month)
      .where('year','==', year)
      .get();

    const tbody = document.querySelector('#grades tbody');
    tbody.innerHTML = '';

    if (evQ.empty){
      document.getElementById('no-data').style.display = 'block';
    }else{
      document.getElementById('no-data').style.display = 'none';

      // Ø¬Ù‡Ù‘Ø²ÙŠ Ø§Ù„ØµÙÙˆÙ (Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ù† Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…)
      const rows = [];
      for (const d of evQ.docs){
        const e = d.data();
        const meta = await getTeacherMeta(e.teacher);
        rows.push({
          subject: meta.subject || 'â€”',
          test: Number(e.test)||0,
          home: Number(e.home)||0,
          part: Number(e.part)||0,
          beh : Number(e.beh)||0,
          total: Number(e.total)||0,
          eval: evalLabel(e.total, e.test)
        });
      }

      // Ø±ØªÙ‘Ø¨ Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©
      rows.sort((a,b)=> (a.subject||'').localeCompare(b.subject||'', 'ar'));

      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:right">${r.subject}</td>
          <td>${r.test===0?'Øº':r.test}</td>
          <td>${r.home}</td>
          <td>${r.part}</td>
          <td>${r.beh}</td>
          <td>${r.total}</td>
          <td>${r.eval}</td>`;
        tbody.appendChild(tr);
      });
    }

    // Ø¹Ø¨Ù‘ÙŠ Ø§Ù„Ø±Ø£Ø³
    document.getElementById('st-name').textContent  = st.name || 'â€”';
    document.getElementById('st-seat').textContent  = st.seatNumber || seat;
    document.getElementById('st-class').textContent = klass;
    document.getElementById('st-when').textContent  = `${month} / ${year}`;

    // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
    const now = new Date();
    const dd = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
    document.getElementById('print-date').textContent = dd;

    // Ø§Ø·Ø¨Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø¹Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ (Ù„Ùˆ ÙØªØ­Ù†Ø§ Ù…Ù† Ø²Ø± Ø·Ø¨Ø§Ø¹Ø©)
    setTimeout(()=>window.print(), 400);
  }

  window.addEventListener('load', loadCertificate);
</script>
</body>
</html>
