<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<title>شهادة درجات الطالب</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="firebase-config.js"></script>

<!-- QR Code -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
  /* A4 Landscape */
  @page{ size: A4 landscape; margin: 10mm; }
  html,body{ height:100%; }
  body{
    margin:0;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
    font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    background:#f2f4f7;
    color:#111;
  }

  .sheet{
    width: 277mm;           /* 297 - 2*10mm */
    min-height: 187mm;      /* 210 - 2*10mm */
    margin: 10mm auto;
    background:#fff;
    box-shadow: 0 8px 24px rgba(0,0,0,.08);
    border-radius: 12px;
    position:relative;
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }

  /* إطار زخرفي (ظاهر على الشاشة والطباعة) */
  .frame-outer{
    position:absolute; inset:5mm;
    border-radius: 12px;
    background:
      radial-gradient(circle at 12px 12px, #d4af37 0 6px, transparent 7px) top right,
      radial-gradient(circle at calc(100% - 12px) 12px, #d4af37 0 6px, transparent 7px) top left,
      radial-gradient(circle at 12px calc(100% - 12px), #d4af37 0 6px, transparent 7px) bottom right,
      radial-gradient(circle at calc(100% - 12px) calc(100% - 12px), #d4af37 0 6px, transparent 7px) bottom left;
    background-size: 48px 48px;
    background-repeat: no-repeat;
    pointer-events:none;
    border: 3px solid #d4af37;
  }
  .frame-inner{
    position:absolute; inset:9mm;
    border: 2px dashed rgba(212,175,55,.55);
    border-radius: 10px;
    pointer-events:none;
  }

  .header{
    display:grid; grid-template-columns: 120px 1fr 120px;
    align-items:center;
    padding:16px 20px 8px;
  }

  /* QR على الشمال */
  .qr-box{
    justify-self:start; /* RTL: يسار */
    width:110px; height:110px;
    display:flex; align-items:center; justify-content:center;
    border:1px solid #e6e9ef; border-radius:8px;
    background:#fafbfe;
  }
  #qrcode{ width:98px; height:98px; }

  /* عنوان المعهد */
  .title{
    text-align:center;
  }
  .title h1{
    margin:0; font-size:30px; letter-spacing:.3px; color:#0d6efd; font-weight:800;
  }
  .subtitle{
    text-align:center; margin:2px 0 0; color:#555; font-size:14px;
  }

  .right-pad{ width:120px; height:110px; }

  .meta{
    display:grid;
    grid-template-columns: repeat(4, 1fr);
    gap:8px 12px;
    padding:6px 22px 0;
    font-size:15px;
  }
  .meta b{ color:#222 }

  .content{
    padding:8px 20px 14px;
    flex:1; display:flex; flex-direction:column;
  }

  table{
    width:100%; border-collapse:collapse; margin-top:8px;
    font-size:15px;
  }
  th,td{
    border:1px solid #e6e9ef; padding:10px; text-align:center;
  }
  th{
    background:linear-gradient(#f9fbff,#f2f5fa);
    font-weight:700;
  }
  .muted{ color:#666; }

  /* تذييل التوقيعات */
  .footer-sign{
    margin-top:auto;
    display:flex; justify-content:space-between; align-items:flex-end;
    padding:10px 28px 18px;
    gap:20px;
    direction: rtl;
  }
  .sig-box{
    width:40%;
    text-align:center;
  }
  .sig-line{
    height:50px;
    border-bottom:1.8px solid #b9c2d0;
    margin:0 16px 6px;
  }
  .sig-label{
    font-size:15px; color:#333; font-weight:700;
  }

  /* شريط أدوات الشاشة فقط */
  .screen-bar{
    position:sticky; top:0; background:#fff; padding:10px 12px; display:flex; gap:8px; justify-content:flex-end;
    border-bottom:1px dashed #e6e9ef; z-index:5;
  }
  .btn{
    padding:8px 14px; border-radius:10px; border:1px solid #cfd6e4; background:#f7f9ff; color:#0d6efd; cursor:pointer;
  }
  .btn.primary{ background:#0d6efd; color:#fff; border-color:#0d6efd; }

  @media print{
    body{ background:#fff; }
    .sheet{ margin:0; width:auto; min-height:auto; box-shadow:none; border-radius:0; }
  }
</style>
</head>
<body>

  <!-- أزرار شاشة -->
  <div class="screen-bar">
    <button class="btn" onclick="history.back()">رجوع</button>
    <button class="btn primary" onclick="window.print()">🖨️ طباعة</button>
  </div>

  <div class="sheet" id="sheet">
    <!-- الإطار الزخرفي -->
    <div class="frame-outer"></div>
    <div class="frame-inner"></div>

    <!-- رأس الشهادة -->
    <div class="header">
      <!-- الشمال: QR برابط الطالب -->
      <div class="qr-box"><div id="qrcode"></div></div>

      <!-- المنتصف: عنوان المعهد -->
      <div class="title">
        <h1>معهد الدراسات الإدارية والفنية</h1>
        <div class="subtitle">شهادة درجات شهرية للطالب</div>
      </div>

      <!-- يمين: مساحة للموازنة -->
      <div class="right-pad"></div>
    </div>

    <!-- بيانات أساسية -->
    <div class="meta">
      <div><b>اسم الطالب:</b> <span id="st-name">—</span></div>
      <div><b>رقم الجلوس:</b> <span id="st-seat">—</span></div>
      <div><b>الفصل:</b> <span id="st-class">—</span></div>
      <div><b>الشهر/العام:</b> <span id="st-when">—</span></div>
    </div>

    <!-- جدول الدرجات -->
    <div class="content">
      <table id="grades">
        <thead>
          <tr>
            <th>المادة</th>
            <th>اختبار (10)</th>
            <th>واجب (10)</th>
            <th>مشاركة (10)</th>
            <th>سلوك (10)</th>
            <th>المجموع (40)</th>
            <th>التقدير</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div id="no-data" class="muted" style="text-align:center; padding:12px; display:none">
        لا توجد درجات لهذا الشهر.
      </div>
    </div>

    <!-- تذييل التوقيعات -->
    <div class="footer-sign">
      <!-- يمين: توقيع ولي الأمر -->
      <div class="sig-box">
        <div class="sig-line"></div>
        <div class="sig-label">توقيع ولي الأمر</div>
      </div>

      <!-- شمال: الإدارة -->
      <div class="sig-box">
        <div class="sig-line"></div>
        <div class="sig-label">الإدارة</div>
      </div>
    </div>
  </div>

<script>
  const db = firebase.firestore();
  const MONTHS = ["يناير","فبراير","مارس","أبريل","مايو","يونيو","يوليو","أغسطس","سبتمبر","أكتوبر","نوفمبر","ديسمبر"];
  const teacherCache = new Map();

  function getParam(k){ return new URLSearchParams(location.search).get(k); }

  async function getTeacherMeta(id){
    if (!id) return {subject:'—', name:'—'};
    if (teacherCache.has(id)) return teacherCache.get(id);
    const d = await db.collection('users').doc(id).get();
    const meta = d.exists ? {subject: d.data().subject || '—', name: d.data().name || '—'} : {subject:'—', name:'—'};
    teacherCache.set(id, meta);
    return meta;
  }

  function evalLabel(total, test){
    const t = Number(total)||0;
    if (test === 0) return 'غياب';
    if (t === 40) return 'ممتاز مع الشكر';
    if (t >= 36) return 'ممتاز';
    return 'يرجى تشجيع الطالب';
  }

  function makeQR(text){
    const el = document.getElementById('qrcode');
    el.innerHTML = '';
    new QRCode(el, {
      text: String(text || ''),
      width: 256,
      height: 256,
      correctLevel: QRCode.CorrectLevel.M
    });
  }

  async function loadCertificate(){
    const seat  = (getParam('seat')  || '').trim();
    const month = (getParam('month') || '').trim();
    const year  = Number(getParam('year')) || new Date().getFullYear();

    if (!seat || !month || !MONTHS.includes(month)){
      alert('البيانات ناقصة في الرابط. احرصي على تمرير seat و month (اسم الشهر بالعربي) و year.');
      return;
    }

    // الطالب
    const stQ = await db.collection('students').where('seatNumber','==', seat).limit(1).get();
    if (stQ.empty){ alert('رقم الجلوس غير صحيح.'); return; }
    const stDoc = stQ.docs[0];
    const st = stDoc.data();

    // الفصل
    let klass = '—';
    if (st.classId){
      const c = await db.collection('classes').doc(st.classId).get();
      if (c.exists){
        const d = c.data();
        klass = `${d.grade} - ${d.system} - ${d.section}`;
      }
    }

    // تقييمات الشهر/العام
    const evQ = await db.collection('evaluations')
      .where('studentId','==', stDoc.id)
      .where('month','==', month)
      .where('year','==', year)
      .get();

    const tbody = document.querySelector('#grades tbody');
    tbody.innerHTML = '';

    if (evQ.empty){
      document.getElementById('no-data').style.display = 'block';
    } else {
      document.getElementById('no-data').style.display = 'none';

      const rows = [];
      for (const d of evQ.docs){
        const e = d.data();
        const meta = await getTeacherMeta(e.teacher);
        rows.push({
          subject: meta.subject || '—',
          test: Number(e.test)||0,
          home: Number(e.home)||0,
          part: Number(e.part)||0,
          beh : Number(e.beh)||0,
          total: Number(e.total)||0,
          eval : evalLabel(e.total, e.test)
        });
      }

      // رتب حسب المادة
      rows.sort((a,b)=> (a.subject||'').localeCompare(b.subject||'', 'ar'));

      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:right">${r.subject}</td>
          <td>${r.test===0?'غ':r.test}</td>
          <td>${r.home}</td>
          <td>${r.part}</td>
          <td>${r.beh}</td>
          <td>${r.total}</td>
          <td>${r.eval}</td>`;
        tbody.appendChild(tr);
      });
    }

    // رأس البيانات
    document.getElementById('st-name').textContent  = st.name || '—';
    document.getElementById('st-seat').textContent  = st.seatNumber || seat;
    document.getElementById('st-class').textContent = klass;
    document.getElementById('st-when').textContent  = `${month} / ${year}`;

    // QR برابط الطالب مباشرة
    const studentLink = `${location.origin}/student.html?seat=${encodeURIComponent(seat)}`;
    makeQR(studentLink);

    // (اختياري) طباعة تلقائية
    // setTimeout(()=>window.print(), 500);
  }

  window.addEventListener('load', loadCertificate);
</script>
</body>
</html>
